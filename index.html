<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css">
  <script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="零壹">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="零壹">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="shankai">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>零壹</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">零壹</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">万物虚无</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">54</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">117</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">18</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/20/kong-api-gateway-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="shankai">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="零壹">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/20/kong-api-gateway-notes/" class="post-title-link" itemprop="url">Kong Notes</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-20 21:00:00" itemprop="dateCreated datePublished" datetime="2021-08-20T21:00:00+08:00">2021-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-26 14:19:37" itemprop="dateModified" datetime="2021-11-26T14:19:37+08:00">2021-11-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/API/" itemprop="url" rel="index"><span itemprop="name">API</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h2><pre class="mermaid">graph RL
    REST --> Konga
    subgraph Kong
      REST(Admin REST API)
      OIDC(Plugin: kong-oidc) 
    end
    Keycloak --> OIDC</pre>

<h2 id="Install-Without-DB"><a href="#Install-Without-DB" class="headerlink" title="Install Without DB"></a>Install Without DB</h2><h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name kong \</span><br><span class="line">    -e &quot;KONG_DATABASE&#x3D;off&quot; \</span><br><span class="line">    -e &quot;KONG_PROXY_ACCESS_LOG&#x3D;&#x2F;dev&#x2F;stdout&quot; \</span><br><span class="line">    -e &quot;KONG_ADMIN_ACCESS_LOG&#x3D;&#x2F;dev&#x2F;stdout&quot; \</span><br><span class="line">    -e &quot;KONG_PROXY_ERROR_LOG&#x3D;&#x2F;dev&#x2F;stderr&quot; \</span><br><span class="line">    -e &quot;KONG_ADMIN_ERROR_LOG&#x3D;&#x2F;dev&#x2F;stderr&quot; \</span><br><span class="line">    -e &quot;KONG_ADMIN_LISTEN&#x3D;0.0.0.0:8001, 0.0.0.0:8444 ssl&quot; \</span><br><span class="line">    -p 8000:8000 \</span><br><span class="line">    -p 8443:8443 \</span><br><span class="line">    -p 8001:8001 \</span><br><span class="line">    -p 8444:8444 \</span><br><span class="line">    kong</span><br></pre></td></tr></table></figure>
<ul>
<li>Admin Port<code>8001``8444</code></li>
<li>Gateway Port <code>8000</code> <code>8443</code></li>
</ul>
<h3 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h3><p>Default Configuration</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it kong kong config init &#x2F;home&#x2F;kong&#x2F;kong.yml</span><br><span class="line">docker exec -it kong cat &#x2F;home&#x2F;kong&#x2F;kong.yml &gt;&gt; kong.yml</span><br></pre></td></tr></table></figure>
<p>Post new Config</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST &quot;http:&#x2F;&#x2F;localhost:8001&#x2F;config&quot; \</span><br><span class="line">--header &quot;Content-Type: text&#x2F;yaml&quot; \</span><br><span class="line">--data-binary &quot;@&#x2F;kong.yml&quot;</span><br></pre></td></tr></table></figure>


<p>docker exec with root</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it --user root kong bash</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># https:&#x2F;&#x2F;docs.konghq.com&#x2F;install&#x2F;source&#x2F;</span><br><span class="line"></span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;Kong&#x2F;kong-build-tools</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="Install-With-DB"><a href="#Install-With-DB" class="headerlink" title="Install With DB"></a>Install With DB</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name kong-database \</span><br><span class="line">                -p 5432:5432 \</span><br><span class="line">                -e &quot;POSTGRES_USER&#x3D;kong&quot; \</span><br><span class="line">                -e &quot;POSTGRES_DB&#x3D;kong&quot; \</span><br><span class="line">                -e &quot;POSTGRES_PASSWORD&#x3D;kong&quot; \</span><br><span class="line">                postgres:9.6</span><br><span class="line"></span><br><span class="line">docker run --rm \</span><br><span class="line">    --link kong-database:kong-database \</span><br><span class="line">    -e &quot;KONG_DATABASE&#x3D;postgres&quot; \</span><br><span class="line">    -e &quot;KONG_PG_HOST&#x3D;kong-database&quot; \</span><br><span class="line">    -e &quot;KONG_PG_USER&#x3D;kong&quot; \</span><br><span class="line">    -e &quot;KONG_PG_PASSWORD&#x3D;kong&quot; \</span><br><span class="line">    -e &quot;KONG_CASSANDRA_CONTACT_POINTS&#x3D;kong-database&quot; \</span><br><span class="line">    kong kong migrations bootstrap</span><br><span class="line">    </span><br><span class="line">docker run -d --name kong \</span><br><span class="line">    --link kong-database:kong-database \</span><br><span class="line">    -e &quot;KONG_DATABASE&#x3D;postgres&quot; \</span><br><span class="line">    -e &quot;KONG_PG_HOST&#x3D;kong-database&quot; \</span><br><span class="line">    -e &quot;KONG_PG_PASSWORD&#x3D;kong&quot; \</span><br><span class="line">    -e &quot;KONG_CASSANDRA_CONTACT_POINTS&#x3D;kong-database&quot; \</span><br><span class="line">    -e &quot;KONG_PROXY_ACCESS_LOG&#x3D;&#x2F;dev&#x2F;stdout&quot; \</span><br><span class="line">    -e &quot;KONG_ADMIN_ACCESS_LOG&#x3D;&#x2F;dev&#x2F;stdout&quot; \</span><br><span class="line">    -e &quot;KONG_PROXY_ERROR_LOG&#x3D;&#x2F;dev&#x2F;stderr&quot; \</span><br><span class="line">    -e &quot;KONG_ADMIN_ERROR_LOG&#x3D;&#x2F;dev&#x2F;stderr&quot; \</span><br><span class="line">    -e &quot;KONG_ADMIN_LISTEN&#x3D;0.0.0.0:8001, 0.0.0.0:8444 ssl&quot; \</span><br><span class="line">    -p 8000:8000 \</span><br><span class="line">    -p 8443:8443 \</span><br><span class="line">    -p 8001:8001 \</span><br><span class="line">    -p 8444:8444 \</span><br><span class="line">    kong</span><br><span class="line">    </span><br><span class="line"> # add services, routes</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> docker exec -it --user root kong bash</span><br><span class="line"> # apk</span><br><span class="line"> apk update</span><br><span class="line"> apk add wget </span><br><span class="line"> apk add curl</span><br><span class="line"> # install plugins</span><br><span class="line"> luarocks install kong-oidc</span><br><span class="line"> </span><br><span class="line"> cp &#x2F;etc&#x2F;kong&#x2F;kong.conf.default &#x2F;etc&#x2F;kong&#x2F;kong.conf</span><br><span class="line"> vi &#x2F;etc&#x2F;kong&#x2F;kong.conf</span><br><span class="line"> # plugins &#x3D; oidc</span><br><span class="line"> # exit kong container</span><br><span class="line"> docker restart kong</span><br></pre></td></tr></table></figure>




<h2 id="Keycloak"><a href="#Keycloak" class="headerlink" title="Keycloak"></a>Keycloak</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name keycloak -p 8080:8080 -e KEYCLOAK_USER&#x3D;admin -e KEYCLOAK_PASSWORD&#x3D;admin jboss&#x2F;keycloak</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s http:&#x2F;&#x2F;dev:8080&#x2F;auth&#x2F;realms&#x2F;master&#x2F;.well-known&#x2F;openid-configuration | python -mjson.tool</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CLIENT_SECRET&#x3D;d1776f95-8a0b-4dc0-8e36-0a5a21b85bdf</span><br><span class="line">curl -s -X POST http:&#x2F;&#x2F;dev:8001&#x2F;plugins \</span><br><span class="line">  -d name&#x3D;oidc \</span><br><span class="line">  -d config.client_id&#x3D;kong \</span><br><span class="line">  -d config.client_secret&#x3D;$&#123;CLIENT_SECRET&#125; \</span><br><span class="line">  -d config.discovery&#x3D;http:&#x2F;&#x2F;dev:8080&#x2F;auth&#x2F;realms&#x2F;master&#x2F;.well-known&#x2F;openid-configuration \</span><br><span class="line">  | python -mjson.tool</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/09/iot-thethingsnetwork-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="shankai">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="零壹">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/09/iot-thethingsnetwork-notes/" class="post-title-link" itemprop="url">The Things Network 笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-09 20:00:00" itemprop="dateCreated datePublished" datetime="2021-06-09T20:00:00+08:00">2021-06-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-10 14:15:02" itemprop="dateModified" datetime="2021-06-10T14:15:02+08:00">2021-06-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/" itemprop="url" rel="index"><span itemprop="name">IoT</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>12 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><blockquote>
<p>Community</p>
</blockquote>
<h3 id="Download"><a href="#Download" class="headerlink" title="Download"></a>Download</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">## </span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;TheThingsNetwork&#x2F;lorawan-stack.git</span><br><span class="line"></span><br><span class="line">## install</span><br><span class="line">https:&#x2F;&#x2F;www.thethingsindustries.com&#x2F;docs&#x2F;getting-started&#x2F;installation&#x2F;</span><br></pre></td></tr></table></figure>
<h3 id="Certificates"><a href="#Certificates" class="headerlink" title="Certificates"></a>Certificates</h3><h4 id="ca-json"><a href="#ca-json" class="headerlink" title="ca.json"></a>ca.json</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;names&quot;</span>: [</span><br><span class="line">    &#123;<span class="attr">&quot;C&quot;</span>: <span class="string">&quot;NL&quot;</span>, <span class="attr">&quot;ST&quot;</span>: <span class="string">&quot;Noord-Holland&quot;</span>, <span class="attr">&quot;L&quot;</span>: <span class="string">&quot;Amsterdam&quot;</span>, <span class="attr">&quot;O&quot;</span>: <span class="string">&quot;The Things Demo&quot;</span>&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Generate:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl genkey -initca ca.json | cfssljson -bare ca</span><br></pre></td></tr></table></figure>
<h4 id="cert-json"><a href="#cert-json" class="headerlink" title="cert.json"></a>cert.json</h4><blockquote>
<p>change host</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;hosts&quot;</span>: [<span class="string">&quot;thethings.example.com&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;names&quot;</span>: [</span><br><span class="line">    &#123;<span class="attr">&quot;C&quot;</span>: <span class="string">&quot;NL&quot;</span>, <span class="attr">&quot;ST&quot;</span>: <span class="string">&quot;Noord-Holland&quot;</span>, <span class="attr">&quot;L&quot;</span>: <span class="string">&quot;Amsterdam&quot;</span>, <span class="attr">&quot;O&quot;</span>: <span class="string">&quot;The Things Demo&quot;</span>&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Generate:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca ca.pem -ca-key ca-key.pem cert.json | cfssljson -bare cert</span><br></pre></td></tr></table></figure>


<h4 id="Configuration-Cert"><a href="#Configuration-Cert" class="headerlink" title="Configuration Cert"></a>Configuration Cert</h4><ul>
<li>docker-compose.yml</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    # If using custom certificates:</span><br><span class="line">    secrets:</span><br><span class="line">      - ca.pem</span><br><span class="line">      - cert.pem</span><br><span class="line">      - key.pem</span><br><span class="line"></span><br><span class="line"># If using custom certificates:</span><br><span class="line">secrets:</span><br><span class="line">  ca.pem:</span><br><span class="line">    file: .&#x2F;ca.pem</span><br><span class="line">  cert.pem:</span><br><span class="line">    file: .&#x2F;cert.pem</span><br><span class="line">  key.pem:</span><br><span class="line">    file: .&#x2F;key.pem</span><br></pre></td></tr></table></figure>
<ul>
<li>ttn-lw-stack-docker.yml</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># If using custom certificates:</span><br><span class="line">tls:</span><br><span class="line">  source: file</span><br><span class="line">  root-ca: &#x2F;run&#x2F;secrets&#x2F;ca.pem</span><br><span class="line">  certificate: &#x2F;run&#x2F;secrets&#x2F;cert.pem</span><br><span class="line">  key: &#x2F;run&#x2F;secrets&#x2F;key.pem</span><br><span class="line"></span><br><span class="line"># Let&#39;s encrypt for &quot;thethings.example.com&quot;</span><br><span class="line"># tls:</span><br><span class="line">#   source: &#39;acme&#39;</span><br><span class="line">#   acme:</span><br><span class="line">#     dir: &#39;&#x2F;var&#x2F;lib&#x2F;acme&#39;</span><br><span class="line">#     email: &#39;you@thethings.example.com&#39;</span><br><span class="line">#     hosts: [&#39;thethings.example.com&#39;]</span><br><span class="line">#     default-host: &#39;thethings.example.com&#39;</span><br></pre></td></tr></table></figure>




<h3 id="Up"><a href="#Up" class="headerlink" title="Up"></a>Up</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">docker-compose pull</span><br><span class="line">docker-compose run --rm stack is-db init</span><br><span class="line">docker-compose run --rm stack is-db create-admin-user --id admin --email your@email.com</span><br><span class="line"></span><br><span class="line">docker-compose run --rm stack is-db create-oauth-client \</span><br><span class="line">  --id cli \</span><br><span class="line">  --name &quot;Command Line Interface&quot; \</span><br><span class="line">  --owner admin \</span><br><span class="line">  --no-secret \</span><br><span class="line">  --redirect-uri &quot;local-callback&quot; \</span><br><span class="line">  --redirect-uri &quot;code&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># see config&#x2F;stack&#x2F;ttn-lw-stack-docker.yml</span><br><span class="line">CONSOLE_SECRET&#x3D;&quot;console&quot;</span><br><span class="line">SERVER_ADDRESS&#x3D;&quot;dev:1885&quot;</span><br><span class="line"></span><br><span class="line">docker-compose run --rm stack is-db create-oauth-client \</span><br><span class="line">  --id console \</span><br><span class="line">  --name &quot;Console&quot; \</span><br><span class="line">  --owner admin \</span><br><span class="line">  --secret &quot;$&#123;CONSOLE_SECRET&#125;&quot; \</span><br><span class="line">  --redirect-uri &quot;$&#123;SERVER_ADDRESS&#125;&#x2F;console&#x2F;oauth&#x2F;callback&quot; \</span><br><span class="line">  --redirect-uri &quot;&#x2F;console&#x2F;oauth&#x2F;callback&quot; \</span><br><span class="line">  --logout-redirect-uri &quot;$&#123;SERVER_ADDRESS&#125;&#x2F;console&quot; \</span><br><span class="line">  --logout-redirect-uri &quot;&#x2F;console&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="Override"><a href="#Override" class="headerlink" title="Override"></a>Override</h2><p>Things Stack 是一个实现 LoRaWAN 协议的网络服务器。</p>
<h3 id="什么是-Things-Stack"><a href="#什么是-Things-Stack" class="headerlink" title="什么是 Things Stack?"></a>什么是 Things Stack?</h3><p>The Things Stack是企业级的 LoRaWAN 网络服务器，建立在<a target="_blank" rel="noopener" href="https://github.com/TheThingsNetwork/lorawan-stack">开源核心</a>之上。Things Stack允许您在自己的硬件或云上构建和管理 LoRaWAN 网络。</p>
<ul>
<li><p>TTS 是 The Things Stack, LoRaWAN Network Server Stack。Things Stack 目前是网络服务器实现的版本3，因此也被非正式地称为V3。</p>
</li>
<li><p>TTN 是 “物联网”(The Things Network)，它是一个全球协同物联网生态系统，使用 LoRaWAN 创建网络、设备和解决方案。The Things Network 运行着 The Things Stack Community Edition，这是一个众包、开放和去中心化的 LoRaWAN 网络。这个网络是一个很好的开始测试设备、应用程序和集成，并熟悉 LoRaWAN 的方法。</p>
</li>
<li><p>TTI 是 The Things Industries:该公司主要负责The Things Stack 的开发和文档编写。Things Industries 还提供具有额外企业功能的云托管和本地私有 LoRaWAN 网络，以及针对企业客户的高级支持计划。</p>
</li>
</ul>
<h2 id="Command-Line-Interface"><a href="#Command-Line-Interface" class="headerlink" title="Command-Line Interface"></a>Command-Line Interface</h2><p>…</p>
<h2 id="Console"><a href="#Console" class="headerlink" title="Console"></a>Console</h2><p>控制台是 LoRaWAN 的 Things Stack 的管理应用程序。它是一个 Web 应用程序，可以用来注册应用程序，终端设备或网关，监控网络流量，或配置网络相关选项等。</p>
<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><h3 id="Gateway-Server-MQTT"><a href="#Gateway-Server-MQTT" class="headerlink" title="Gateway Server MQTT"></a>Gateway Server MQTT</h3><p>MQTT 协议可用于开发自定义包转发器或网关桥接器，用于在网关和 The Things Stack 之间交换流量，或用于测试目的，方便地模拟网关流量。它是一个替代 Basic Station 和 Semtech UDP协议。</p>
<p>MQTT 是用于交换消息的服务器-客户机协议。客户端可以连接到服务器并发布特定主题下的消息(数据)。它们还可以订阅一个主题，从而接收在该主题下发布的所有消息(由其他客户机或MQTT服务器本身发布)。</p>
<p>网关服务器是 MQTT 服务器，网关作为 MQTT 客户端连接到网关服务器。连接的网关由用于身份验证的用户名标识。</p>
<h4 id="Protocol-Buffers"><a href="#Protocol-Buffers" class="headerlink" title="Protocol Buffers"></a>Protocol Buffers</h4><p>为了与 MQTT 协议通信，网关服务器和网关正在交换 Protocol Buffers。<a target="_blank" rel="noopener" href="https://github.com/TheThingsNetwork/lorawan-stack/blob/v3.13/api/lorawan.proto">https://github.com/TheThingsNetwork/lorawan-stack/blob/v3.13/api/lorawan.proto</a></p>
<h4 id="Connecting-to-the-Gateway-Server"><a href="#Connecting-to-the-Gateway-Server" class="headerlink" title="Connecting to the Gateway Server"></a>Connecting to the Gateway Server</h4><p>通过身份验证的客户端可以只写访问以下主题：</p>
<ul>
<li>v3/&lt; Gateway -id&gt;@<tenant-id>/up:用于向网关服务器发送上行流量。</li>
<li>v3/<gateway-id>@<tenant-id>/status:向网关服务器发送网关状态消息。</li>
<li>v3/&lt; Gateway -id&gt;@<tenant-id>/down/ack:用于向网关服务器发送TxAck消息。</li>
</ul>
<p>客户端也获得只读访问，并应该订阅以下主题:</p>
<ul>
<li>v3/&lt; Gateway -id&gt;@<tenant-id>/down:网关服务器发布网关应该发送的下行消息。</li>
</ul>
<h4 id="Uplink-Messages"><a href="#Uplink-Messages" class="headerlink" title="Uplink Messages"></a>Uplink Messages</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ export GATEWAY_ID&#x3D;&quot;test-gtw@my-tenant&quot;</span><br><span class="line">$ export GATEWAY_API_KEY&#x3D;&quot;NNSXS.VEEBURF3KR77ZR...&quot; # API key with RIGHT_GATEWAY_LINK rights</span><br><span class="line">$ mosquitto_pub \</span><br><span class="line">    -h &quot;thethings.example.com&quot; -p 1882 \</span><br><span class="line">    -u &quot;$GATEWAY_ID&quot; -P &quot;$GATEWAY_API_KEY&quot; \</span><br><span class="line">    -t &quot;v3&#x2F;$GATEWAY_ID&#x2F;up&quot; -f test-uplink-message</span><br></pre></td></tr></table></figure>
<h4 id="Downlink-Messages"><a href="#Downlink-Messages" class="headerlink" title="Downlink Messages"></a>Downlink Messages</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ export GATEWAY_ID&#x3D;&quot;test-gtw@my-tenant&quot;</span><br><span class="line">$ export GATEWAY_API_KEY&#x3D;&quot;NNSXS.VEEBURF3KR77ZR...&quot; # API key with RIGHT_GATEWAY_LINK rights</span><br><span class="line">$ mosquitto_sub \</span><br><span class="line">    -h &quot;thethings.example.com&quot; -p 1882 \</span><br><span class="line">    -u &quot;$GATEWAY_ID&quot; -P &quot;$GATEWAY_API_KEY&quot; \</span><br><span class="line">    -t &quot;v3&#x2F;$GATEWAY_ID&#x2F;down&quot; -v</span><br></pre></td></tr></table></figure>
<h4 id="Gateway-Status-Messages"><a href="#Gateway-Status-Messages" class="headerlink" title="Gateway Status Messages"></a>Gateway Status Messages</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ export GATEWAY_ID&#x3D;&quot;test-gtw@my-tenant&quot;</span><br><span class="line">$ export GATEWAY_API_KEY&#x3D;&quot;NNSXS.VEEBURF3KR77ZR...&quot; # API key with RIGHT_GATEWAY_LINK rights</span><br><span class="line">$ mosquitto_pub \</span><br><span class="line">    -h &quot;thethings.example.com&quot; -p 1882 \</span><br><span class="line">    -u &quot;$GATEWAY_ID&quot; -P &quot;$GATEWAY_API_KEY&quot; \</span><br><span class="line">    -t &quot;v3&#x2F;$GATEWAY_ID&#x2F;status&quot; -f test-gateway-status</span><br></pre></td></tr></table></figure>
<h4 id="TxAck-Messages"><a href="#TxAck-Messages" class="headerlink" title="TxAck Messages"></a>TxAck Messages</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ export GATEWAY_ID&#x3D;&quot;test-gtw@my-tenant&quot;</span><br><span class="line">$ export GATEWAY_API_KEY&#x3D;&quot;NNSXS.VEEBURF3KR77ZR...&quot; # API key with RIGHT_GATEWAY_LINK rights</span><br><span class="line">$ mosquitto_pub \</span><br><span class="line">    -h &quot;thethings.example.com&quot; -p 1882 \</span><br><span class="line">    -u &quot;$GATEWAY_ID&quot; -P &quot;$GATEWAY_API_KEY&quot; \</span><br><span class="line">    -t &quot;v3&#x2F;$GATEWAY_ID&#x2F;down&#x2F;ack&quot; -f example-tx-ack</span><br></pre></td></tr></table></figure>


<h2 id="Working-with-Events"><a href="#Working-with-Events" class="headerlink" title="Working with Events"></a>Working with Events</h2><p>Things Stack 生成大量的事件，让你能够洞察正在发生的事情。可以订阅应用程序、网关、终端设备事件，以及用户、组织和 OAuth 客户端事件。</p>
<h3 id="CLI"><a href="#CLI" class="headerlink" title="CLI"></a>CLI</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ttn-lw-cli events subscribe --gateway-id gtw1 --application-id app1</span><br></pre></td></tr></table></figure>


<h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># create api key token</span><br><span class="line">ttn-lw-cli users api-key create \</span><br><span class="line">  --user-id admin \</span><br><span class="line">  --right-application-all \</span><br><span class="line">  --right-gateway-all</span><br><span class="line"></span><br><span class="line"># subscribe stream</span><br><span class="line">curl https:&#x2F;&#x2F;thethings.example.com&#x2F;api&#x2F;v3&#x2F;events \</span><br><span class="line">  -X POST \</span><br><span class="line">  -H &quot;Authorization: Bearer NNSXS.BR55PTYILPPVXY..&quot; \</span><br><span class="line">  -H &quot;Accept: text&#x2F;event-stream&quot; \</span><br><span class="line">  --data &#39;&#123;&quot;identifiers&quot;:[&#123;&quot;application_ids&quot;:&#123;&quot;application_id&quot;:&quot;app1&quot;&#125;&#125;,&#123;&quot;gateway_ids&quot;:&#123;&quot;gateway_id&quot;:&quot;gtw1&quot;&#125;&#125;]&#125;&#39;</span><br></pre></td></tr></table></figure>


<h2 id="Components"><a href="#Components" class="headerlink" title="Components"></a>Components</h2><h3 id="Application-Server"><a href="#Application-Server" class="headerlink" title="Application Server"></a>Application Server</h3><p>Application Server 处理 LoRaWAN 应用层，包括上行数据的解密和解码、下行队列和下行数据的编码和加密。</p>
<p>它托管一个用于流媒体应用程序数据的MQTT服务器，支持HTTP webhook以及发布/订阅集成。</p>
<p>应用程序可以通过多种协议和机制连接到 Application Server。</p>
<ul>
<li>MQTT Protocol</li>
</ul>
<p>应用程序可以通过 MQTT 交换 JSON 消息来连接到应用服务器。MQTT 在 TLS 上可用，为应用程序和应用服务器之间交换的消息提供机密性。</p>
<p>上行消息不仅包含数据上行消息，而且还包含不同主题的 join-accept 和 downlink 事件。</p>
<ul>
<li>HTTP Webhooks</li>
</ul>
<p>应用程序可以通过 HTTP webhook 获取流 JSON 消息，并通过向应用服务器发出 HTTP 请求来调度下行消息。</p>
<p>与 MQTT 一样，可以配置所有上游消息，包括上行消息、加入接收事件和下行事件，每个都用于分隔 URL 路径。</p>
<ul>
<li>Pub/Sub Integrations</li>
</ul>
<p>应用程序还可以使用发布/订阅集成来处理流数据。这包括连接到外部 MQTT 服务器和 NATS 服务器。</p>
<ul>
<li>Message Processing</li>
</ul>
<p>Application Server 可以解码和编码由终端设备发送和接收的二进制有效负载。这允许使用结构化流数据，例如使用 MQTT 和 HTTP Webhook 的JSON对象，同时使用通过无线电传输的压缩二进制数据。</p>
<p>消息处理器可以是众所周知的格式或自定义脚本，可以在设备级别或针对整个应用程序进行设置。</p>
<h3 id="Network-Server"><a href="#Network-Server" class="headerlink" title="Network Server"></a>Network Server</h3><p>Network Server 负责处理 LoRaWAN 网络层，包括 MAC命令、区域参数和自适应数据速率(ADR)。</p>
<h4 id="Device-Management"><a href="#Device-Management" class="headerlink" title="Device Management"></a>Device Management</h4><p> 网络服务器为终端设备(End-Device)管理公开了 NsEndDeviceRegistry 服务。该服务的典型客户端有 Console 和 CLI。</p>
<p>网络服务器存储设备 MAC 配置、MAC状态 和网络会话密钥。</p>
<p>设备MAC配置变化可能会触发下行报文。</p>
<h4 id="Application-Downlink-Queue-Management-and-Linking"><a href="#Application-Downlink-Queue-Management-and-Linking" class="headerlink" title="Application Downlink Queue Management and Linking"></a>Application Downlink Queue Management and Linking</h4><p>网络服务器允许应用服务器推送、替换和列出应用下行链路，以及通过 gRPC API 链接应用。</p>
<p>改变应用程序下行队列可能会触发下行消息。</p>
<p>一旦链接建立，Network Server 将通过该链接向客户端发送特定于应用程序的上行消息。每个应用程序最多只能有一个活动链接。</p>
<p>如果链接不是活动的，但是 Network Server 有特定于应用程序的上行消息要发送，这些消息将在链接建立后排队并发送。</p>
<h4 id="Downlink-Scheduling"><a href="#Downlink-Scheduling" class="headerlink" title="Downlink Scheduling"></a>Downlink Scheduling</h4><p>网络服务器维护内部下行任务队列。每个下行任务都有一个与之相关的执行时间，这些任务按升序排列。每当下行任务准备执行时，它就会尽快执行。</p>
<h5 id="Join-accept"><a href="#Join-accept" class="headerlink" title="Join-accept"></a>Join-accept</h5><p>如果存在一个挂起的会话，并且为该设备排队加入join-accept，它将被调度。</p>
<h5 id="Data-downlink"><a href="#Data-downlink" class="headerlink" title="Data downlink"></a>Data downlink</h5><p>如果一个挂起的会话不存在或已经发送了 Join-accept, Network Server 将尝试在活动会话中生成并调度数据下行。</p>
<h4 id="Uplink-Handing"><a href="#Uplink-Handing" class="headerlink" title="Uplink Handing"></a>Uplink Handing</h4><p>网络服务器通过 gRPC 从网关服务器接收上行链路。</p>
<p>网络服务器对接收到的上行链路进行处理。第一步是将上行链路与设备匹配。如果上行链路不能与网络服务器中存储的设备匹配，则丢弃上行链路。</p>
<h5 id="Join-Request"><a href="#Join-Request" class="headerlink" title="Join-Request"></a>Join-Request</h5><p>如果收到 Join-request:</p>
<ol>
<li>设备使用连接请求中出现的 DevEUI和 JoinEUI 对进行匹配，这是唯一标识设备的。</li>
<li>新的 <code>DevAddr</code> 被分配给设备，新的 MAC 状态被派生出来。</li>
<li>如果集群中存在 Join Server, Network Server 将向集群本地 Join Server 发送一个Join请求消息。</li>
<li>如果集群中不存在 Join Server，或者设备没有在集群本地 Join Server 中提供，网络服务器将向通过互操作性配置发现的 Join Server 发送一个 Join 请求消息。</li>
<li>如果一个 Join Server 接受了Join-request，设备可能会排队接收 Join-accept 消息，并向链接的 Application Server 发送特定于应用程序的上行消息，这些上行消息携带有关Join-accept 的信息。</li>
</ol>
<h5 id="Data-Uplink"><a href="#Data-Uplink" class="headerlink" title="Data Uplink"></a>Data Uplink</h5><p>如果收到数据上行：</p>
<ol>
<li>使用数据上行链路中存在的 DevAddr 匹配设备。通过比较会话上下文和 MAC 状态进行匹配，并进行 MIC 检查。由于多个设备可能具有相同的 DevAddr，网络服务器在匹配设备之前可能需要通过多个存储设备。</li>
<li>网络服务器处理 MAC 命令，如果这样的命令存在于帧中，并相应地更新 MAC 状态。</li>
<li>如果数据上行配置了ADR 位，Network Server 运行 ADR 算法，更新 MAC 状态。</li>
<li>如果数据上行链路处理成功，下行链路可能会为设备排队，一个或多个特定于应用程序的上行消息携带有关 Join-accept 的相关信息被发送到链接的应用服务器。</li>
</ol>
<h3 id="Identity-Server"><a href="#Identity-Server" class="headerlink" title="Identity Server"></a>Identity Server</h3><p>身份服务器提供了存储实体(如应用程序及其终端设备、网关、用户、组织、OAuth客户端和身份验证提供者)的注册中心。它还通过成员关系和API键管理访问控制。</p>
<h4 id="Entity-Registries"><a href="#Entity-Registries" class="headerlink" title="Entity Registries"></a>Entity Registries</h4><p>实体注册中心存储关于 Things Stack 中所有主要实体的公共信息。这包括名称、描述和属性(用户定义的键值对)。</p>
<h5 id="Users"><a href="#Users" class="headerlink" title="Users"></a>Users</h5><p>在 Identity Server 中注册的第一个实体通常是管理用户。用户可以通过提供电子邮件地址并选择用户ID和密码进行注册。这些信息以后可以用于登录。</p>
<p>用户ID是用户的唯一标识符。用户 ID 与组织 ID 在同一个命名空间中。这意味着不可能创建与现有组织具有相同ID的用户。出于安全原因，也不可能重用已删除用户或组织的ID。</p>
<p>用户可以是“admin”，这给了他们更高的权限。正常的注册过程不允许用户注册为 admin，这就是为什么入门指南使用不同的命令创建admin用户。</p>
<p>用户可以处于多个状态之一：请求、批准、拒绝、挂起等。用户的状态决定了用户是否能够执行操作，以及哪些操作。正常情况下，用户处于“批准”状态。如果 The Things Stack 被配置为需要新用户的管理批准，那么用户最初处于“请求”状态，管理用户可以将其更新为“批准”或“拒绝”状态。如果用户行为不当，也可能被管理员挂起。</p>
<h5 id="Gateways"><a href="#Gateways" class="headerlink" title="Gateways"></a>Gateways</h5><p>网关可以通过选择一个ID和可选地注册网关的EUI来注册。注册后，可以创建一个API密钥；网关可以使用它的ID(或EUI)和API密钥一起使用 The Things Stack 进行身份验证。</p>
<p>为了保证网关的正常运行，需要设置频率规划ID，并设置网关是否需要满足占空比。</p>
<p>如果网关能够与网关配置服务器通信，则可以在网关注册表中设置网关服务器地址和固件更新设置。</p>
<p>网关注册表还存储有关网关天线的信息，如位置和增益。</p>
<h5 id="Applications"><a href="#Applications" class="headerlink" title="Applications"></a>Applications</h5><p>应用程序用于在一个地方组织多个终端设备的注册和流量。应用程序通常对应于处于相同部署或相同类型的终端设备集合。</p>
<h5 id="End-Devices"><a href="#End-Devices" class="headerlink" title="End Devices"></a>End Devices</h5><p>Identity Server 中的终端设备注册表只存储终端设备的元数据，允许  Console 和 CLI 等客户端在应用程序中列出终端设备。它通常存储有关终端设备的品牌、模型、硬件、固件和位置的元数据。它还存储了 Network Server、Application Server 和Join Server的地址，以便 Console 和 CLI 等客户机知道存储终端设备的其他属性的位置。</p>
<h5 id="Organizations"><a href="#Organizations" class="headerlink" title="Organizations"></a>Organizations</h5><p>组织用于创建多个用户组，并方便地为整个用户组分配权限。</p>
<p>组织ID是组织的唯一标识符。组织id与用户id在相同的命名空间中。这意味着不可能创建具有与现有用户相同ID的组织。出于安全原因，也不可能重用已删除用户或组织的ID。</p>
<h5 id="OAuth-Clients"><a href="#OAuth-Clients" class="headerlink" title="OAuth Clients"></a>OAuth Clients</h5><p>可以在 OAuth 注册表中注册外部 OAuth 客户端。OAuth 客户端使用客户端ID和秘密进行注册。</p>
<p>与用户一样，OAuth客户机可以处于多种状态中的一种。非admin用户创建的OAuth客户端需要admin用户审批。</p>
<p>官方的OAuth客户端可以被标记为“背书”，或者可以为所有用户预先授权。</p>
<h5 id="Authentication-Providers"><a href="#Authentication-Providers" class="headerlink" title="Authentication Providers"></a>Authentication Providers</h5><p>联邦身份验证提供者可以在身份验证提供者注册中心中注册。身份验证提供者使用ID、名称和提供者配置注册。</p>
<p>身份验证提供者用于允许 Identity Server 从外部身份提供者(如OpenID Connect提供者)获得用户的身份。</p>
<h4 id="Entity-Access"><a href="#Entity-Access" class="headerlink" title="Entity Access"></a>Entity Access</h4><p>标识服务器负责对实体的访问控制。</p>
<h5 id="Memberships"><a href="#Memberships" class="headerlink" title="Memberships"></a>Memberships</h5><p>成员资格定义了用户或组织对另一个实体拥有的权利。最简单的成员关系是用户是应用程序或网关的直接成员(或合作者)。成员资格的权限表明允许用户对应用程序或网关做什么。</p>
<p>间接成员关系是指用户是某个组织的成员，而该组织是某个应用程序或网关的成员。在这种情况下，用户-组织成员关系的权限与组织-应用或组织-网关成员关系的权限相交，计算出该用户的有效权限。</p>
<h5 id="API-Keys"><a href="#API-Keys" class="headerlink" title="API Keys"></a>API Keys</h5><p>对于大多数实体，都可以创建API Keys。这些 API Keys 允许您代表实体调用 API。API 密钥不会过期，但是可以撤销 API 密钥。</p>
<p>API键具有相关联的权限。这意味着可以创建一个应用程序API密钥，该密钥可以用来读取有关终端设备的信息，但不能看到根密钥，也不能进行更改。</p>
<p>可以合并成员资格和API密钥，例如，您可以创建一个组织API密钥，该密钥具有列出组织成员所在的应用程序的权利，以及读取这些应用程序中终端设备信息的权利。</p>
<h4 id="OAuth"><a href="#OAuth" class="headerlink" title="OAuth"></a>OAuth</h4><p>Identity Server 是 OAuth 2.0 服务器。用户可以授权 OAuth 客户机访问他们的数据、管理授权，甚至管理单个访问令牌。</p>
<h3 id="Join-Server"><a href="#Join-Server" class="headerlink" title="Join Server"></a>Join Server</h3><p>连接服务器处理 LoRaWAN 连接流，包括网络和应用服务器身份验证和会话密钥生成。</p>
<h4 id="Join-Procedure"><a href="#Join-Procedure" class="headerlink" title="Join Procedure"></a>Join Procedure</h4><p>连接服务器通过 gRPC 接收来自网络服务器的加入请求，如果加入请求验证通过，则为注册设备发出加入接收。</p>
<p>如果接受了一个连接请求，Join Server将派生会话安全上下文，该上下文包含会话密钥，并由会话密钥 ID 标识。使用分别在网络服务器和应用服务器之间共享的密钥加密密钥(KEKs)， Join Servers 加密派生的网络和应用程序会话密钥，并将会话密钥以加密的形式包含在 Join-accept 中。</p>
<h4 id="Device-Management-1"><a href="#Device-Management-1" class="headerlink" title="Device Management"></a>Device Management</h4><p>Join Servers 公开JsEndDeviceRegistry 服务用于终端设备管理。该服务的典型客户端有 Console 和 CLI。</p>
<p>Join Servers 存储设备根和会话密钥。</p>
<h4 id="Session-Key-Retrieval"><a href="#Session-Key-Retrieval" class="headerlink" title="Session Key Retrieval"></a>Session Key Retrieval</h4><p>Join Servers 公开 rpc 以检索给定会话密钥ID的会话密钥。</p>
<h4 id="Interoperability"><a href="#Interoperability" class="headerlink" title="Interoperability"></a>Interoperability</h4><p>Join Servers 公开了LoRaWAN后端接口 1.0 规范中定义的 AS-JS、vNS-JS 和 hNS-JS 服务。</p>
<h3 id="Gateway-Server"><a href="#Gateway-Server" class="headerlink" title="Gateway Server"></a>Gateway Server</h3><p>网关服务器维护与支持基站、UDP、MQTT 和 gRPC 协议的网关的连接。上行流量直接或间接转发给网络服务器，下行流量由网关调度。</p>
<h4 id="Connective"><a href="#Connective" class="headerlink" title="Connective"></a>Connective</h4><p>网关可以通过多种协议连接到网关服务器。</p>
<ul>
<li>Basic Station Protocol</li>
</ul>
<p>网关可以通过基站 LNS 协议与网关服务器连接。建议使用此协议连接网关。</p>
<ul>
<li>UDP Protocol</li>
</ul>
<p>网关可以通过 UDP 协议连接到网关服务器。与每条消息一起发送的 EUI 用于标识网关。</p>
<p>如果在标识服务器中找到具有此 EUI 的网关，则消息与此网关相关。否则，根据网络配置，上行链路可能被路由或丢弃。但是，由于无法识别其区域参数，网络将不会向此网关发送下行链路。</p>
<p>旧版本的数据包转发器实现 UDP 协议没有实现任何排队系统下行链路，导致数据包丢失，因为 SX130x 集中器不缓冲多个下行链路。因此，对于 UDP 协议，Things Stack 实现了向下发送到网关的延迟，这意味着它们将由集中器发出。您可以每个网关单独禁用此功能，例如，如果网关和网关服务器之间的RTT过高。</p>
<ul>
<li>MQTT Protocol</li>
</ul>
<p>网关可以通过 MQTT 交换 Protocol Buffer 连接到网关服务器。MQTT 可在TLS上使用，提供网关和网络之间交换的消息的机密性。与使用 JSON 编码的 UDP 协议相比，使用 Protocol Buffer 的编码减少了带宽的使用。技术细节请参见网关服务器MQTT协议。</p>
<p>实现 MQTT 协议的包转发器(Packet forwarders)特定于Things Stack。</p>
<h4 id="Gateway-Information"><a href="#Gateway-Information" class="headerlink" title="Gateway Information"></a>Gateway Information</h4><p>当连接网关时，网关服务器会统计与网关交换的消息以及网关发送的状态消息。这些统计数据可以通过网关服务器的gRPC和HTTP api来检索。看到Gs服务。</p>
<h4 id="Communication-with-Network-Server"><a href="#Communication-with-Network-Server" class="headerlink" title="Communication with Network Server"></a>Communication with Network Server</h4><p>网关服务器的主要功能是维护与网关的连接，并作为网关和网络服务器之间的中继。</p>
<h5 id="Uplink-Messages-1"><a href="#Uplink-Messages-1" class="headerlink" title="Uplink Messages"></a>Uplink Messages</h5><p>当网关服务器接收数据上行消息时，根据设备的 DevAddr 和配置的转发表决定发送到哪个 Network Server。连接请求被路由到所有已配置的端点。端点可以是集群的 gRPC 网络服务器，或者是中间流量路由机制。</p>
<h5 id="Downlink-Messages-1"><a href="#Downlink-Messages-1" class="headerlink" title="Downlink Messages"></a>Downlink Messages</h5><p>网络服务器可以请求下行消息的传输。网关服务器尝试基于所选网关、发送消息的时间和 LoRaWAN 设置(下行链路类、RX1延迟和RX1/RX2数据速率和频率)来调度消息。</p>
<p>网关服务器跟踪所有发送的和连接到它的网关将要发送的下行链路，包括基于消息大小和数据速率的准确广播时间。这使得 The Things Stack 能够进行智能调度。除了定时和 LoRaWAN 设置，网关服务器考虑到适用的限制，包括：</p>
<ul>
<li>调度冲突：如果一个下行链路的发送与另一个下行链路的发送重叠，则下行链路将被拒绝。</li>
<li>停飞时间：一些频带和频率计划有停飞时间限制，这意味着网关在发送下行链路后的一段时间内不能发射。</li>
<li>频宽比：一些国家，如欧洲国家，有频宽比限制，禁止一个设备在一定范围内排放超过一定百分比的时间。</li>
<li>停留时间：一些国家，如美国，受停留时间的规定，即传输的持续时间不能超过一定的限制。</li>
</ul>
<h2 id="Networking"><a href="#Networking" class="headerlink" title="Networking"></a>Networking</h2><h3 id="Port-Allocations"><a href="#Port-Allocations" class="headerlink" title="Port Allocations"></a>Port Allocations</h3><p>The following table lists the default ports used.</p>
<table>
<thead>
<tr>
<th><strong>Purpose</strong></th>
<th><strong>Protocol</strong></th>
<th><strong>Authentication</strong></th>
<th><strong>Port</strong></th>
<th><strong>Port (TLS)</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Gateway data</td>
<td><a target="_blank" rel="noopener" href="https://github.com/Lora-net/packet_forwarder/blob/master/PROTOCOL.TXT">Semtech Packet Forwarder</a></td>
<td>None</td>
<td>1700 (UDP)</td>
<td>N/A</td>
</tr>
<tr>
<td>Gateway data</td>
<td>MQTT (V2)</td>
<td>API key, token</td>
<td>1881</td>
<td>8881</td>
</tr>
<tr>
<td>Gateway data</td>
<td>MQTT</td>
<td>API key, token</td>
<td>1882</td>
<td>8882</td>
</tr>
<tr>
<td>Application data, events</td>
<td>MQTT</td>
<td>API key, token</td>
<td>1883</td>
<td>8883</td>
</tr>
<tr>
<td>Management, data, events</td>
<td>gRPC</td>
<td>API key, token</td>
<td>1884</td>
<td>8884</td>
</tr>
<tr>
<td>Management</td>
<td>HTTP</td>
<td>API key, token</td>
<td>1885</td>
<td>8885</td>
</tr>
<tr>
<td>Backend Interfaces</td>
<td>HTTP</td>
<td>Custom</td>
<td>N/A</td>
<td>8886</td>
</tr>
<tr>
<td>LNS</td>
<td>Web Sockets</td>
<td>Auth Token, Custom</td>
<td>1887</td>
<td>8887</td>
</tr>
<tr>
<td>Tabs Hubs LNS</td>
<td>Web Sockets</td>
<td>Auth Token, Custom</td>
<td>1888</td>
<td>8888</td>
</tr>
</tbody></table>
<h3 id="Service-Discovery"><a href="#Service-Discovery" class="headerlink" title="Service Discovery"></a>Service Discovery</h3><p>The Things Stack supports discovering services using DNS SRV records. This is useful when dialing a cluster only by host name; the supported services and target host name and port are discovered using DNS.</p>
<p>To support service discovery for your The Things Stack cluster, configure DNS SRV records with the following services and protocols:</p>
<table>
<thead>
<tr>
<th><strong>Protocol</strong></th>
<th><strong>SRV Service</strong></th>
<th><strong>SRV Protocol</strong></th>
<th><strong>SRV Target</strong></th>
</tr>
</thead>
<tbody><tr>
<td>gRPC</td>
<td><code>ttn-v3-is-grpc</code></td>
<td><code>tcp</code></td>
<td>Identity Server</td>
</tr>
<tr>
<td>gRPC</td>
<td><code>ttn-v3-gs-grpc</code></td>
<td><code>tcp</code></td>
<td>Gateway Server</td>
</tr>
<tr>
<td>Semtech Packet Forwarder</td>
<td><code>ttn-v3-gs-udp</code></td>
<td><code>udp</code></td>
<td>Gateway Server</td>
</tr>
<tr>
<td>MQTT (V2)</td>
<td><code>ttn-v3-gs-mqttv2</code></td>
<td><code>tcp</code></td>
<td>Gateway Server</td>
</tr>
<tr>
<td>MQTT</td>
<td><code>ttn-v3-gs-mqtt</code></td>
<td><code>tcp</code></td>
<td>Gateway Server</td>
</tr>
<tr>
<td>Basic Station LNS</td>
<td><code>ttn-v3-gs-basicstationlns</code></td>
<td><code>tcp</code></td>
<td>Gateway Server</td>
</tr>
<tr>
<td>gRPC</td>
<td><code>ttn-v3-ns-grpc</code></td>
<td><code>tcp</code></td>
<td>Network Server</td>
</tr>
<tr>
<td>gRPC</td>
<td><code>ttn-v3-as-grpc</code></td>
<td><code>tcp</code></td>
<td>Application Server</td>
</tr>
<tr>
<td>MQTT</td>
<td><code>ttn-v3-as-mqtt</code></td>
<td><code>tcp</code></td>
<td>Application Server</td>
</tr>
<tr>
<td>gRPC</td>
<td><code>ttn-v3-js-grpc</code></td>
<td><code>tcp</code></td>
<td>Join Server</td>
</tr>
<tr>
<td>gRPC</td>
<td><code>ttn-v3-dtc-grpc</code></td>
<td><code>tcp</code></td>
<td>Device Template Converter</td>
</tr>
<tr>
<td>gRPC</td>
<td><code>ttn-v3-dcs-grpc</code></td>
<td><code>tcp</code></td>
<td>Device Claiming Server</td>
</tr>
<tr>
<td>gRPC</td>
<td><code>ttn-v3-gcs-grpc</code></td>
<td><code>tcp</code></td>
<td>Gateway Configuration Server</td>
</tr>
<tr>
<td>gRPC</td>
<td><code>ttn-v3-qrg-grpc</code></td>
<td><code>tcp</code></td>
<td>QR Code Generator</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/25/iot-chirpstack-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="shankai">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="零壹">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/25/iot-chirpstack-notes/" class="post-title-link" itemprop="url">ChirpStack 笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-25 20:00:00" itemprop="dateCreated datePublished" datetime="2021-05-25T20:00:00+08:00">2021-05-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-10 14:33:21" itemprop="dateModified" datetime="2021-06-10T14:33:21+08:00">2021-06-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IoT/" itemprop="url" rel="index"><span itemprop="name">IoT</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><a target="_blank" rel="noopener" href="https://www.chirpstack.io/">https://www.chirpstack.io/</a></p>
<p>LoRaWAN®是一种低功耗、广域(LPWA)网络协议，设计用于在区域、国家或全球网络中将电池操作的“事物”无线连接到互联网，并针对物联网的关键需求，如双向通信、端到端安全性、移动性和本地化服务。</p>
<p>ChirpStack 为 LoRaWAN 网络提供开源组件。它们一起形成了一个现成的解决方案，包括用于设备管理的用户友好的 WEB 界面和用于集成的 API。模块化的体系结构使得在现有的基础设施中集成成为可能。所有组件都在MIT许可下许可，并可用于商业目的。提供了以下组件:</p>
<ul>
<li>ChirpStack网关桥：处理与 LoRaWAN 网关的通信。</li>
<li>ChirpStack网络服务器：一个 LoRaWAN 网络服务器的实现。</li>
<li>ChirpStack应用服务器：一个 LoRaWAN 应用服务器的实现。</li>
<li>ChirpStack Gateway OS：在基于树莓派(<em>Raspberry Pi</em>)的 LoRa 网关上运行(完整) ChirpStack栈的 Linux 操作系统。</li>
</ul>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p><img src="https://www.chirpstack.io/static/img/graphs/architecture.dot.png" alt="architecture"></p>
<h3 id="LoRaWAN-设备"><a href="#LoRaWAN-设备" class="headerlink" title="LoRaWAN 设备"></a>LoRaWAN 设备</h3><p>LoRaWAN设备(上图中未显示)是通过一个或多个 LoRa 网关向 ChirpStack 网络服务器发送数据的设备。例如，这些设备可以是测量空气质量、温度、湿度、位置的传感器…</p>
<h3 id="LoRa®网关"><a href="#LoRa®网关" class="headerlink" title="LoRa®网关"></a>LoRa®网关</h3><p>一个 LoRa 网关(通常)同时侦听 8 个或更多的通道，并将接收到的数据(从设备)转发到一个 LoRaWAN 网络服务器(在本例中是 ChirpStack 网络服务器)。运行在 LoRa 网关上负责接收和发送的软件称为包转发器(Packet Forwarder)。常见的实现是 <a target="_blank" rel="noopener" href="https://github.com/Lora-net/packet_forwarder/">Semtech UDP Packet Forwarder</a> 和 <a target="_blank" rel="noopener" href="https://doc.sm.tc/station/">Semtech Basic Station Packet Forwarder</a>.。</p>
<h3 id="ChirpStack-网关桥"><a href="#ChirpStack-网关桥" class="headerlink" title="ChirpStack 网关桥"></a>ChirpStack 网关桥</h3><p>ChirpStack 网关桥接器位于数据包转发器和 MQTT 代理之间。它将数据包转发器格式(如Semtech UDP数据包转发器协议)转换为数据格式，由 ChirpStack 组件使用。它还提供与各种云平台的集成，如 GCP 云物联网核心和 Azure 物联网枢纽。</p>
<h3 id="ChirpStack-网络服务器"><a href="#ChirpStack-网络服务器" class="headerlink" title="ChirpStack 网络服务器"></a>ChirpStack 网络服务器</h3><p>ChirpStack 网络服务器是一个 LoRaWAN 网络服务器，负责管理网络状态。它具有网络上设备激活的知识，并能够在设备想要加入网络时处理连接请求。</p>
<p>当数据被多个网关接收时，ChirpStack 网络服务器将删除这些重复数据，并将其作为一个有效负载转发到 ChirpStack 应用服务器。</p>
<p>当应用服务器需要将数据发送回设备时，ChirpStack 网络服务器将把这些项目保存在队列中，直到它能够发送到其中一个网关。</p>
<h3 id="ChirpStack应用服务器"><a href="#ChirpStack应用服务器" class="headerlink" title="ChirpStack应用服务器"></a>ChirpStack应用服务器</h3><p>ChirpStack 应用服务器是 LoRaWAN 应用服务器，与 ChirpStack 网络服务器兼容。它提供了一个 WEB 界面和 API，用于管理用户、组织、应用、网关和设备。</p>
<p>接收到的上行数据被转发到一个或多个已配置的集成。</p>
<h3 id="终端应用"><a href="#终端应用" class="headerlink" title="终端应用"></a>终端应用</h3><p>终端应用程序通过一个已配置的集成接收设备数据。它可以使用 ChirpStack 应用服务器 API 来调度设备的下行有效负载。终端应用程序的目的可能是分析、警报、数据可视化、触发操作……</p>
<h2 id="ChirpStack-Application-Server"><a href="#ChirpStack-Application-Server" class="headerlink" title="ChirpStack Application Server"></a>ChirpStack Application Server</h2><p>ChirpStack Application Server是一个开源的LoRaWAN®应用服务器，是 ChirpStack 开源 LoRaWAN 网络服务器堆栈的一部分。它负责 LoRaWAN 基础设施的设备“库存”部分，处理连接请求和应用程序有效负载的处理和加密。 </p>
<p>它提供了一个可以管理用户、组织、应用程序和设备的网络界面。为了与外部服务集成，它提供了 gRPC 和 RESTful API。</p>
<p>发送 和/或 接收的设备数据可以通过 MQTT、HTTP 或直接写入到 InfluxDB。</p>
<h3 id="有效载荷加密-解密"><a href="#有效载荷加密-解密" class="headerlink" title="有效载荷加密/解密"></a>有效载荷加密/解密</h3><p>ChirpStack Application Server 处理应用程序有效负载的加密和解密。它还保存每个设备的应用程序键，并在 OTAA 激活时处理 join-accept。这意味着有效载荷将被解密发送到集成，但在有效载荷被发送到 ChirpStack 网络服务器之前，网络服务器无法访问这些有效载荷。</p>
<h3 id="Web-界面"><a href="#Web-界面" class="headerlink" title="Web 界面"></a>Web 界面</h3><p>ChirpStack Application Server 提供了一个 Web 界面 (构建在提供的 RESTful API 之上)。这个 Web 界面可以用来管理用户、组织、应用程序和设备。</p>
<h3 id="用户授权"><a href="#用户授权" class="headerlink" title="用户授权"></a>用户授权</h3><p>使用 ChirpStack Application Server，可以授予用户全局的管理员权限，使他们成为组织的管理员，或者为他们分配组织内的仅查看权限。这使得在多租户环境中运行 ChirpStack Application Server 成为可能，在这种环境中，每个组织或团队只能访问他们自己的应用程序和设备。</p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>为了与外部服务集成，ChirpStack Application Server 提供了gRPC 和 RESTFul API，公开了与 Web 界面相同的功能。</p>
<h3 id="有效载荷和设备事件"><a href="#有效载荷和设备事件" class="headerlink" title="有效载荷和设备事件"></a>有效载荷和设备事件</h3><p>ChirpStack Application Server 提供了不同的方式发送和接收设备负载(例如MQTT, HTTP, InfluxDB，…)。</p>
<p>注意:下行负载也可以通过API进行调度。</p>
<h3 id="网关发现"><a href="#网关发现" class="headerlink" title="网关发现"></a>网关发现</h3><p>对于包含多个网关的网络，ChirpStack Application Server 提供了一个特性来测试网关的网络覆盖。通过向每个网关定期发送 “ping”，ChirpStack 应用服务器能够发现这些 ping 被同一网络中的其他网关接收的情况。采集到的数据以地图的形式显示在 Web 界面上。可以为每个 Network Server 启用和配置此功能。</p>
<h3 id="活动的帧日志-frame-logging"><a href="#活动的帧日志-frame-logging" class="headerlink" title="活动的帧日志(frame-logging)"></a>活动的帧日志(frame-logging)</h3><p>使用 ChirpStack Application Server，可以检查每个网关或设备的所有原始和加密的 LoRaWAN 帧。当打开网关或设备详细信息页面上的 LoRaWAN 帧标签时，将看到实时的所有帧。这也将允许您检查每个 LoRaWAN 帧的(加密)内容。</p>
<h3 id="活动的事件日志-event-logging"><a href="#活动的事件日志-event-logging" class="headerlink" title="活动的事件日志(event-logging)"></a>活动的事件日志(event-logging)</h3><p>使用 ChirpStack Application Server，可以从 Web 界面检查所有事件，而不需要使用 MQTT 客户端或构建集成。当打开实时事件日志标签上的设备详情，将看到所有实时 uplink，ack，join 和 error 事件。</p>
<h2 id="Startup"><a href="#Startup" class="headerlink" title="Startup"></a>Startup</h2><h3 id="certs-optional"><a href="#certs-optional" class="headerlink" title="certs (optional)"></a>certs (optional)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rm -rf certs&#x2F;ca</span><br><span class="line">mkdir -p certs&#x2F;ca</span><br><span class="line">cfssl gencert -initca config&#x2F;ca-csr.json | cfssljson -bare certs&#x2F;ca&#x2F;ca</span><br><span class="line"></span><br><span class="line">mkdir -p certs&#x2F;mqtt&#x2F;server</span><br><span class="line">cfssl gencert -ca certs&#x2F;ca&#x2F;ca.pem -ca-key certs&#x2F;ca&#x2F;ca-key.pem -config config&#x2F;ca-config.json -profile server config&#x2F;mqtt&#x2F;server&#x2F;certificate.json | cfssljson -bare certs&#x2F;mqtt&#x2F;server&#x2F;mqtt-server</span><br><span class="line"></span><br><span class="line">cp certs&#x2F;ca&#x2F;* ~&#x2F;codebase&#x2F;oss&#x2F;chirpstack&#x2F;mqtt&#x2F;specs&#x2F;</span><br><span class="line">cp certs&#x2F;mqtt&#x2F;server&#x2F;* ~&#x2F;codebase&#x2F;oss&#x2F;chirpstack&#x2F;mqtt&#x2F;specs&#x2F;</span><br></pre></td></tr></table></figure>
<h3 id="mosquitto"><a href="#mosquitto" class="headerlink" title="mosquitto"></a>mosquitto</h3><p><a target="_blank" rel="noopener" href="https://mosquitto.org/">https://mosquitto.org/</a></p>
<blockquote>
<p>mosquitto mqtt-broker</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -p 11883:1883 -p 19001:9001 -v ./oss/chirpstack/mqtt/mosquitto.conf:/mosquitto/config/mosquitto.conf -v ./oss/chirpstack/mqtt/specs:/usr/local/certs --name mqtt-broker eclipse-mosquitto</span><br><span class="line"></span><br><span class="line">docker exec -it mqtt-broker sh</span><br><span class="line"></span><br><span class="line">mosquitto_sub -d -v -h mqtt-broker -p 11883 -t test --cafile /usr/local/certs/ca.pem</span><br><span class="line">mosquitto_pub -d -h mqtt-broker -p 11883 -t test -m hellomqtt --cafile /usr/local/certs/ca.pem</span><br></pre></td></tr></table></figure>
<h3 id="chirpstack-docker"><a href="#chirpstack-docker" class="headerlink" title="chirpstack-docker"></a>chirpstack-docker</h3><p><a target="_blank" rel="noopener" href="https://github.com/brocaar/chirpstack-docker">https://github.com/brocaar/chirpstack-docker</a></p>
<blockquote>
<p>docker-compose.yml</p>
<p>chirpstack-application-server.toml</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd chirpstack-docker</span><br><span class="line"></span><br><span class="line">docker-compose up</span><br><span class="line">docker-compose rm</span><br></pre></td></tr></table></figure>
<h3 id="chirpstack-simulator"><a href="#chirpstack-simulator" class="headerlink" title="chirpstack-simulator"></a>chirpstack-simulator</h3><h4 id="Download"><a href="#Download" class="headerlink" title="Download"></a>Download</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;brocaar&#x2F;chirpstack-simulator</span><br></pre></td></tr></table></figure>
<h4 id="Build"><a href="#Build" class="headerlink" title="Build"></a>Build</h4><p>解决 proxy.golang.org 无法访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go env -w GOPROXY&#x3D;https:&#x2F;&#x2F;goproxy.cn</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go build -a -installsuffix cgo -ldflags &quot;-s -w -X main.version&#x3D;37a7e02&quot; -o build&#x2F;chirpstack-simulator cmd&#x2F;chirpstack-simulator&#x2F;main.go</span><br></pre></td></tr></table></figure>
<h4 id="Startup-1"><a href="#Startup-1" class="headerlink" title="Startup"></a>Startup</h4><p><code>chirpstack-simulator.toml</code> (修改配置文件，用于自动创建设备及模拟设备感知数据)</p>
<ul>
<li>jwt_token (Application Server API Keys)</li>
<li>service_profile_id (Application Server Service Profile)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;build&#x2F;chirpstack-simulator -c chirpstack-simulator.toml</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/22/redisgears-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="shankai">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="零壹">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/22/redisgears-notes/" class="post-title-link" itemprop="url">RedisGears 笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-22 14:24:44" itemprop="dateCreated datePublished" datetime="2021-04-22T14:24:44+08:00">2021-04-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-30 15:06:40" itemprop="dateModified" datetime="2021-04-30T15:06:40+08:00">2021-04-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NoSQL/" itemprop="url" rel="index"><span itemprop="name">NoSQL</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>20 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>RedisGears 版本: <code>v1.0</code></p>
<h2 id="Home"><a href="#Home" class="headerlink" title="Home"></a>Home</h2><blockquote>
<p>RedisGears -  Redis 中数据处理的可编程引擎。</p>
</blockquote>
<p>RedisGears 是一个 Serverless 的引擎，用于处理 Redis 中的事务、批处理和事件驱动的数据。它是一个动态的执行函数的框架，而这些函数反过来又实现了 Redis 的数据流，同时(几乎)完全抽象了数据的分布和部署的选择(如单机vs集群，OSS vs企业级)。函数可以用不同的语言实现，包括 Python and C APIs。</p>
<h3 id="Diagram-Components"><a href="#Diagram-Components" class="headerlink" title="Diagram Components"></a>Diagram Components</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">+---------------------------------------------------------------------+</span><br><span class="line">| Redis Server               +--------------------------------------+ |</span><br><span class="line">|                            | RedisGears Module                    | |</span><br><span class="line">| +----------------+         |                                      | |</span><br><span class="line">| | Data           | Input   | +------------+ +-------------------+ | |</span><br><span class="line">| |                +--------&gt;+ | Function   | | APIs              | | |</span><br><span class="line">| | Key1 : Value1  |         | | +--------+ | | C, Python, ...    | | |</span><br><span class="line">| | Key2 : Value2  | Output  | | | Reader | | +-------------------+ | |</span><br><span class="line">| | Key3 : Value3  &lt;---------+ | +---+----+ | +-------------------+ | |</span><br><span class="line">| |      ...       |         | |     v      | | Redis commands    | | |</span><br><span class="line">| +----------------+         | | +---+----+ | | Gears admin &amp; ops | | |</span><br><span class="line">|                            | | | Step 1 | | +-------------------+ | |</span><br><span class="line">|                            | | +---+----+ | +-------------------+ | |</span><br><span class="line">| +----------------+         | |     v      | | Coordinator       | | |</span><br><span class="line">| | Events         |         | | +---+----+ | | Cluster MapReduce | | |</span><br><span class="line">| |                | Trigger | | | Step 2 | | +-------------------+ | |</span><br><span class="line">| | Data update    +--------&gt;+ | +---+----+ | +-------------------+ | |</span><br><span class="line">| | Stream message |         | |     v      | | Engine            | | |</span><br><span class="line">| | Time interval  |         | |    ...     | | Runtime execution | | |</span><br><span class="line">| |      ...       |         | +------------+ +-------------------+ | |</span><br><span class="line">| +----------------+         +--------------------------------------+ |</span><br><span class="line">+---------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>


<h2 id="Quickstart"><a href="#Quickstart" class="headerlink" title="Quickstart"></a>Quickstart</h2><h3 id="RedisGears-Cluster"><a href="#RedisGears-Cluster" class="headerlink" title="RedisGears Cluster"></a>RedisGears Cluster</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 30001:30001 -p 30002:30002 -p 30003:30003 redislabs&#x2F;rgcluster:latest</span><br></pre></td></tr></table></figure>


<h3 id="RedisGears-Standalone"><a href="#RedisGears-Standalone" class="headerlink" title="RedisGears Standalone"></a>RedisGears Standalone</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> run</span> </span><br><span class="line">docker run -d --name redisgears -p 6379:6379 redislabs/redisgears:latest</span><br><span class="line"><span class="meta">#</span><span class="bash"> redis-cli</span> </span><br><span class="line">docker exec -it redisgears redis-cli</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">function</span></span></span><br><span class="line">RG.PYEXECUTE &quot;GearsBuilder().run()&quot;</span><br></pre></td></tr></table></figure>


<p><code>RG</code> 是 <code>GearsBuilder()</code> 的别名。</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><h3 id="Reader"><a href="#Reader" class="headerlink" title="Reader"></a>Reader</h3><ul>
<li>KeysReader</li>
</ul>
<h3 id="Keys-Pattern"><a href="#Keys-Pattern" class="headerlink" title="Keys Pattern"></a>Keys Pattern</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RG.PYEXECUTE &quot;GearsBuilder().run(&#39;person:*&#39;)&quot;</span><br></pre></td></tr></table></figure>


<h3 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h3><h4 id="执行复杂函数"><a href="#执行复杂函数" class="headerlink" title="执行复杂函数"></a>执行复杂函数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat mygear.py | docker exec -i redisgears redis-cli -x RG.PYEXECUTE</span><br></pre></td></tr></table></figure>


<h4 id=""><a href="#" class="headerlink" title=""></a></h4><ul>
<li><p><code>filter</code></p>
</li>
<li><p><code>map</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gb = GearsBuilder()                       # declare a function builder</span><br><span class="line">gb.map(lambda x: int(x[&#x27;value&#x27;][&#x27;age&#x27;]))  # map each record to just an age</span><br><span class="line">gb.run(&#x27;person:*&#x27;)                        # run it</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Expected result: [70, 14]</span></span></span><br></pre></td></tr></table></figure>

</li>
<li><p><code>accumulate</code></p>
</li>
</ul>
<h3 id="Blocking-vs-Nonblocking-Execution"><a href="#Blocking-vs-Nonblocking-Execution" class="headerlink" title="Blocking vs. Nonblocking Execution"></a>Blocking vs. Nonblocking Execution</h3><h4 id="UNBLOCKING"><a href="#UNBLOCKING" class="headerlink" title="UNBLOCKING"></a>UNBLOCKING</h4><blockquote>
<p>非阻塞模式执行</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; RG.PYEXECUTE &quot;GB().run()&quot; UNBLOCKING</span><br><span class="line">&quot;0000000000000000000000000000000000000000-0&quot;</span><br></pre></td></tr></table></figure>
<h4 id="RG-DUMPEXECUTIONS"><a href="#RG-DUMPEXECUTIONS" class="headerlink" title="RG.DUMPEXECUTIONS"></a>RG.DUMPEXECUTIONS</h4><blockquote>
<p>执行状态</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; RG.DUMPEXECUTIONS</span><br><span class="line">1) 1) &quot;executionId&quot;</span><br><span class="line">   2) &quot;0000000000000000000000000000000000000000-0&quot;</span><br><span class="line">   3) &quot;status&quot;</span><br><span class="line">   4) &quot;done&quot;</span><br></pre></td></tr></table></figure>
<h4 id="RG-GETRESULTS"><a href="#RG-GETRESULTS" class="headerlink" title="RG.GETRESULTS"></a>RG.GETRESULTS</h4><blockquote>
<p>获取结果</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; RG.GETRESULTS 0000000000000000000000000000000000000000-0</span><br><span class="line">1) 1) &quot;&#123;&#x27;key&#x27;: &#x27;foo&#x27;, &#x27;value&#x27;: &#x27;bar&#x27;&#125;&quot;</span><br><span class="line">   2) &quot;&#123;&#x27;key&#x27;: &#x27;person:1&#x27;, &#x27;value&#x27;: &#123;&#x27;age&#x27;: &#x27;70&#x27;, &#x27;name&#x27;: &#x27;Rick Sanchez&#x27;&#125;&#125;&quot;</span><br><span class="line">   3) &quot;&#123;&#x27;key&#x27;: &#x27;person:2&#x27;, &#x27;value&#x27;: &#123;&#x27;age&#x27;: &#x27;14&#x27;, &#x27;name&#x27;: &#x27;Morty Smith&#x27;&#125;&#125;&quot;</span><br><span class="line">2) (empty list or set)</span><br></pre></td></tr></table></figure>
<h4 id="RG-GETRESULTSBLOCKING"><a href="#RG-GETRESULTSBLOCKING" class="headerlink" title="RG.GETRESULTSBLOCKING"></a>RG.GETRESULTSBLOCKING</h4><blockquote>
<p>转入阻塞模式，等待结果</p>
</blockquote>
<h3 id="Event-Processing"><a href="#Event-Processing" class="headerlink" title="Event Processing"></a>Event Processing</h3><blockquote>
<p>默认是非阻塞执行</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gb.register()</span><br><span class="line">RG.DUMPEXECUTIONS      ## 执行状态</span><br><span class="line">RG.GETRESULTS          ## 获取结果</span><br></pre></td></tr></table></figure>


<h3 id="Writing-Data"><a href="#Writing-Data" class="headerlink" title="Writing Data"></a>Writing Data</h3><blockquote>
<p>execute()</p>
<p>RedisGears Python API 附带 execute ()函数，该函数允许在数据库中执行任意 Redis 命令。</p>
</blockquote>
<h3 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name rgcluster -p 30001:30001 -p 30002:30002 -p 30003:30003 redislabs/rgcluster:latest</span><br><span class="line"></span><br><span class="line">docker exec -i rgcluster redis-cli -c -p 30001 &lt; data.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认情况下，cli 不遵循集群的重定向。要让 cli 自动在分片之间跳转，请使用 -c 命令行开关启动它。</span></span><br></pre></td></tr></table></figure>
<p>data.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SET foo bar</span><br><span class="line">HSET person:1 name &quot;Rick Sanchez&quot; age 70</span><br><span class="line">HSET person:2 name &quot;Morty Smith&quot; age 14</span><br><span class="line">HSET person:3 name &quot;Summer Smith&quot; age 17</span><br><span class="line">HSET person:4 name &quot;Beth Smith&quot; age 35</span><br><span class="line">HSET person:5 name &quot;Shrimply Pibbles&quot; age 87</span><br></pre></td></tr></table></figure>


<h3 id="Distributed-Processing"><a href="#Distributed-Processing" class="headerlink" title="Distributed Processing"></a>Distributed Processing</h3><blockquote>
<p>当 RedisGears 在集群中运行时，默认情况下它将在集群的所有分片上执行函数。通过向 run ()操作提供 collect = False 参数来禁用。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:30001&gt; RG.PYEXECUTE &quot;GB().run(collect=False)&quot;</span><br><span class="line">1) 1) &quot;&#123;&#x27;key&#x27;: &#x27;person:1&#x27;, &#x27;value&#x27;: &#123;&#x27;age&#x27;: &#x27;70&#x27;, &#x27;name&#x27;: &#x27;Rick Sanchez&#x27;&#125;&#125;&quot;</span><br><span class="line">   2) &quot;&#123;&#x27;key&#x27;: &#x27;person:5&#x27;, &#x27;value&#x27;: &#123;&#x27;age&#x27;: &#x27;87&#x27;, &#x27;name&#x27;: &#x27;Shrimply Pibbles&#x27;&#125;&#125;&quot;</span><br><span class="line">2) (empty list or set)</span><br></pre></td></tr></table></figure>


<h3 id="MapReduce"><a href="#MapReduce" class="headerlink" title="MapReduce"></a>MapReduce</h3><h3 id="Cluster-Map-and-Reduce"><a href="#Cluster-Map-and-Reduce" class="headerlink" title="Cluster Map and Reduce"></a>Cluster Map and Reduce</h3><blockquote>
<p>accumulate-collect，这种情况只会将每个分片的最大值收集起来</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">def maximum(a, x):</span><br><span class="line">  &#x27;&#x27;&#x27; Returns the maximum &#x27;&#x27;&#x27;</span><br><span class="line">  a = a if a else 0       # initialize the accumulator</span><br><span class="line">  return max(a, x)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Original, non-reduced, maximum <span class="keyword">function</span> version</span></span><br><span class="line">gb = GearsBuilder()</span><br><span class="line">gb.map(lambda x: int(x[&#x27;value&#x27;][&#x27;age&#x27;]))</span><br><span class="line">gb.accumulate(maximum)</span><br><span class="line">gb.run(&#x27;person:*&#x27;)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Expected result: [87, 35, 14]</span></span></span><br></pre></td></tr></table></figure>


<blockquote>
<p> accumulate-collect-accumulate，这种情况会将所有分片的最大值收集起来后再计算最大值，得到最佳结果（1 个最大值）</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">def maximum(a, x):</span><br><span class="line">  &#x27;&#x27;&#x27; Returns the maximum &#x27;&#x27;&#x27;</span><br><span class="line">  a = a if a else 0       # initialize the accumulator</span><br><span class="line">  return max(a, x)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Reduced maximum <span class="keyword">function</span></span></span><br><span class="line">gb = GearsBuilder()</span><br><span class="line">gb.map(lambda x: int(x[&#x27;value&#x27;][&#x27;age&#x27;]))</span><br><span class="line">gb.accumulate(maximum)</span><br><span class="line">gb.collect()</span><br><span class="line">gb.accumulate(maximum)</span><br><span class="line">gb.run(&#x27;person:*&#x27;)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Expected result: [87]</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>aggregate()</p>
</blockquote>
<p>RedisGears Python API 包含 <code>aggregate()</code> 操作，该操作将<code>accumulate-collect-accumulate</code>步骤包装为单个步骤：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Aggregated maximum version</span></span><br><span class="line">gb = GearsBuilder()</span><br><span class="line">gb.map(lambda x: int(x[&#x27;value&#x27;][&#x27;age&#x27;]))</span><br><span class="line">gb.aggregate(0,</span><br><span class="line">             lambda a, x: max(a, x),</span><br><span class="line">             lambda a, x: max(a, x))</span><br><span class="line">gb.run(&#x27;person:*&#x27;)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Expected result: [87]</span></span></span><br></pre></td></tr></table></figure>
<p><code>aggregate()</code> 接受三个参数: 第一个是累加器的零值，另外两个是对累加函数的回调，这些函数将分别在本地和全局执行。</p>
<h3 id="Local-vs-Global"><a href="#Local-vs-Global" class="headerlink" title="Local vs. Global"></a>Local vs. Global</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">localgroupby  ## 由每个分片的引擎在本地执行</span><br><span class="line">groupby       ## 将结果重新分区，再由每个分片的引擎在本地执行 &#x3D; repartition + localgroupby</span><br></pre></td></tr></table></figure>


<h4 id="Diagram-localgroupby-groupby"><a href="#Diagram-localgroupby-groupby" class="headerlink" title="Diagram(localgroupby, groupby)"></a>Diagram(localgroupby, groupby)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">+----------------------+   +----------------------+   +----------------------+</span><br><span class="line">| Shard A              |   | Shard B              |   | Shard C              |</span><br><span class="line">| +----------+-------+ |   | +----------+-------+ |   | +----------+-------+ |</span><br><span class="line">| | Key      | Value | |   | | Key      | Value | |   | | Key      | Value | |</span><br><span class="line">| +------------------+ |   | +------------------+ |   | +------------------+ |</span><br><span class="line">| | person:1 | &#123;...&#125; | |   | | person:3 | &#123;...&#125; | |   | | foo      | bar   | |</span><br><span class="line">| | person:5 | &#123;...&#125; | |   | | person:4 | &#123;...&#125; | |   | | person:2 | &#123;...&#125; | |</span><br><span class="line">| +-+--------+-------+ |   | +-+--------+-------+ |   | +-+--------+-------+ |</span><br><span class="line">|   v localgroupby()   |   |   v localgroupby()   |   |   v localgroupby()   |</span><br><span class="line">| +-+--------+-------+ |   | +-+--------+-------+ |   | +-+--------+-------+ |</span><br><span class="line">| | Key      | Value | |   | | Key      | Value | |   | | Key      | Value | |</span><br><span class="line">| +------------------+ |   | +------------------+ |   | +------------------+ |</span><br><span class="line">| | Sanchez  | 1     | |   | | Smith    | 2     | |   | | Smith    | 1     | |</span><br><span class="line">| | Pibbles  | 1     | |   | +-+----------------+ |   | +-+----------------+ |</span><br><span class="line">| +-+--------+-------+ |   |                      |   |                      |</span><br><span class="line">+----------------------+   +----------------------+   +----------------------+</span><br><span class="line">|   v repartition()    |   |   v repartition()    |   |   v repartition()    |</span><br><span class="line">| +-+--------+-------+ |   | +-+--------+-------+ |   | +-+--------+-------+ |</span><br><span class="line">| | Key      | Value | |   | | Key      | Value | |   | | Key      | Value | |</span><br><span class="line">| +------------------+ |   | +------------------+ |   | +------------------+ |</span><br><span class="line">| | Pibbles  | 1     | |   | | Sanchez  | 1     | |   | | Smith    | 2     | |</span><br><span class="line">| +------------------+ |   | +------------------+ |   | | Smith    | 1     | |</span><br><span class="line">|                      |   |                      |   | +------------------+ |</span><br><span class="line">|   v localgroupby()   |   |   v localgroupby()   |   |   v localgroupby()   |</span><br><span class="line">| +-+--------+-------+ |   | +-+--------+-------+ |   | +-+--------+-------+ |</span><br><span class="line">| | Key      | Value | |   | | Key      | Value | |   | | Key      | Value | |</span><br><span class="line">| +------------------+ |   | +------------------+ |   | +------------------+ |</span><br><span class="line">| | Pibbles  | 1     | |   | | Sanchez  | 1     | |   | | Smith    | 3     | |</span><br><span class="line">| +------------------+ |   | +------------------+ |   | +------------------+ |</span><br><span class="line">|                      |   +---|------------------+   +---|------------------+</span><br><span class="line">|                      |       |                          |</span><br><span class="line">| +-+--------+-------+ |       |   Implicit collect()     |</span><br><span class="line">| | Key      | Value |&lt;--------+--------------------------+</span><br><span class="line">| +------------------+ |</span><br><span class="line">| | Sanchez  | 1     | |</span><br><span class="line">| | Pibbles  | 1     | |</span><br><span class="line">| | Smith    | 3     | |</span><br><span class="line">| +------------------+ |</span><br><span class="line">+----------------------+</span><br></pre></td></tr></table></figure>


<p>当绝对需要时，函数可以使用任意键对集群中的数据进行重新分区。当数据被重新分区时，每个工作线程被分配一个记录键的子集，并且这些键从所有其他工作线程传递到它。</p>
<h4 id="Mock-localgroupby-repartition-localgroupby"><a href="#Mock-localgroupby-repartition-localgroupby" class="headerlink" title="Mock(localgroupby, repartition, localgroupby)"></a>Mock(localgroupby, repartition, localgroupby)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">def fname(x):</span><br><span class="line">  &#39;&#39;&#39; Extracts the family name from a person&#39;s record &#39;&#39;&#39;</span><br><span class="line">  return x[&#39;value&#39;][&#39;name&#39;].split(&#39; &#39;)[1]</span><br><span class="line"></span><br><span class="line">def key(x):</span><br><span class="line">  &#39;&#39;&#39; Extracts the key of a record &#39;&#39;&#39;</span><br><span class="line">  return x[&#39;key&#39;]</span><br><span class="line"></span><br><span class="line">def counter(k, a, r):</span><br><span class="line">  &#39;&#39;&#39; Counts records &#39;&#39;&#39;</span><br><span class="line">  return (a if a else 0) + 1</span><br><span class="line"></span><br><span class="line">def summer(k, a, r):</span><br><span class="line">  &#39;&#39;&#39; Sums record values &#39;&#39;&#39;</span><br><span class="line">  return (a if a else 0) + r[&#39;value&#39;]</span><br><span class="line"></span><br><span class="line"># Repartition for storing counts</span><br><span class="line">gb &#x3D; GearsBuilder()</span><br><span class="line">gb.localgroupby(fname, counter)</span><br><span class="line">gb.repartition(key)</span><br><span class="line">gb.localgroupby(key, summer)</span><br><span class="line">gb.foreach(lambda x: execute(&#39;SET&#39;, x[&#39;key&#39;], x[&#39;value&#39;]))</span><br><span class="line">gb.run(&#39;person:*&#39;)</span><br><span class="line"></span><br><span class="line"># Expected result: the same + stored in Redis String keys</span><br></pre></td></tr></table></figure>
<p><strong>RedisGears 的 Python API 包含了 aggregateby ()操作，它等同于使用 GB () . localgroupby () . repartition () . localgroupby ()流。</strong></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><h3 id="Runtime"><a href="#Runtime" class="headerlink" title="Runtime"></a>Runtime</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/runtime.html">https://oss.redislabs.com/redisgears/runtime.html</a></p>
</blockquote>
<p>Python RedisGears 函数使用嵌入式 Python 解释器运行。每个函数都使用一个单独的子解释器。所有函数共享相同的环境和依赖关系。导入的环境有几个默认值。</p>
<h4 id="Python-Interpreter"><a href="#Python-Interpreter" class="headerlink" title="Python Interpreter"></a>Python Interpreter</h4><p>embeds python 3.7.2+</p>
<h4 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h4><p>解释器的环境可以用任何依赖的包进行扩展，这些包以后可以被它们各自的子解释器中的函数导入和使用。</p>
<h4 id="GearsBuilder"><a href="#GearsBuilder" class="headerlink" title="GearsBuilder"></a>GearsBuilder</h4><p>默认环境提供的函数上下文构造器。</p>
<h4 id="execute"><a href="#execute" class="headerlink" title="execute"></a>execute</h4><p>执行命令函数，默认环境提供的执行 Redis 命令的函数。</p>
<h5 id="Python-API"><a href="#Python-API" class="headerlink" title="Python API"></a>Python API</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute</span>(<span class="params">command, *args</span>)</span></span><br></pre></td></tr></table></figure>
<h5 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Pings the server (reply should be &#x27;PONG&#x27;)</span></span><br><span class="line">reply = execute(<span class="string">&#x27;PING&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h4 id="atomic"><a href="#atomic" class="headerlink" title="atomic"></a>atomic</h4><p>原子操作函数，上下文通过阻塞主 Redis 进程来确保它中的所有操作都以原子的方式执行。</p>
<h5 id="Python-API-1"><a href="#Python-API-1" class="headerlink" title="Python API"></a>Python API</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">atomic</span>()</span></span><br></pre></td></tr></table></figure>
<h5 id="Examples-1"><a href="#Examples-1" class="headerlink" title="Examples"></a>Examples</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Increments two keys atomically</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transaction</span>(<span class="params">_</span>):</span></span><br><span class="line">    <span class="keyword">with</span> atomic():</span><br><span class="line">        execute(<span class="string">&#x27;INCR&#x27;</span>, <span class="string">f&#x27;&#123;&#123;<span class="subst">&#123;hashtag()&#125;</span>&#125;&#125;:foo&#x27;</span>)</span><br><span class="line">        execute(<span class="string">&#x27;INCR&#x27;</span>, <span class="string">f&#x27;&#123;&#123;<span class="subst">&#123;hashtag()&#125;</span>&#125;&#125;:bar&#x27;</span>)</span><br><span class="line"></span><br><span class="line">gb = GB(<span class="string">&#x27;ShardsIDReader&#x27;</span>)</span><br><span class="line">gb.foreach(transaction)</span><br><span class="line">gb.run()</span><br></pre></td></tr></table></figure>
<h4 id="configGet"><a href="#configGet" class="headerlink" title="configGet"></a>configGet</h4><p>这个函数获取 RedisGears 配置选项的当前值。</p>
<h4 id="gearsConfigGet"><a href="#gearsConfigGet" class="headerlink" title="gearsConfigGet"></a>gearsConfigGet</h4><p>这个函数获取RedisGears配置选项的当前值，如果该键不存在，则返回默认值。</p>
<h4 id="hashtag"><a href="#hashtag" class="headerlink" title="hashtag"></a>hashtag</h4><p>这个函数返回一个 hashtag，该 hashtag 映射到本地引擎的分片所服务的最低哈希槽。换句话说，它作为一个 hashtag 在集群中进行分区时非常有用。</p>
<h4 id="log"><a href="#log" class="headerlink" title="log"></a>log</h4><p>这个函数打印一条消息到Redis的日志中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span>(<span class="params">message, level=<span class="string">&#x27;notice&#x27;</span></span>)</span></span><br></pre></td></tr></table></figure>
<p><code>level</code> 取值 <code>debug</code>,<code>verbose</code>,<code>notice</code>,<code>warning</code></p>
<h3 id="Functions"><a href="#Functions" class="headerlink" title="Functions"></a>Functions</h3><p>RedisGears 函数是数据流中处理步骤的正式描述。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">                  +------------+</span><br><span class="line">                  | Function   |</span><br><span class="line">+-------------+   | +--------+ |</span><br><span class="line">| Input data  +--&gt;+ | Reader | |</span><br><span class="line">+-------------+   | +---+----+ |</span><br><span class="line">                  |     v      |</span><br><span class="line">                  | +---+----+ |</span><br><span class="line">                  | | Step 1 | |</span><br><span class="line">                  | +---+----+ |</span><br><span class="line">                  |     |      |</span><br><span class="line">                  |    ...     |</span><br><span class="line">                  |     v      |</span><br><span class="line">                  | +---+----+ |</span><br><span class="line">                  | | Step n | |</span><br><span class="line">                  | +---+----+ |</span><br><span class="line">                  |     v      |</span><br><span class="line">+-------------+   | +---+----+ |</span><br><span class="line">| Results     +&lt;--+ | Action | |</span><br><span class="line">+-------------+   | +--------+ |</span><br><span class="line">                  +------------+</span><br></pre></td></tr></table></figure>
<p>一个函数总是：</p>
<ol>
<li>始于一个 Reader</li>
<li>操作零个或多个 Records</li>
<li>包含零个或多个 Operations (Step)</li>
<li>终于一个 Action</li>
<li>返回零个或多个 Results</li>
<li>可能会产生更多错误。</li>
</ol>
<h4 id="Execution"><a href="#Execution" class="headerlink" title="Execution"></a>Execution</h4><p>一个函数由 RedisGears 引擎以以下两种方式之一执行:</p>
<ul>
<li><code>Batch</code> 立即执行，对已有数据执行</li>
<li><code>Event</code>由新事件及其数据触发执行</li>
</ul>
<p>函数的执行方式是由它的动作决定的。有两种类型的行动:</p>
<ul>
<li><code>Run</code> 批量运行函数</li>
<li><code>Register</code> 注册由事件触发的函数</li>
</ul>
<p>当以批处理或事件的形式执行时，函数的上下文由引擎管理。除了函数的逻辑之外，上下文还包括内部执行步骤、状态、统计数据、结果和遇到的任何错误。</p>
<h4 id="Execution-ID"><a href="#Execution-ID" class="headerlink" title="Execution ID"></a>Execution ID</h4><p>每个函数的执行都在内部分配了一个惟一的值，称为 <code>Execution ID</code>。</p>
<p>ID 是由两部分组成的字符串值，以“-”分隔，如下所示:</p>
<ul>
<li><code>Shard ID</code> 集群中一个 Shard 的标识符，长度为40个字节</li>
<li><code>Sequence</code> 一个不断增加的计数器</li>
</ul>
<p><code>Execution ID</code>示例：</p>
<p>Redis Standalone Mode: <code>0000000000000000000000000000000000000000-1</code></p>
<p>Redis Cluster Mode: <code>a007297351b007297351c007297351d007297351-1</code></p>
<h4 id="Execution-Plan"><a href="#Execution-Plan" class="headerlink" title="Execution Plan"></a>Execution Plan</h4><p>在执行该功能之前，引擎会生成一个执行计划。该计划包含引擎执行功能将采取的基本步骤。</p>
<h4 id="Execution-Parallelization"><a href="#Execution-Parallelization" class="headerlink" title="Execution Parallelization"></a>Execution Parallelization</h4><p>在集群中执行时，执行计划由启动器生成。然后，默认情况下，它将在所有碎片上共享并并行执行。</p>
<p>发起者的协调器协调分布式操作。</p>
<h4 id="Execution-Status"><a href="#Execution-Status" class="headerlink" title="Execution Status"></a>Execution Status</h4><p><code>Execution Status</code>描述了功能当前的执行状态。它可以是以下几种之一：<br><code>created</code> 已创建<br><code>running</code> 正在执行<br><code>done</code>执行完成<br><code>aborted</code>执行被终止<br><code>pending_cluster</code>启动器正在等待所有 Worker 执行完成<br><code>pending_run</code>Worker 挂起等待启动器确认执行<br><code>pending_receive</code>启动器在接收执行时挂起 Worker 的确认(ACK)<br><code>pending_termination</code>Worker 正在等待来自启动器的终止消息</p>
<p>下图演示了状态转换：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">       Initiator                                  Worker</span><br><span class="line">+---------------------+  execution plan   +---------------------+</span><br><span class="line">|             created +------------------&gt;+ created             |</span><br><span class="line">+----------+----------+                   +----------+----------+</span><br><span class="line">           v                                         v</span><br><span class="line">+----------+----------+  acknowledgement  +----------+----------+</span><br><span class="line">|     pending_receive +&lt;------------------+ pending_run         |</span><br><span class="line">+----------+----------+                   +---------------------+</span><br><span class="line">           v</span><br><span class="line">+----------+----------+  start execution  +---------------------+</span><br><span class="line">|             running +------------------&gt;+ running             |</span><br><span class="line">+----------+----------+                   +----------+----------+</span><br><span class="line">           v                                         v</span><br><span class="line">+----------+----------+      results      +----------+----------+</span><br><span class="line">|     pending_cluster +&lt;------------------+ pending_termination |</span><br><span class="line">+----------+----------+                   +---------------------+</span><br><span class="line">           v</span><br><span class="line">+----------+----------+     terminate     +---------------------+</span><br><span class="line">|                done +------------------&gt;+ done                |</span><br><span class="line">+---------------------+                   +---------------------+</span><br></pre></td></tr></table></figure>
<h4 id="Registration"><a href="#Registration" class="headerlink" title="Registration"></a>Registration</h4><p>事件驱动函数的表示称为注册(Registration)。</p>
<p>注册被持久化在 Redis 的快照中，也就是 RDB 文件中。这允许在发生故障时恢复数据库中的数据和事件处理程序。</p>
<h4 id="Registration-ID"><a href="#Registration-ID" class="headerlink" title="Registration ID"></a>Registration ID</h4><p>每个注册都有一个唯一的内部标识符，称为 <code>Registration ID</code>。它以与 <code>Execution ID</code> 相同的方式生成，尽管看起来相同，但两者不应该混淆。</p>
<h4 id="Context-Builder"><a href="#Context-Builder" class="headerlink" title="Context Builder"></a>Context Builder</h4><p>Python 中的 RedisGears 函数总是以一个上下文构建器——<code>GearsBuilder</code> 类开始。</p>
<h4 id="Actions"><a href="#Actions" class="headerlink" title="Actions"></a>Actions</h4><p>动作 (<code>Action</code>) 是一种特殊类型的操作。它总是函数的最后一步。</p>
<h5 id="Run"><a href="#Run" class="headerlink" title="Run"></a>Run</h5><p><code>Run</code>动作作为批处理(<code>Batch</code>)运行函数。函数只执行一次，一旦读取器耗尽数据就退出。</p>
<h6 id="Python-API-2"><a href="#Python-API-2" class="headerlink" title="Python API"></a>Python API</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GearsBuilder</span>.<span class="title">run</span>(<span class="params">arg=<span class="literal">None</span>, convertToStr=<span class="literal">True</span>, collect=<span class="literal">True</span></span>)</span></span><br></pre></td></tr></table></figure>
<p>Arguments</p>
<ul>
<li>arg<ul>
<li>一个类似于全局的模式，用于 <code>KeysReader</code> 和 <code>KeysOnlyReader</code></li>
<li><code>StreamReader</code> 的密钥名称</li>
<li>用于 <code>PythonReader</code> 的 Python 生成器</li>
</ul>
</li>
<li>convertToStr 当为 <code>true</code>时将在流程末尾添加一个 <code>map</code>操作，用于字符串化记录</li>
<li>collect 当为 <code>true</code> 时将在流程末尾添加一个 <code>collect</code> 操作</li>
</ul>
<h5 id="Register"><a href="#Register" class="headerlink" title="Register"></a>Register</h5><p>Register 操作将函数注册为事件处理程序。每次有事件出现时都执行该函数。每次执行时，函数对事件的数据进行操作，完成后将暂停，直到新事件调用它。</p>
<h6 id="Python-API-3"><a href="#Python-API-3" class="headerlink" title="Python API"></a>Python API</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GearsBuilder</span>.<span class="title">register</span>(<span class="params">convertToStr=<span class="literal">True</span>, collect=<span class="literal">True</span>, mode=<span class="string">&#x27;async&#x27;</span>, onRegistered=<span class="literal">None</span></span>)</span></span><br></pre></td></tr></table></figure>
<p>Arguments</p>
<ul>
<li>convertToStr 当为 <code>true</code>时将在流程末尾添加一个 <code>map</code>操作，用于字符串化记录</li>
<li>collect 当为 <code>true</code> 时将在流程末尾添加一个 <code>collect</code> 操作</li>
<li>mode 触发函数的执行方式。可以是：<ul>
<li><code>async</code> 在整个集群中异步执行</li>
<li><code>async_local</code>执行将是异步的，并且仅限于处理分片</li>
<li><code>sync</code>本地同步执行</li>
</ul>
</li>
<li>onRegistered 一个函数回调函数，在每个shard上注册函数时被调用。这是初始化非序列化对象(如网络连接)的好地方。</li>
</ul>
<p><strong>注意，可以将更多参数传递给 register函数，这些参数取决于 reader，详见 Readers 说明。</strong></p>
<h4 id="Results"><a href="#Results" class="headerlink" title="Results"></a>Results</h4><p>函数的执行产生零条或多条结果记录。结果由函数最后一次操作和最后一次操作之前的任何记录组成。</p>
<p>结果存储在函数的执行上下文中。</p>
<h3 id="Readers"><a href="#Readers" class="headerlink" title="Readers"></a>Readers</h3><p>Reader 是任何 RedisGears 函数必须执行的第一步，每个函数都有一个 Reader。Reader 读取数据并从中生成输入记录(Input)。输入记录由函数使用。</p>
<table>
<thead>
<tr>
<th align="left">Reader</th>
<th align="left">Output</th>
<th align="left">Batch</th>
<th align="left">Event</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/readers.html#keysreader">KeysReader</a></td>
<td align="left">Redis keys and values</td>
<td align="left"><strong>Yes</strong></td>
<td align="left"><strong>Yes</strong></td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/readers.html#keysonlyreader">KeysOnlyReader</a></td>
<td align="left">Redis keys</td>
<td align="left"><strong>Yes</strong></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/readers.html#streamreader">StreamReader</a></td>
<td align="left">Redis Stream messages</td>
<td align="left"><strong>Yes</strong></td>
<td align="left"><strong>Yes</strong></td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/readers.html#pythonreader">PythonReader</a></td>
<td align="left">Arbitrary</td>
<td align="left"><strong>Yes</strong></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/readers.html#shardsidreader">ShardsIDReader</a></td>
<td align="left">Shard ID</td>
<td align="left"><strong>Yes</strong></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/readers.html#commandreader">CommandReader</a></td>
<td align="left">Command arguments</td>
<td align="left">No</td>
<td align="left"><strong>Yes</strong></td>
</tr>
</tbody></table>
<h3 id="Operations"><a href="#Operations" class="headerlink" title="Operations"></a>Operations</h3><p>操作(Operation)是 RedisGears 函数的构建块。可采用不同的操作类型实现多种结果，满足各种数据处理需求。</p>
<p>操作可以有零个或多个参数来控制其操作。根据操作的类型参数，可以是语言原生数据类型和函数回调。</p>
<table>
<thead>
<tr>
<th align="left">Operation</th>
<th align="left">Description</th>
<th align="left">Type</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#map">Map</a></td>
<td align="left">Maps 1:1</td>
<td align="left">Local</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#flatmap">FlatMap</a></td>
<td align="left">Maps 1:N</td>
<td align="left">Local</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#foreach">ForEach</a></td>
<td align="left">Does something for each record</td>
<td align="left">Local</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#filter">Filter</a></td>
<td align="left">Filters records</td>
<td align="left">Local</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#accumulate">Accumulate</a></td>
<td align="left">Maps N:1</td>
<td align="left">Local</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#localgroupby">LocalGroupBy</a></td>
<td align="left">Groups records by key (many-to-less) <code>extractor</code> + <code>reducer</code></td>
<td align="left">Local</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#limit">Limit</a></td>
<td align="left">Limits the number of records</td>
<td align="left">Local</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#collect">Collect</a></td>
<td align="left">Shuffles all records to one engine</td>
<td align="left">Global</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#repartition">Repartition</a></td>
<td align="left">Shuffles records between all engines</td>
<td align="left">Global</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#groupby">GroupBy</a></td>
<td align="left">Groups records by key (many-to-less) <code>repartition</code>+<code>extractor</code>+<code>reducer</code></td>
<td align="left">Sugar</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#batchgroupby">BatchGroupBy</a></td>
<td align="left">Groups records by key (many-to-less)<code>repartition</code>+<code>extractor</code>+<code>batch reducer</code></td>
<td align="left">Sugar</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#sort">Sort</a></td>
<td align="left">Sorts records <code>aggregate</code>+<code>local sort</code>+<code>flatmap</code></td>
<td align="left">Sugar</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#distinct">Distinct</a></td>
<td align="left">Makes distinct records</td>
<td align="left">Sugar</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#aggregate">Aggregate</a></td>
<td align="left">Aggregates records (many-to-one) <code>accumulator</code>+<code>collect</code>+<code>accumulator</code></td>
<td align="left">Sugar</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#aggregateby">AggregateBy</a></td>
<td align="left">Aggregates records by key (many-to-less) <code>extractor</code>+<code>reducer</code>+<code>repartition</code>+<code>extractor</code>+<code>reducer</code></td>
<td align="left">Sugar</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#count">Count</a></td>
<td align="left">Counts records <code>aggregate</code>(local counting + global suming)</td>
<td align="left">Sugar</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#countby">CountBy</a></td>
<td align="left">Counts records by key <code>aggregate</code> (extractor + local counting + global suming)</td>
<td align="left">Sugar</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/operations.html#avg">Avg</a></td>
<td align="left">Computes the average <code>aggregate</code>(global sum + global count + local map)</td>
<td align="left">Sugar</td>
</tr>
</tbody></table>
<h4 id="Terminology"><a href="#Terminology" class="headerlink" title="Terminology"></a>Terminology</h4><h5 id="Local"><a href="#Local" class="headerlink" title="Local"></a>Local</h5><p>本地(Local)操作的执行是在以独立模式或集群模式部署的 RedisGears 引擎中执行的。</p>
<p>当在独立模式下使用时，只有一个引擎在本地执行所有数据上的所有操作。</p>
<p>当再集群模式下使用时，该操作将分布到所有分片。每个分片的引擎也在本地执行操作。然而，分片的引擎只能处理集群对它们进行分区的数据。</p>
<h5 id="Global"><a href="#Global" class="headerlink" title="Global"></a>Global</h5><p>全局(Global)操作只在集群 RedisGears 环境的上下文中相关。这些是收集(collect)和重分区(repartition)操作，用于在分片之间转移记录。</p>
<h5 id="Sugar"><a href="#Sugar" class="headerlink" title="Sugar"></a>Sugar</h5><p>Sugar 操作是实用程序操作。这些是通过基本操作和相关回调在内部实现的。</p>
<h5 id="Callback"><a href="#Callback" class="headerlink" title="Callback"></a>Callback</h5><p>Callback 用于在 API 所使用的语言中调用函数(回调函数)。</p>
<h5 id="Extractor"><a href="#Extractor" class="headerlink" title="Extractor"></a>Extractor</h5><p>Extractor 是一个回调函数，它接收输入记录(record)作为参数。它返回从记录中提取的值(value)。返回值应该是本机字符串(Native String)。</p>
<h5 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h5><p>Mapper 是一个回调函数，它接收输入记录(record)作为参数。它必须返回一个输出记录(record)。</p>
<h5 id="Expander"><a href="#Expander" class="headerlink" title="Expander"></a>Expander</h5><p>Expander 是一个回调函数，它接收输入记录(record)，必须返回一个或多个输出记录(record)。</p>
<h5 id="Processor"><a href="#Processor" class="headerlink" title="Processor"></a>Processor</h5><p>Processor 是一个回调函数，它接收输入记录(record)，它不该返回任何东西。</p>
<h5 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h5><p>Filter 是一个回调函数，它接收输入记录(record)，它必须返回一个布尔值(boolean)。</p>
<h5 id="Accumulator"><a href="#Accumulator" class="headerlink" title="Accumulator"></a>Accumulator</h5><p>Accumulator 是一个回调函数，它接收输入记录和累加器变量。它将输入聚集到累加器变量中，累加器变量存储函数调用之间的状态。函数必须在每次调用后返回累加器的更新值。</p>
<h5 id="Reducer"><a href="#Reducer" class="headerlink" title="Reducer"></a>Reducer</h5><p>Reducer 是一个回调函数，它接收一个键、一个输入和一个称为累加器的变量。它的执行类似于 Accumulator 回调，不同之处在于它为每个 reduced 的键维护一个累加器。</p>
<h5 id="Batch-Reducer"><a href="#Batch-Reducer" class="headerlink" title="Batch Reducer"></a>Batch Reducer</h5><p>Batch Reducer 是一个回调函数，它接收一个键和一个输入记录列表。它的执行类似于 reducer 回调，不同之处在于它的输入是一个记录列表，而不是单个记录。它将为这些记录返回一个累加器值。</p>
<hr>
<h3 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h3><p>RedisGears 是通过 Redis 客户端发送给服务器的命令来运行的。</p>
<h4 id="Registration-1"><a href="#Registration-1" class="headerlink" title="Registration"></a>Registration</h4><h5 id="RG-DUMPREGISTRATIONS"><a href="#RG-DUMPREGISTRATIONS" class="headerlink" title="RG.DUMPREGISTRATIONS"></a>RG.DUMPREGISTRATIONS</h5><blockquote>
<p>用来输出函数注册列表</p>
</blockquote>
<h5 id="RG-UNREGISTER"><a href="#RG-UNREGISTER" class="headerlink" title="RG.UNREGISTER "></a>RG.UNREGISTER <id></h5><blockquote>
<p>用来取消某个函数的注册。</p>
</blockquote>
<h4 id="EXECUTION"><a href="#EXECUTION" class="headerlink" title="EXECUTION"></a>EXECUTION</h4><h5 id="RG-PYEXECUTE-““-UNBLOCKING-REQUIREMENTS-“-…”"><a href="#RG-PYEXECUTE-““-UNBLOCKING-REQUIREMENTS-“-…”" class="headerlink" title="RG.PYEXECUTE ““ [UNBLOCKING] [REQUIREMENTS “ …”]"></a>RG.PYEXECUTE “<function>“ [UNBLOCKING] [REQUIREMENTS “<dep> …”]</h5><blockquote>
<p>用于执行 Python 函数</p>
</blockquote>
<h5 id="RG-DUMPEXECUTIONS-1"><a href="#RG-DUMPEXECUTIONS-1" class="headerlink" title="RG.DUMPEXECUTIONS"></a>RG.DUMPEXECUTIONS</h5><blockquote>
<p>用于输出函数执行列表。执行列表的长度由 <code>MaxExecutions</code>配置选项限制。</p>
</blockquote>
<h5 id="RG-GETEXECUTION-SHARD-CLUSTER"><a href="#RG-GETEXECUTION-SHARD-CLUSTER" class="headerlink" title="RG.GETEXECUTION  [SHARD|CLUSTER]"></a>RG.GETEXECUTION <id> [SHARD|CLUSTER]</h5><blockquote>
<p>用于获取函数执行细节：执行计划，步骤等</p>
</blockquote>
<h5 id="RG-GETRESULTS-1"><a href="#RG-GETRESULTS-1" class="headerlink" title="RG.GETRESULTS "></a>RG.GETRESULTS <id></h5><blockquote>
<p>用于获取函数的执行结果及错误信息</p>
</blockquote>
<h5 id="RG-GETRESULTSBLOCKING-1"><a href="#RG-GETRESULTSBLOCKING-1" class="headerlink" title="RG.GETRESULTSBLOCKING "></a>RG.GETRESULTSBLOCKING <id></h5><blockquote>
<p>取消函数在后台（UNBLOCKING）执行。取消执行的客户端被阻塞，直到函数执行结束，然后发送任何结果和错误。</p>
</blockquote>
<h5 id="RG-DROPEXECUTION"><a href="#RG-DROPEXECUTION" class="headerlink" title="RG.DROPEXECUTION "></a>RG.DROPEXECUTION <id></h5><blockquote>
<p>用于删除一个函数的执行。</p>
</blockquote>
<h5 id="RG-ABORTEXECUTION"><a href="#RG-ABORTEXECUTION" class="headerlink" title="RG.ABORTEXECUTION "></a>RG.ABORTEXECUTION <id></h5><blockquote>
<p>在运行过程中中止函数的执行。</p>
</blockquote>
<h4 id="Trigger"><a href="#Trigger" class="headerlink" title="Trigger"></a>Trigger</h4><h5 id="RG-TRIGGER-arg-…"><a href="#RG-TRIGGER-arg-…" class="headerlink" title="RG.TRIGGER  [arg …]"></a>RG.TRIGGER <trigger> [arg …]</h5><blockquote>
<p>用来触发已注册的 CommandReader 函数的执行。</p>
</blockquote>
<h4 id="Global-1"><a href="#Global-1" class="headerlink" title="Global"></a>Global</h4><h5 id="RG-CONFIGGET-…"><a href="#RG-CONFIGGET-…" class="headerlink" title="RG.CONFIGGET  […]"></a>RG.CONFIGGET <key> […]</h5><blockquote>
<p>返回一个或多个内置配置或用户定义选项的值。</p>
</blockquote>
<h5 id="RG-CONFIGSET-…"><a href="#RG-CONFIGSET-…" class="headerlink" title="RG.CONFIGSET   […]"></a>RG.CONFIGSET <key> <value> […]</h5><blockquote>
<p>设置一个或多个内置配置或用户定义选项的值。</p>
</blockquote>
<h5 id="RG-PYSTATS"><a href="#RG-PYSTATS" class="headerlink" title="RG.PYSTATS"></a>RG.PYSTATS</h5><blockquote>
<p>从 Python 解释器返回内存使用统计信息。</p>
</blockquote>
<h5 id="RG-PYDUMPREQS-version-1-0-1"><a href="#RG-PYDUMPREQS-version-1-0-1" class="headerlink" title="RG.PYDUMPREQS (version 1.0.1)"></a>RG.PYDUMPREQS (version 1.0.1)</h5><blockquote>
<p>返回所有可用 Python 依赖的列表(包含关于每个依赖的信息)。</p>
</blockquote>
<h5 id="RG-INFOCLUSTER"><a href="#RG-INFOCLUSTER" class="headerlink" title="RG.INFOCLUSTER"></a>RG.INFOCLUSTER</h5><blockquote>
<p>显示集群信息。</p>
</blockquote>
<h5 id="RG-REFRESHCLUSTER"><a href="#RG-REFRESHCLUSTER" class="headerlink" title="RG.REFRESHCLUSTER"></a>RG.REFRESHCLUSTER</h5><blockquote>
<p>刷新节点的集群拓扑视图。<strong>需要在集群的每个节点执行</strong></p>
</blockquote>
<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><p>RedisGears 提供了配置选项来控制它的操作。这些选项可以在模块启动时设置，在某些情况下也可以在运行时设置。</p>
<p><strong>Bootstrap Configuration</strong> 在加载 Redis Module 时配置，<strong>Runtime Configuration</strong> 在运行时配置（详见命令：<code>RG.CONFIGSET &lt;key&gt; &lt;value&gt; [...]</code> 、<code>RG.CONFIGGET &lt;key&gt; [...]</code>）。</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
<th>期望值</th>
<th>默认值</th>
<th>运行时可配置性</th>
</tr>
</thead>
<tbody><tr>
<td>MaxExecutions</td>
<td>MaxExecutions 配置选项控制将保存在执行列表中的最大执行次数。<br />一旦达到这个阈值，就会按照创建顺序(FIFO)从列表中删除旧的执行。<br />只有已经完成的执行(例如“完成”或“中止”状态)被删除。</td>
<td>Integer</td>
<td>1000</td>
<td>Supported</td>
</tr>
<tr>
<td>MaxExecutionsPerRegistration</td>
<td>MaxExecutionsPerRegistration 配置选项控制每个注册保存在列表中的最大执行次数。<br />一旦达到这个阈值，该注册的旧执行将按创建顺序(FIFO)从列表中删除。<br />只有已经完成的执行(例如“完成”或“中止”状态)被删除。</td>
<td>Integer</td>
<td>100</td>
<td>Supported</td>
</tr>
<tr>
<td>ProfileExecutions</td>
<td>ProfileExecutions 配置选项控制是否对执行进行分析。对性能损耗较大，建议用于调试操作。</td>
<td>0 (disabled)<br />1 (enabled)</td>
<td>0</td>
<td>Supported</td>
</tr>
<tr>
<td>PythonAttemptTraceback</td>
<td>PythonAttemptTraceback 配置选项控制引擎是否试图为 Python 运行时错误产生堆栈跟踪。</td>
<td>0 (disabled)<br />1 (enabled)</td>
<td>1</td>
<td>Supported</td>
</tr>
<tr>
<td>DownloadDeps</td>
<td>DownloadDeps 配置选项控制 RedisGears 是否会尝试下载缺少的 Python 依赖项。</td>
<td>0 (disabled)<br />1 (enabled)</td>
<td>1</td>
<td>Not Supported</td>
</tr>
<tr>
<td>DependenciesUrl</td>
<td>DependenciesUrl 配置选项控制 RedisGears 试图从何处下载其 Python 依赖项。</td>
<td>URL-like string</td>
<td>与RedisGears版本有关</td>
<td>Not Supported</td>
</tr>
<tr>
<td>DependenciesSha256</td>
<td>DependenciesSha256 配置选项指定 Python 依赖项的 SHA256 哈希值。<br />在下载依赖项之后，将验证此值，如果不匹配，将停止服务器的启动。</td>
<td>String</td>
<td>与RedisGears版本有关</td>
<td>Not Supported</td>
</tr>
<tr>
<td>PythonInstallationDir</td>
<td>PythonInstallationDir 配置选项指定了 RedisGears 的 Python 依赖项的路径。</td>
<td>String</td>
<td>/var/opt/redislabs/modules/rg</td>
<td>Not Supported</td>
</tr>
<tr>
<td>CreateVenv</td>
<td>CreateVenv 配置选项控制引擎是否创建虚拟 Python 环境。</td>
<td>0 (disabled)<br />1 (enabled)</td>
<td>0</td>
<td>Not Supported</td>
</tr>
<tr>
<td>ExecutionThreads</td>
<td>ExecutionThreads 配置选项控制将要执行的线程数。</td>
<td>Integer &gt; 0</td>
<td>3</td>
<td>Not Supported</td>
</tr>
<tr>
<td>ExecutionMaxIdleTime</td>
<td>ExecutionMaxIdleTime 配置选项控制中止执行之前的最大空闲时间(以毫秒为单位)。空闲时间意味着执行没有进展。空闲时间的主要原因是在等待来自另一个失败(即崩溃)碎片的记录时被阻塞的执行。在这种情况下，执行将在指定的时间限制后中止。当执行再次开始进行时，将重置空闲计时器。</td>
<td>Integer &gt; 0</td>
<td>5 seconds</td>
<td>Supported</td>
</tr>
<tr>
<td>PythonInstallReqMaxIdleTime<br /><strong>1.0.1</strong></td>
<td>PythonInstallReqMaxIdleTime 配置选项控制 Python 依赖安装中止之前的最大空闲时间(以毫秒为单位)。“空闲时间”表示安装没有进展。空闲时间的主要原因与ExecutionMaxIdleTime 相同。</td>
<td>Integer &gt; 0</td>
<td>30000</td>
<td>Supported</td>
</tr>
<tr>
<td>SendMsgRetries<br /><strong>1.0.1</strong></td>
<td>SendMsgRetries 配置选项控制在 RedisGears 的分片之间发送消息的最大重试次数。当消息被发送，而 shard 在确认之前断开连接，或者当它返回一个错误时，该消息将被重新发送，直到达到这个阈值。设置为0表示不限制重试次数。</td>
<td>Integer &gt;= 0</td>
<td>3</td>
<td>Supported</td>
</tr>
</tbody></table>
<h2 id="Examples-2"><a href="#Examples-2" class="headerlink" title="Examples"></a>Examples</h2><p>RedisGears Examples: <a target="_blank" rel="noopener" href="https://oss.redislabs.com/redisgears/examples.html">https://oss.redislabs.com/redisgears/examples.html</a></p>
<h2 id="Clients"><a href="#Clients" class="headerlink" title="Clients"></a>Clients</h2><p>RedisGears 是一个 Redis 模块，所以需要 Redis 客户端来操作它。任何支持发送原始 Redis 命令的客户端都可以使用。</p>
<p>Redis Clients: <a target="_blank" rel="noopener" href="https://redis.io/clients">https://redis.io/clients</a></p>
<p>RedisGears-specific clients: <a target="_blank" rel="noopener" href="https://github.com/RedisGears/redisgears-py">https://github.com/RedisGears/redisgears-py</a></p>
<h2 id="Design"><a href="#Design" class="headerlink" title="Design"></a>Design</h2><h3 id="Isolation-Technics-隔离技术"><a href="#Isolation-Technics-隔离技术" class="headerlink" title="Isolation Technics - 隔离技术"></a>Isolation Technics - 隔离技术</h3><h4 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h4><ul>
<li>全局字典(当前版本支持)</li>
<li>子解释器(当前版本出现不兼容某些库而未启用，后续版本提供开关支持</li>
</ul>
<h2 id="Samples"><a href="#Samples" class="headerlink" title="Samples"></a>Samples</h2><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><h4 id="RedisGears-Cluster-1"><a href="#RedisGears-Cluster-1" class="headerlink" title="RedisGears Cluster"></a>RedisGears Cluster</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## RedisGears Cluster</span><br><span class="line"># docker run -p 30001:30001 -p 30002:30002 -p 30003:30003 --name rgc redislabs&#x2F;rgcluster:latest</span><br><span class="line">docker run -p 30001:30001 -p 30002:30002 -p 30003:30003 --name rgc redislabs&#x2F;rgcluster:1.2.1</span><br></pre></td></tr></table></figure>


<h4 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">## mysql </span><br><span class="line">docker run --name rgmysql -e MYSQL_ROOT_PASSWORD&#x3D;root -p 3306:3306 -d mysql:8.0</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># root</span><br><span class="line">mysql -p </span><br><span class="line"># Enter password: &#96;root&#96;</span><br><span class="line"></span><br><span class="line"># show databases;</span><br><span class="line"># DROP USER &#39;rguser&#39;@&#39;%&#39;;</span><br><span class="line"></span><br><span class="line">create database rgdb;</span><br><span class="line">create user &#39;rguser&#39;@&#39;%&#39; identified by &#39;rguser&#39;;</span><br><span class="line"></span><br><span class="line"># mysql 8.0 syntax</span><br><span class="line">grant all privileges on rgdb.* TO &#39;rguser&#39;@&#39;%&#39;;</span><br><span class="line">flush privileges;</span><br><span class="line">exit;</span><br><span class="line"></span><br><span class="line">mysql -u rguser -p;</span><br><span class="line">use rgdb;</span><br><span class="line">CREATE TABLE IF NOT EXISTS &#96;person&#96;(</span><br><span class="line">   &#96;id&#96; VARCHAR(100),</span><br><span class="line">   &#96;first&#96; VARCHAR(100),</span><br><span class="line">   &#96;last&#96; VARCHAR(40),</span><br><span class="line">   &#96;age&#96; INT,</span><br><span class="line">   PRIMARY KEY ( &#96;id&#96; )</span><br><span class="line">)ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line">describe person;</span><br></pre></td></tr></table></figure>
<h4 id="Monitor-UI"><a href="#Monitor-UI" class="headerlink" title="Monitor UI"></a>Monitor UI</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">## Monitor UI</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;RedisGears&#x2F;RedisGearsMonitor.git</span><br><span class="line">cd RedisGearsMonitor</span><br><span class="line"></span><br><span class="line">npm install</span><br><span class="line">node main.js --port 30001</span><br><span class="line"></span><br><span class="line"># http:&#x2F;&#x2F;localhost:9001&#x2F;</span><br></pre></td></tr></table></figure>


<h4 id="Run-Recipe"><a href="#Run-Recipe" class="headerlink" title="Run Recipe"></a>Run Recipe</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">## run recipe</span><br><span class="line"># pip3 install gears-cli</span><br><span class="line"># gears-cli --host &lt;host&gt; --port &lt;post&gt; --password &lt;password&gt; run example.py REQUIREMENTS rgsync PyMySQL cryptography</span><br><span class="line"># gears-cli run --host localhost --port 30001 example.py REQUIREMENTS rgsync PyMySQL cryptography</span><br><span class="line"></span><br><span class="line">gears-cli run --host localhost --port 30001 example.py REQUIREMENTS git+https:&#x2F;&#x2F;gitlab.com&#x2F;shankai&#x2F;rgsync.git  PyMySQL cryptography</span><br><span class="line"></span><br><span class="line"># 这条是异常信息： failed running gear function (Failed install requirement on shard, check shard log for more info.)</span><br><span class="line"># OK 代表发布成功。</span><br><span class="line"># gears-cli run 之后，redisgears cluster 会动态加载相关模块。</span><br><span class="line"># Monitor UI 会显示 PersonsWriteBehind Registrations 相关状态信息。</span><br></pre></td></tr></table></figure>
<h5 id="example-py-WriteBehind-RGWriteThrough"><a href="#example-py-WriteBehind-RGWriteThrough" class="headerlink" title="example.py  (WriteBehind + RGWriteThrough)"></a>example.py  (WriteBehind + RGWriteThrough)</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rgsync <span class="keyword">import</span> RGWriteBehind, RGWriteThrough</span><br><span class="line"><span class="keyword">from</span> rgsync.Connectors <span class="keyword">import</span> MySqlConnector, MySqlConnection</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Create MySQL connection object</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># connection = MySqlConnection(&#x27;demouser&#x27;, &#x27;Password123!&#x27;, &#x27;localhost:3306/test&#x27;)</span></span><br><span class="line">connection = MySqlConnection(<span class="string">&#x27;rguser&#x27;</span>, <span class="string">&#x27;rguser&#x27;</span>, <span class="string">&#x27;localhost:3306/rgdb&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Create MySQL persons connector</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">personsConnector = MySqlConnector(connection, <span class="string">&#x27;person&#x27;</span>, <span class="string">&#x27;id&#x27;</span>)</span><br><span class="line"></span><br><span class="line">personsMappings = &#123;</span><br><span class="line">	<span class="string">&#x27;first_name&#x27;</span>:<span class="string">&#x27;first&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;last_name&#x27;</span>:<span class="string">&#x27;last&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;age&#x27;</span>:<span class="string">&#x27;age&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RGWriteBehind(GB,  keysPrefix=<span class="string">&#x27;person&#x27;</span>, mappings=personsMappings, connector=personsConnector, name=<span class="string">&#x27;PersonsWriteBehind&#x27;</span>,  version=<span class="string">&#x27;99.99.99&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># RGWriteThrough(GB, keysPrefix=&#x27;__&#x27;, mappings=personsMappings, connector=personsConnector, name=&#x27;PersonsWriteThrough&#x27;, version=&#x27;99.99.99&#x27;)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="演示操作"><a href="#演示操作" class="headerlink" title="演示操作"></a>演示操作</h3><h4 id="WriteBehind"><a href="#WriteBehind" class="headerlink" title="WriteBehind"></a>WriteBehind</h4><h5 id="hmset-不同操作完成后，在-mysql-rgdb-person-表中查看数据同步结果"><a href="#hmset-不同操作完成后，在-mysql-rgdb-person-表中查看数据同步结果" class="headerlink" title="hmset (不同操作完成后，在 mysql rgdb.person 表中查看数据同步结果)"></a><code>hmset</code> (不同操作完成后，在 mysql rgdb.person 表中查看数据同步结果)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">hmset person:1 first_name zhang last_name san age 21</span><br><span class="line">hmset person:2 first_name li last_name sisi age 18</span><br><span class="line"></span><br><span class="line">hmset person:10 first_name li last_name sisi age 18</span><br><span class="line"></span><br><span class="line">## 复制控制</span><br><span class="line"></span><br><span class="line">## 变更并同步(默认行为)</span><br><span class="line">hmset person:3 first_name li last_name sisi age 22 # &#x3D;</span><br><span class="line"></span><br><span class="line">## 变更不同步</span><br><span class="line">hmset person:3 first_name li last_name sisi age 50 # +</span><br><span class="line"># HGETALL person:3</span><br><span class="line"></span><br><span class="line">## 删除并同步</span><br><span class="line">hmset person:3 # ~</span><br><span class="line"></span><br><span class="line">hmset person:3 first_name li last_name sisi age 22 # &#x3D;</span><br><span class="line">## 删除不同步</span><br><span class="line">hmset person:3 # -</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="正好一次（源码有缺陷，mysql-connector-修复见-https-gitlab-com-shankai-rgsync）"><a href="#正好一次（源码有缺陷，mysql-connector-修复见-https-gitlab-com-shankai-rgsync）" class="headerlink" title="正好一次（源码有缺陷，mysql connector 修复见 https://gitlab.com/shankai/rgsync）"></a>正好一次（源码有缺陷，<code>mysql connector</code> 修复见 <code>https://gitlab.com/shankai/rgsync</code>）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE IF NOT EXISTS &#96;exactlyonce&#96;(</span><br><span class="line">   &#96;id&#96; VARCHAR(100),</span><br><span class="line">   &#96;val&#96; VARCHAR(100),</span><br><span class="line">   PRIMARY KEY ( &#96;id&#96; )</span><br><span class="line">)ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line">describe exactlyonce;</span><br></pre></td></tr></table></figure>
<p><code>example.py</code> 文件内修改 personsConnector 实例化，添加 <code>exactlyOnceTableName</code> 参数值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">personsConnector &#x3D; MySqlConnector(connection, &#39;person&#39;, &#39;id&#39;, &#39;exactlyonce&#39;)</span><br></pre></td></tr></table></figure>


<h5 id="ACK"><a href="#ACK" class="headerlink" title="ACK"></a>ACK</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># </span><br><span class="line">hset person:007 first_name James last_name Bond age 43 # &#x3D;6ce0c902-30c2-4ac9-8342-2f04fb359a944412</span><br><span class="line"># XREAD BLOCK &lt;timeout&gt; STREAMS &#123;&lt;hash key&gt;&#125;&lt;uuid&gt; 0-0</span><br><span class="line">XREAD BLOCK 2000 STREAMS &#123;person:007&#125;6ce0c902-30c2-4ac9-8342-2f04fb359a944412 0-0</span><br></pre></td></tr></table></figure>


<h4 id="WriteThrough"><a href="#WriteThrough" class="headerlink" title="WriteThrough"></a>WriteThrough</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HSET __&#123;person:1&#125; first_name foo last_name bar age 20 # &#x3D;123456</span><br><span class="line"></span><br><span class="line">XREAD BLOCK 2000 STREAMS &#123;person:104&#125;123456 0-0</span><br></pre></td></tr></table></figure>
<p>(完)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/09/zeromq-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="shankai">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="零壹">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/09/zeromq-notes/" class="post-title-link" itemprop="url">ZeroMQ 笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-09 14:24:44" itemprop="dateCreated datePublished" datetime="2021-03-09T14:24:44+08:00">2021-03-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-03-20 21:25:27" itemprop="dateModified" datetime="2021-03-20T21:25:27+08:00">2021-03-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/EventBus/" itemprop="url" rel="index"><span itemprop="name">EventBus</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Introduce"><a href="#Introduce" class="headerlink" title="Introduce"></a>Introduce</h2><p>ZeroMQ, 一个开源的通用消息库。</p>
<p>ZeroMQ(也拼作ØMQ、0MQ 或 ZMQ)是一个高性能异步消息传递库，旨在在分布式或并发应用程序中使用。它提供了一个消息队列，但与面向消息的中间件不同，ZeroMQ系统可以在没有专用消息代理的情况下运行。</p>
<p>ZeroMQ支持各种传输(TCP、进程内、进程间、多播、WebSocket等等)上的通用消息传递模式(发布/订阅、请求/应答、客户端/服务器等)，使进程间消息传递像线程间消息传递一样简单。这使你的代码清晰，模块化和极容易扩展。</p>
<p>ZeroMQ是由一个大型贡献者社区开发的。许多流行的编程语言都有第三方实现，C# 和 Java 也有 Native Ports。</p>
<blockquote>
<p><strong>ZeroMQ的哲学是从零开始的。零代表零代理(ZeroMQ是无代理的)、零延迟、零成本(它是免费的)和零管理。更普遍地说，“零”指的是渗透到项目中的极简主义文化。我们通过消除复杂性而不是暴露新功能来增加功能。</strong></p>
</blockquote>
<h3 id="Libzmq-the-low-level-library"><a href="#Libzmq-the-low-level-library" class="headerlink" title="Libzmq - the low level library"></a>Libzmq - the low level library</h3><p>Libzmq (<a target="_blank" rel="noopener" href="https://github.com/zeromq/libzmq">https://github.com/zeromq/libzmq</a>) 是大多数不同语言绑定背后的底层库。Libzmq 公开 C-API 及 C++ 的实现。</p>
<h2 id="Languages"><a href="#Languages" class="headerlink" title="Languages"></a>Languages</h2><p>C、C++、C#、Erlang、F#、Go、Haskell、Java、Node.js、Perl、Python、Ruby、Rust 等。</p>
<p>更多：<a target="_blank" rel="noopener" href="http://wiki.zeromq.org/bindings:_start">http://wiki.zeromq.org/bindings:_start</a></p>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/zeromq/jeromq">JeroMQ</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/zeromq/jzmq">JZMQ</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/zeromq/czmq/tree/master/bindings/jni">jczmq</a></li>
</ul>
<h2 id="Messages"><a href="#Messages" class="headerlink" title="Messages"></a>Messages</h2><h3 id="Messages-1"><a href="#Messages-1" class="headerlink" title="Messages"></a>Messages</h3><h4 id="Blob"><a href="#Blob" class="headerlink" title="Blob"></a>Blob</h4><p>ZeroMQ 消息是在应用程序或相同应用程序的组件之间传递的离散数据单元。从ZeroMQ本身的角度来看，消息被认为是不透明的二进制数据。</p>
<p>在网络上，ZeroMQ 消息是可以容纳内存的从 0 开始任意大小的 Blob。可以使用 Protocol Buffers、msgpack、JSON 或应用程序需要表达的任何东西来进行自己的序列化。选择可移植的数据表示是明智的，可以自己做出权衡的决定。</p>
<h4 id="Frame"><a href="#Frame" class="headerlink" title="Frame"></a>Frame</h4><p>最简单的 ZeroMQ 消息由一个帧(也称为消息部分)组成。</p>
<p>帧是 ZeroMQ 消息的基本格式，帧是指定长度的数据块。</p>
<p>ZeroMQ 保证传递消息的所有部分(一个或多个)，或者不传递任何部分。这允许以单个消息的形式发送或接收帧列表。</p>
<h4 id="Multipart"><a href="#Multipart" class="headerlink" title="Multipart"></a>Multipart</h4><p>消息(单个或多个部分)必须装入内存。如果想发送任意大小的文件，应该将它们分解为多个块(piece)，并将每个块(piece)作为单个部分消息(single-part)发送。</p>
<p><strong>使用 Multipart 数据不会减少内存消耗。</strong></p>
<h3 id="Working-with-strings"><a href="#Working-with-strings" class="headerlink" title="Working with strings"></a>Working with strings</h3><p>将数据作为字符串传递通常是进行通信的最简单方法，因为序列化非常简单。对于ZeroMQ，有这样的规则：<strong>字符串是指定长度的，并且在发送时不带末尾null</strong>。</p>
<p>以下函数（JeroMQ 为例）将字符串作为单帧消息发送到套接字，其中字符串的长度等于帧的长度。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket.send(<span class="string">&quot;HELLO&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>要从套接字读取字符串，只需调用 <code>recv</code> 函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String hello = socket.recvStr()</span><br></pre></td></tr></table></figure>
<p>如果需要更多的控制帧，可以使用 ZFrame 类。下面的代码片段展示了如何从字符串创建帧并发送帧。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ZFrame stringFrame = <span class="keyword">new</span> ZFrame(<span class="string">&quot;HELLO&quot;</span>);</span><br><span class="line">stringFrame.send(socket, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>调用 ZFrame 类的静态 recvFrame 函数，从套接字中读取一个帧并返回一个 ZFrame 对象。如果内容是字符串，则可以通过提供用于序列化它的字符集的 getString 方法来检索它。</p>
<p>默认情况下，<code>ZMQ.CHARSET</code> 用于序列化和反序列化字符串的所有操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ZFrame stringFrame = ZFrame.recvFrame(socket);</span><br><span class="line">String hello = stringFrame.getString(ZMQ.CHARSET);</span><br></pre></td></tr></table></figure>


<p>因为我们利用帧的长度来反映字符串的长度，我们可以通过将每个字符串放入一个单独的帧来发送多个字符串。</p>
<p>在一个消息中发送多个字符串帧是可以使用 <code>sendMore</code>方法的。这个方法将延迟消息的实际发送，直到最后一帧被发送。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">socket.sendMore(socket, <span class="string">&quot;HELLO&quot;</span>);</span><br><span class="line">socket.sendMore(socket, <span class="string">&quot;beautiful&quot;</span>);</span><br><span class="line">socket.send(socket, <span class="string">&quot;WORLD!&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>可以使用 ZMsg 类构造多帧消息，而不必使用套接字的 send API。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ZMsg *strings = <span class="keyword">new</span> ZMsg();</span><br><span class="line">strings.add(<span class="string">&quot;HELLO&quot;</span>);</span><br><span class="line">strings.add(<span class="string">&quot;beautiful&quot;</span>);</span><br><span class="line">strings.add(<span class="string">&quot;WORLD&quot;</span>);</span><br><span class="line">strings.send(socket);</span><br></pre></td></tr></table></figure>
<p>若要接收一系列字符串帧，请多次调用 <code>recvStr</code> 函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String hello     = socket.recvStr();</span><br><span class="line">String beautiful = socket.recvStr();</span><br><span class="line">String world 	 = socket.recvStr();</span><br></pre></td></tr></table></figure>
<p>为了在一次调用中检索整个消息，可以使用 ZMsg 类的静态 <code>recvMsg</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ZMsg strings = ZMsg.recvMsg(socket);</span><br><span class="line">String hello     = strings.popString();</span><br><span class="line">String beautiful = strings.popString();</span><br><span class="line">String world     = strings.popString();</span><br></pre></td></tr></table></figure>
<h2 id="Socket-API"><a href="#Socket-API" class="headerlink" title="Socket API"></a>Socket API</h2><p>套接字实际上是网络编程的标准 API。这就是为什么 ZeroMQ 提供了一个熟悉的基于套接字的API。ZeroMQ 对开发人员特别有吸引力的一点是，它使用不同的套接字类型来实现任何任意的消息传递模式。此外，ZeroMQ 套接字对底层网络协议提供了一个清晰的抽象，这隐藏了这些协议的复杂性，使它们之间的切换非常容易。</p>
<h3 id="与传统套接字的关键区别"><a href="#与传统套接字的关键区别" class="headerlink" title="与传统套接字的关键区别"></a>与传统套接字的关键区别</h3><p>一般来说，传统套接字为面向连接的可靠字节流(SOCK_STREAM)或不可靠数据报(SOCK_DGRAM)提供同步接口。相比之下，ZeroMQ 套接字提供了异步消息队列的抽象，其确切的队列语义取决于所使用的套接字类型。传统套接字传输字节流或离散数据报，ZeroMQ 套接字传输离散消息。</p>
<p>ZeroMQ 套接字是异步的，这意味着物理连接的建立和断开、重新连接和有效交付的时间对用户是透明的，并由 ZeroMQ 自己组织。此外，如果对等端无法接收消息，则消息可能被排队。</p>
<p>传统套接字只允许严格的一对一(两个对等体)、多对一(多个客户端、一个服务器)或在某些情况下一对多(多播)关系。除了 PAIR 套接字之外，ZeroMQ 套接字可以连接到多个端点，同时接受来自绑定到套接字的多个端点的入站连接，从而允许多对多关系。</p>
<h3 id="套接字生命"><a href="#套接字生命" class="headerlink" title="套接字生命"></a>套接字生命</h3><p>ZeroMQ 套接字生命有四部分，类似 BSD 套接字：</p>
<ul>
<li>创建和销毁套接字，它们共同形成了一个套接字生命的因果循环；</li>
<li>通过在套接字上设置选项并在必要时检查它们来配置套接字；</li>
<li>通过创建与套接字的ZeroMQ连接，将套接字插入到网络拓扑中；</li>
<li>通过在套接字上写入和接收消息来传递数据。</li>
</ul>
<h3 id="绑定与连接-Bind-vs-Connect"><a href="#绑定与连接-Bind-vs-Connect" class="headerlink" title="绑定与连接(Bind vs Connect)"></a>绑定与连接(Bind vs Connect)</h3><p>ZeroMQ 套接字并不在乎谁在绑定，谁在连接。在之前的示例中，你可能注意到的是服务端使用了绑定，客户端使用了连接。为什么是这样的，有什么区别？</p>
<p>ZeroMQ 为每个基础的连接创建队列。如果你的套接字连接到了 3 个对等的套接字，那么在后台将有 3 个消息队列。</p>
<p>使用绑定(Bind)，允许任意的对等套接字连接(Connect)上来，因此在绑定端不清楚到底会有多少个对等点，也不能提前创建队列。相反，队列是作为连接(Connect)到绑定套接字的单个对等体创建的。</p>
<p>使用连接(Connect)，ZeroMQ 知道至少会有一个对等体，因此它可以立即创建单个队列。这适用于所有的套接字类型，除了路由器(ROUTER)，只有在我们连接的对等体确认我们的连接后才创建队列。</p>
<p>因此，<strong>当向没有对等体的绑定(Bind)套接字或没有实时连接的路由器(ROUTER)发送消息时，没有队列来存储消息。</strong></p>
<h4 id="何时用绑定-Bind-，何时用连接-Connect-？"><a href="#何时用绑定-Bind-，何时用连接-Connect-？" class="headerlink" title="何时用绑定(Bind)，何时用连接(Connect)？"></a>何时用绑定(Bind)，何时用连接(Connect)？</h4><p>一般情况下，在体系结构最稳定的点(Points)使用绑定(Bind)，在具有不稳定端点(Endpoints)的动态组件使用连接(Connect)。对于请求/应答(request/reply)，服务提供者可能是您绑定和客户端使用 Connect 的地方。就像普通的旧 TCP 一样。</p>
<p>如果不知道哪个部分更稳定(比如点对点) ，可以考虑中间的一个稳定设备，这样所有的部分都可以去连接。</p>
<h3 id="高水位标记-High-Water-Mark"><a href="#高水位标记-High-Water-Mark" class="headerlink" title="高水位标记(High-Water-Mark)"></a>高水位标记(High-Water-Mark)</h3><p>高水位线是对 ZeroMQ 在内存中排队的未完成消息的<strong>最大数量的硬性限制</strong>。</p>
<p>如果达到此限制，套接字将进入异常状态，根据套接字类型，ZeroMQ 将采取适当的操作，如<strong>阻塞(Blocking)**或</strong>丢弃(Dropping)**发送的消息。请参考下面的套接字描述，以了解为每种套接字类型所采取的具体操作。</p>
<h3 id="消息传递模式-Messaging-Patterns"><a href="#消息传递模式-Messaging-Patterns" class="headerlink" title="消息传递模式(Messaging Patterns)"></a>消息传递模式(Messaging Patterns)</h3><p>在 ZeroMQ 套接字 API 是对消息传递模式(Messaging Patterns)的包装。ZeroMQ 模式通过具有<strong>匹配类型</strong>的<strong>套接字对</strong>来实现。</p>
<p>套接字类型定义了套接字的语义、它用于向内向外路由消息的策略、队列等。可以将某些类型的套接字连接在一起，例如，发布服务器套接字和订阅服务器套接字。套接字在“消息传递模式”中协同工作。</p>
<p>内置的 ZeroMQ 核心模式如下：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://zeromq.org/socket-api/#request-reply-pattern"><strong>Request-reply</strong></a>(请求/应答)，它将一组客户端连接到一组服务端。这是一种远程过程调用(RPC)和任务分布(Task Distribution)模式。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://zeromq.org/socket-api/#publish-subscribe-pattern"><strong>Pub-sub</strong></a>(发布-订阅)，它将一组发布者连接到一组订阅者。这是一种数据分布(Data Distribution)模式。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://zeromq.org/socket-api/#pipeline-pattern"><strong>Pipeline</strong></a>(管道)，它以扇出(fan-out)/扇入(fan-in)模式连接节点，该模式可以有多个步骤和循环。这是一个并行任务分配和收集(Parallel task distribution and collection)模式。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://zeromq.org/socket-api/#exclusive-pair-pattern"><strong>Exclusive pair</strong></a>(独占对)，专门连接两个套接字。这是一种在进程中连接两个线程的模式，不要与“普通”的套接字对混淆。</p>
</li>
</ul>
<p>还有更多ZeroMQ模式仍处于草案状态：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zeromq.org/socket-api/#client-server-pattern"><strong>Client-server</strong></a>(客户端-服务器)，它允许单个 ZeroMQ 服务器与一个或多个 ZeroMQ 客户机通话。客户端始终启动会话，在此之后，任何一方都可以异步地向另一方发送消息。</li>
<li><a target="_blank" rel="noopener" href="https://zeromq.org/socket-api/#radio-dish-pattern"><strong>Radio-dish</strong></a>(无线接收天线)，用于一对多的数据分发，以扇形方式(fan out)将数据从一个发布者发送到多个订阅者。</li>
</ul>
<h4 id="Request-reply"><a href="#Request-reply" class="headerlink" title="Request-reply"></a>Request-reply</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://rfc.zeromq.org/spec/28/">https://rfc.zeromq.org/spec/28/</a></p>
</blockquote>
<p>请求-应答(Request-reply)模式适用于各种面向服务的体系结构。它有两种基本形式：** 同步(REQ 和 REP)<strong>和</strong>异步(DEALER 和 ROUTER) **，可以以各种方式混合使用。DEALER 和 ROUTER 套接字是许多高级协议的构建块，比如 rfc.zeromq.org/spec:18/mdp 协议。</p>
<h5 id="REQ"><a href="#REQ" class="headerlink" title="REQ"></a>REQ</h5><p>客户端使用 <code>REQ</code> 套接字向服务发送请求并从服务接收响应。这种套接字类型只允许交替的发送和随后的接收调用。一个 <code>REQ</code> 套接字可以连接到任意数量的 <code>REP</code> 或 <code>ROUTER</code> 套接字。发送的每个请求都在所有连接的服务之间循环，接收到的每个应答都与最后发出的请求匹配。它是为简单的请求-应答模型而设计的，在这种模型中，针对失败对等体的可靠性不是问题。</p>
<p>如果没有可用的服务，那么套接字上的任何发送操作都将阻塞，直到至少有一个服务可用。<code>REQ</code> 套接字不会丢弃任何消息。</p>
<h5 id="REP"><a href="#REP" class="headerlink" title="REP"></a>REP</h5><p>服务使用 <code>REP</code> 套接字接收来自客户机的请求并向客户机发送应答。这种套接字类型只允许接收和随后的发送调用交替序列。接收到的每个请求都是来自所有客户机的公平队列(fair-queued)，发送的每个应答都被路由到发出最后一个请求的客户机。如果原始请求者不再存在，则静默丢弃应答。</p>
<h5 id="DEALER"><a href="#DEALER" class="headerlink" title="DEALER"></a>DEALER</h5><p><code>DEALER</code> 套接字类型与一组匿名对等体通信，使用循环(round-robin)算法发送和接收消息。只要它不丢弃消息，它就是可靠的。对于与 <code>REP</code> 或 <code>ROUTER</code> 通信的客户端，<code>DEALER</code> 作为 <code>REQ</code> 的异步替代。<code>DEALER</code> 收到的消息从所有连接的对等体公平排队(fair-queued)。</p>
<p>当 <code>DEALER</code> 由于达到了所有对等体的高水位而进入静音状态，或者如果根本没有对等体，那么套接字上的任何发送操作都将<strong>阻塞</strong>(Block)，直到静音状态结束或至少有一个对等体可用来发送；消息不会被丢弃。</p>
<p>当 <code>DEALER</code> 连接到 <code>REP</code> 套接字时，发送的消息必须包含一个空帧作为消息的第一部分(分隔符)，然后是一个或多个正文部分。</p>
<h5 id="ROUTER"><a href="#ROUTER" class="headerlink" title="ROUTER"></a>ROUTER</h5><p><code>ROUTER</code> 套接字类型与一组对等体对话，使用显式寻址，以便每个传出的消息被发送到一个特定的对等体连接。<code>ROUTER</code> 作为<code>REP</code>的异步替代品，经常用作服务器与 <code>DEALER</code> 通信的基础。</p>
<p>当 <code>ROUTER</code> 套接字接收消息时，在将消息传递给应用程序之前，将包含原始对等体的路由id的消息部分预先添加到消息部分。接收到的消息从所有连接的对等体中公平排队(fair-queued)。当发送消息时，一个 <code>ROUTER</code> 套接字将删除消息的第一部分，并使用它来确定消息应该被路由到的对等体的路由id。如果对等体已经不存在或从未存在过，则该消息将被静默<strong>丢弃</strong>。</p>
<p>当 <code>ROUTER</code> 套接字由于达到了对所有对等体的最高水位而进入静音状态时，发送到该套接字的任何消息都将被丢弃，直到静音状态结束。同样，路由到已达到单个高水位标记的对等点的任何消息也将被丢弃。</p>
<p>当一个 <code>REQ</code> 套接字连接到一个 <code>ROUTER</code> 套接字时，除了原始对等体的路由id外，每个收到的消息还应该包含一个空的分隔符消息部分。因此，应用程序看到的每个接收到的消息的整个结构变成：一个或多个路由id部分、分隔符部分、一个或多个主体部分。当向 <code>REQ</code> 套接字发送应答时，应用程序必须包含分隔符部分。</p>
<h4 id="Publish-subscribe"><a href="#Publish-subscribe" class="headerlink" title="Publish-subscribe"></a>Publish-subscribe</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://rfc.zeromq.org/spec/29/">https://rfc.zeromq.org/spec/29/</a></p>
</blockquote>
<p>发布-订阅(Publish-subscribe)模式用于以扇形方式将数据从一个发布者分发到多个订阅者的一对多分布。</p>
<p>ZeroMQ 通过四种套接字类型来支持发布/订阅：<code>PUB</code>,<code>XPUB</code>,<code>SUB</code>,<code>XSUB</code>。</p>
<h5 id="Topics"><a href="#Topics" class="headerlink" title="Topics"></a>Topics</h5><p>ZeroMQ 使用多部分(Multipart)消息来传递主题(Topic)信息。<code>Topic</code> 表示为字节数组，但也可以使用字符串和适当的文本编码。</p>
<p>发布者必须在消息有效负载之前的第一个帧中包含主题。例如，向<code>status</code>主题的订阅者发布状态消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  Send a message on the &#x27;status&#x27; topic</span></span><br><span class="line">pub.sendMore(<span class="string">&quot;Status&quot;</span>);</span><br><span class="line">pub.send(<span class="string">&quot;All is well&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>订阅者通过 Socket 类的 subscribe 方法指定他们感兴趣的主题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  Subscribe to the &#x27;status&#x27;</span></span><br><span class="line">sub.subscribe(<span class="string">&quot;status&quot;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>一个订阅者(subscriber)套接字可以有多个订阅筛选器(filter)。</strong></p>
<p>使用前缀检查将消息的主题(Topic)与订阅者的订阅主题进行比较，也就是说，订阅了 <code>topic</code> 的订阅者会收到主题为：<code>topic</code>或<code>topic/subtopic</code>或<code>topical</code>的消息，然而，它不会接收 <code>topi</code> 和 <code>TOPIC</code> 的主题消息。</p>
<h5 id="PUB"><a href="#PUB" class="headerlink" title="PUB"></a>PUB</h5><p>发布者使用 <code>PUB</code> 套接字来分发数据。发送的消息以扇出的方式分发到所有连接的对等体。<strong>此套接字类型无法接收任何消息。</strong></p>
<p>当 <code>PUB</code> 套接字由于达到了订阅者的高水位而进入静音状态时，将发送到有问题的订阅者的任何消息都将被<strong>丢弃</strong>，直到静音状态结束。对于这种套接字类型，Send 函数永远不会阻塞。</p>
<h5 id="SUB"><a href="#SUB" class="headerlink" title="SUB"></a>SUB</h5><p>订阅者使用<code>SUB</code>套接字订阅由发布者分发的数据。最初，<code>SUB</code>套接字不订阅任何消息。<strong>此套接字类型没有实现 send 函数。</strong></p>
<h5 id="XPUB"><a href="#XPUB" class="headerlink" title="XPUB"></a>XPUB</h5><p>与 <code>PUB</code> 相同，只是可以以传入消息的形式从对等节点接收订阅(Subscription)。订阅消息由两部分组成，一是<strong>字节1</strong>(用于订阅)或<strong>字节0</strong>(用于取消订阅)，二是在一后面跟着订阅主体。没有订阅或取消订阅前缀的消息也会被接收，但对订阅状态没有影响。</p>
<h5 id="XSUB"><a href="#XSUB" class="headerlink" title="XSUB"></a>XSUB</h5><p>与<code>SUB</code>相同，不同的是您是通过向套接字发送订阅(Subscription)消息来进行订阅的。订阅消息由两部分组成，一是<strong>字节1</strong>(用于订阅)或<strong>字节0</strong>(用于取消订阅)，二是在一后面跟着订阅主体。没有订阅或取消订阅前缀的消息也会被发送，但对订阅状态没有影响。</p>
<h4 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://rfc.zeromq.org/spec/30/">https://rfc.zeromq.org/spec/30/</a></p>
</blockquote>
<p>管道(pipeline)模式用于任务分配，通常是在一个多阶段管道中，其中一个或几个节点将工作推给多个工作人员，然后这些工作人员又将结果推给一个或几个收集器。该模式大多是可靠的，除非节点意外断开连接，否则它不会丢弃消息。它是可扩展的，节点可以在任何时候加入。</p>
<p>ZeroMQ通过两种套接字类型支持流水线：<code>PUSH</code> 和 <code>PULL</code></p>
<h5 id="PUSH"><a href="#PUSH" class="headerlink" title="PUSH"></a>PUSH</h5><p><code>PUSH</code> 套接字类型与一组匿名的 <code>PULL</code> 对等体对话，使用循环算法发送消息。<strong>没有为该套接字类型实现接收(<em>receive</em>)操作。</strong></p>
<p>当由于到达所有下游节点的高水位，或没有下游节点，则套接字进入静音状态，此时任何套接字上发送操作将被<strong>阻塞</strong>，直到静音状态结束或至少一个下游节点发送可用；<strong>消息不会被丢弃</strong>。</p>
<h5 id="PULL"><a href="#PULL" class="headerlink" title="PULL"></a>PULL</h5><p><code>PULL</code>套接字类型与一组匿名 <code>PUSH</code> 对等体对话，使用公平排队算法接收消息。<strong>没有为该套接字类型实现发送(<em>send</em>)操作。</strong></p>
<h4 id="Exclusive-Pair"><a href="#Exclusive-Pair" class="headerlink" title="Exclusive Pair"></a>Exclusive Pair</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://rfc.zeromq.org/spec/31/">https://rfc.zeromq.org/spec/31/</a></p>
</blockquote>
<p>独占对 <code>PAIR</code> 不是一个通用套接字，用于两个对等体在结构上稳定的特定用例。这通常限制了 <code>PAIR</code> 只能在单个进程中使用，用于线程间通信。</p>
<p><code>PAIR</code> 类型的套接字在任何时候只能连接到单个对等点。对通过 <code>PAIR</code> 套接字发送的消息不执行<strong>路由</strong>和<strong>筛选</strong>。</p>
<p>当一个 <code>PAIR</code> 套接字由于已连接的对等点达到了高水位标记而进入静音状态，或者如果没有对等点被连接，那么套接字上的任何发送操作都会被阻塞，直到对等点可以发送为止；消息不会被丢弃。</p>
<p>虽然 <code>PAIR</code> 套接字可以通过 <code>inproc</code> 以外的传输方式使用，但是它们不能自动重新连接，而且新连入的连接将被终止，而以前存在的任何连接(包括处于关闭状态的连接)在大多数情况下都不适合 TCP。</p>
<h2 id="zguide"><a href="#zguide" class="headerlink" title="zguide"></a>zguide</h2><h3 id="Advanced-Request-Reply-Pattern"><a href="#Advanced-Request-Reply-Pattern" class="headerlink" title="Advanced Request-Reply Pattern"></a>Advanced Request-Reply Pattern</h3><p>路由的本质是消息中包含了一个身份帧（信封地址）。</p>
<p>REQ 和 REP 是同步的；DEALER 和 ROUTER 是异步的，无视应答信封。</p>
<p>DEALER 类似于异步 REQ 套接字，ROUTER 类似于异步 REP 套接字。在使用 REQ 套接字的地方，我们可以使用 DEALER; 我们只需要自己读写信封。在使用 REP 套接字的地方，我们可以粘贴 ROUTER; 我们只需要自己管理标识。</p>
<p>可以将 REQ 和 DEALER 套接字视为“客户端”，将 REP 和 ROUTER 套接字视为“服务器”。通常，您需要 <code>bind</code> REP 和 ROUTER 套接字，并将 REQ 和 DEALER 套接字 <code>connect</code> 到它们。</p>
<p>Identity 标识当前套接字的身份信息；envelope(Envelope Frame) 标识将要路由到的套接字地址</p>
<p>请求-应答模式套接字有效的组合：</p>
<ul>
<li>REQ to REP</li>
<li>DEALER to REP</li>
<li>REQ to ROUTER</li>
<li>DEALER to ROUTER</li>
<li>DEALER to DEALER</li>
<li>ROUTER to ROUTER</li>
</ul>
<p>无效组合：</p>
<ul>
<li>REQ to REQ  双方都希望通过相互发送消息来开始。</li>
<li>REQ to DEALER 当有多个 REQ 时，DEALER 无法原路返回。</li>
<li>REP to REP 双方都会等待对方发送第一条消息。</li>
<li>REP to ROUTER ROUTER 不知道 REP 的地址。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/07/security-sasl-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="shankai">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="零壹">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/07/security-sasl-notes/" class="post-title-link" itemprop="url">SASL 笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-03-07 09:34:47 / 修改时间：11:49:46" itemprop="dateCreated datePublished" datetime="2021-03-07T09:34:47+08:00">2021-03-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Security/" itemprop="url" rel="index"><span itemprop="name">Security</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Introduce"><a href="#Introduce" class="headerlink" title="Introduce"></a>Introduce</h2><p>简单身份验证和安全层(Simple Authentication and Security Layer，简称SASL)是一种Internet标准(<a target="_blank" rel="noopener" href="http://www.ietf.org/rfc/rfc2222.txt">RFC 2222</a>)，它指定了用于身份验证和可选地在客户机和服务器应用程序之间建立安全层的协议。SASL定义了如何交换身份验证数据，但本身并不指定该数据的内容。它是一个框架，指定身份验证数据的内容和语义的特定身份验证机制可以融入其中。</p>
<p>SASL被协议(如轻量级目录访问协议版本3 (LDAP v3)和Internet消息访问协议版本4 (IMAP v4))用于启用可插拔身份验证。LDAP v3和IMAP v4没有将身份验证方法硬连接到协议中，而是使用SASL执行身份验证，从而通过各种SASL机制启用身份验证。</p>
<p>Internet社区为不同级别的安全性和部署场景定义了许多标准的SASL机制。这些级别的范围从无安全性(例如，匿名身份验证)到高安全性(例如，Kerberos身份验证)以及介于两者之间的级别。</p>
<p><strong>The Java SASL API</strong></p>
<p>Java SASL API为使用SASL机制的应用程序定义了类和接口。它被定义为与机制无关的:使用API的应用程序不需要硬连接到使用任何特定的SASL机制。该API支持客户机和服务器应用程序。它允许应用程序根据所需的安全特性选择要使用的机制，比如它们是否容易受到被动字典攻击，或者它们是否接受匿名身份验证。<br>Java SASL API还允许开发人员使用他们自己的自定义SASL机制。通过使用Java加密体系结构(JCA)安装SASL机制。</p>
<p><strong>When to Use SASL</strong></p>
<p>SASL为网络应用程序提供了可插拔的身份验证和安全层。Java SE中还有其他特性提供类似的功能，包括Java安全套接字扩展(JSSE)和Java通用安全服务(Java GSS)。JSSE为SSL和TLS协议的Java语言版本提供了一个框架和实现。Java GSS是通用安全服务应用程序编程接口(GSS- api)的Java语言绑定。Java SE上这个API目前支持的唯一机制是Kerberos v5。<br>与JSSE和Java GSS相比，SASL是相对轻量级的，并且在最近的协议中很流行。它还有一个优点，就是定义了几种流行的轻量级(在基础设施支持方面)SASL机制。另一方面，主要的JSSE和Java GSS机制具有相对重量级的机制，需要更详细的基础设施(分别是公钥基础设施和Kerberos)。</p>
<p>SASL、JSSE 和 Java GSS 通常一起使用。例如，一个常见的模式是应用程序使用 JSSE 建立安全通道，使用 SASL 进行客户端基于用户名/密码的身份验证。在 GSS-API 机制之上还有 SASL 机制；一个流行的示例是与 LDAP 一起使用的 SASL GSS-API/Kerberos v5 机制。</p>
<p>除了从头定义和构建协议之外，协议定义通常是决定使用哪个 API 的最大因素。例如，LDAP 和 IMAP 被定义为使用 SASL，因此与这些协议相关的软件应该使用 Java SASL API。在构建Kerberos 应用程序和服务时，使用的 API 是Java GSS。当构建使用 SSL/TLS 作为协议的应用程序和服务时，使用的 API 是JSSE。</p>
<h2 id="SASL-Architechture"><a href="#SASL-Architechture" class="headerlink" title="SASL Architechture"></a>SASL Architechture</h2><h3 id="SASL-Architechture-1"><a href="#SASL-Architechture-1" class="headerlink" title="SASL Architechture"></a>SASL Architechture</h3><p><img src="/images/sasl/sasl-archit.png" alt="sasl-archit"></p>
<h3 id="SASL-Life-Cycle"><a href="#SASL-Life-Cycle" class="headerlink" title="SASL Life Cycle"></a>SASL Life Cycle</h3><p><img src="/images/sasl/sasl-flowchart-overview.png" alt="sasl-flowchart-overview"></p>
<h3 id="SASL-Session-Initialization"><a href="#SASL-Session-Initialization" class="headerlink" title="SASL Session Initialization"></a>SASL Session Initialization</h3><p><img src="/images/sasl/sasl-flowchart-init.png" alt="sasl-flowchart-init"></p>
<h3 id="SASL-Authentication-Sending-Client-Data"><a href="#SASL-Authentication-Sending-Client-Data" class="headerlink" title="SASL Authentication: Sending Client Data"></a>SASL Authentication: Sending Client Data</h3><p><img src="/images/sasl/sasl-flowchart-auth.png" alt="sasl-flowchart-auth"></p>
<h3 id="SASL-Authentication-Processing-Server-Data"><a href="#SASL-Authentication-Processing-Server-Data" class="headerlink" title="SASL Authentication: Processing Server Data"></a>SASL Authentication: Processing Server Data</h3><p><img src="/images/sasl/sasl-flowchart-auth2.png" alt="sasl-flowchart-auth2"></p>
<h2 id="Java-SASL-API-Overview"><a href="#Java-SASL-API-Overview" class="headerlink" title="Java SASL API Overview"></a>Java SASL API Overview</h2><p>SASL 是一种挑战-响应协议。服务器向客户机发出质疑，客户机根据质疑发送响应。这种交换一直持续到服务器满意并且不发出进一步的挑战为止。这些挑战和响应是任意长度的二进制标记。封装协议(例如 LDAP 或 IMAP)指定了这些令牌的编码和交换方式。例如，LDAP 指定 SASL 标记如何封装在 LDAP 绑定请求和响应中。</p>
<p>Java SASL API是根据这种交互和使用风格建模的。它具有分别表示客户端和服务器端机制的接口 SaslClient 和 SaslServer。应用程序通过表示挑战和响应的字节数组与机制交互。服务器端机制迭代、发出挑战并处理响应，直到它满意为止，而客户端机制迭代、评估挑战并发出响应，直到服务器满意为止。使用该机制的应用程序驱动每次迭代。也就是说，它从协议包中提取挑战或响应，并将其提供给该机制，然后将该机制返回的响应或响应放入协议包中，并将其发送给对等体。</p>
<h2 id="How-SASL-Mechanisms-are-Installed-and-Selected"><a href="#How-SASL-Mechanisms-are-Installed-and-Selected" class="headerlink" title="How SASL Mechanisms are Installed and Selected"></a>How SASL Mechanisms are Installed and Selected</h2><p>SASL 机制实现由 SASL 安全提供者提供。每个提供者可以支持一个或多个 SASL 机制，并在 JCA 注册。</p>
<p>默认情况下，SunSASL 提供程序自动注册为 JCA 提供程序。若要将其作为 JCA 提供程序移除或重新排列其优先级，请更改 Java 安全属性文件(Java-home/conf/security/Java.security)。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">security.provider.7</span>=<span class="string">SunSASL</span></span><br></pre></td></tr></table></figure>
<p>若要添加或删除 SASL 提供程序，请在安全属性文件中添加或删除相应的行。</p>
<p>或者，可以使用 java.security.Security 以编程方式添加自己的提供程序。例如，下面的示例代码将 com.example.MyProvider 注册到可用的 SASL 安全提供程序列表中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Security.addProvider(<span class="keyword">new</span> com.example.MyProvider());</span><br></pre></td></tr></table></figure>
<h2 id="The-SunSASL-Provider"><a href="#The-SunSASL-Provider" class="headerlink" title="The SunSASL Provider"></a>The SunSASL Provider</h2><p>SunSASL 提供程序支持以下客户机和服务器机制：</p>
<ul>
<li>Client Mechanisms<ul>
<li>PLAIN (<a target="_blank" rel="noopener" href="http://www.ietf.org/rfc/rfc2595.txt">RFC 2595</a>). This mechanism supports cleartext user name/password authentication.</li>
<li>CRAM-MD5 (<a target="_blank" rel="noopener" href="http://www.ietf.org/rfc/rfc2195.txt">RFC 2195</a>). This mechanism supports a hashed user name/password authentication scheme.</li>
<li>DIGEST-MD5 (<a target="_blank" rel="noopener" href="http://www.ietf.org/rfc/rfc2831.txt">RFC 2831</a>). This mechanism defines how HTTP Digest Authentication can be used as a SASL mechanism.</li>
<li>EXTERNAL (<a target="_blank" rel="noopener" href="http://www.ietf.org/rfc/rfc2222.txt">RFC 2222</a>). This mechanism obtains authentication information from an external channel (such as TLS or IPsec).</li>
<li>NTLM. This mechanism supports NTLM authentication.</li>
</ul>
</li>
<li>Server Mechanisms<ul>
<li>CRAM-MD5</li>
<li>DIGEST-MD5</li>
<li>NTLM</li>
</ul>
</li>
</ul>
<h2 id="The-JdkSASL-Provider"><a href="#The-JdkSASL-Provider" class="headerlink" title="The JdkSASL Provider"></a>The JdkSASL Provider</h2><p>JdkSASL 提供程序支持以下客户机和服务器机制：</p>
<ul>
<li>Client Mechanisms<ul>
<li>GSSAPI (<a target="_blank" rel="noopener" href="http://www.ietf.org/rfc/rfc2222.txt">RFC 2222</a>). This mechanism uses the <a target="_blank" rel="noopener" href="http://www.ietf.org/rfc/rfc2078.txt">GSSAPI</a> for obtaining authentication information. It supports Kerberos v5 authentication.</li>
</ul>
</li>
<li>Server Mechanisms<ul>
<li>GSSAPI (Kerberos v5)</li>
</ul>
</li>
</ul>
<h2 id="Debugging-and-Monitoring"><a href="#Debugging-and-Monitoring" class="headerlink" title="Debugging and Monitoring"></a>Debugging and Monitoring</h2><p>SunSASL 和 JdkSASL 提供程序使用 Logging api 提供实现日志输出。这个输出可以通过使用日志配置文件和编程 API (java.util.logging)来控制。SunSASL 提供程序使用的日志记录器名称是 javax.security.sasl。下面是一个样例日志配置文件，它为 SunSASL 提供程序启用了 FINEST 日志级别：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">javax.security.sasl.level</span>=<span class="string">FINEST</span></span><br><span class="line"><span class="attr">handlers</span>=<span class="string">java.util.logging.ConsoleHandler</span></span><br><span class="line"><span class="meta">java.util.logging.ConsoleHandler.level</span>=<span class="string">FINEST</span></span><br></pre></td></tr></table></figure>
<h2 id="Implementing-a-SASL-Security-Provider"><a href="#Implementing-a-SASL-Security-Provider" class="headerlink" title="Implementing a SASL Security Provider"></a>Implementing a SASL Security Provider</h2><p>实现 SASL 安全提供商有三个基本步骤：</p>
<ol>
<li>编写一个实现 SaslClient 或 SaslServer 接口的类。</li>
<li>编写一个工厂类(实现 SaslClientFactory 或 SaslServerFactory) ，创建类的实例。</li>
<li>编写注册工厂的 JCA 提供程序。</li>
</ol>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/security/java-sasl-api-programming-and-deployment-guide1.html#GUID-6D78EE33-62E6-4D85-9695-322EED493F72">https://docs.oracle.com/en/java/javase/11/security/java-sasl-api-programming-and-deployment-guide1.html#GUID-6D78EE33-62E6-4D85-9695-322EED493F72</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E53394_01/html/E54753/sasl.intro.20.html">https://docs.oracle.com/cd/E53394_01/html/E54753/sasl.intro.20.html</a></p>
<p>（完）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/04/security-jaas-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="shankai">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="零壹">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/04/security-jaas-notes/" class="post-title-link" itemprop="url">JAAS 笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-04 10:27:46" itemprop="dateCreated datePublished" datetime="2021-03-04T10:27:46+08:00">2021-03-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-03-07 12:28:42" itemprop="dateModified" datetime="2021-03-07T12:28:42+08:00">2021-03-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Security/" itemprop="url" rel="index"><span itemprop="name">Security</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Introduce"><a href="#Introduce" class="headerlink" title="Introduce"></a>Introduce</h2><p><strong>Java身份认证和授权服务 (Java Authentication and Authorization Service，JAAS)</strong></p>
<p>JAAS 可用于两个目的:</p>
<ul>
<li>认证（对于用户身份验证，可以可靠且安全地确定谁正在执行Java代码，而不管代码是作为应用程序、applet、bean还是servlet运行）</li>
<li>授权（对用户进行授权，以确保他们拥有执行操作所需的访问控制权限）</li>
</ul>
<p>JAAS 实现了标准可插入的认证模块（PAM: Pluggable Authentication Module ）框架的 Java 版本。</p>
<p>传统上，Java 提供了基于代码源的访问控制(基于代码来源和代码签名人的访问控制)。然而，它缺乏根据运行代码的人来增加访问控制的能力。JAAS 提供了一个框架，用这种支持扩展 Java 安全架构。</p>
<p>JAAS 身份验证是以可插拔的方式执行的。这允许应用程序独立于底层的身份验证技术。可以在应用程序下插入新的或更新的身份验证技术，而无需对应用程序本身进行修改。应用程序通过实例化 LoginContext 对象来启用身份验证过程，该对象引用 Configuration 来确定用于执行身份验证的身份验证技术或技术，或 LoginModule。典型的 LoginModules 可能会提示输入并验证用户名和密码。其他人可以阅读和验证声音或指纹样本。</p>
<p>执行代码的用户或服务经过身份验证后，JAAS授权组件与核心Java SE访问控制模型一起工作，以保护对敏感资源的访问。访问控制决策既基于执行代码的 CodeSource，也基于运行代码的用户或服务(由Subject对象表示)。如果身份验证成功，则由带有相关主体和凭据的LoginModule更新主题。</p>
<h2 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h2><h3 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h3><p><img src="/images/jaas/jaas-authn.jpg" alt="jaas-authn"></p>
<h3 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a>Authorization</h3><p><img src="/images/jaas/protdom.gif" alt="protdom"></p>
<h2 id="Concept"><a href="#Concept" class="headerlink" title="Concept"></a>Concept</h2><h3 id="核心类和接口"><a href="#核心类和接口" class="headerlink" title="核心类和接口"></a>核心类和接口</h3><p>JAAS 相关的核心类和接口可以分为三类: <strong>通用类</strong>、<strong>身份验证类</strong>和<strong>授权类</strong>。</p>
<h4 id="通用类"><a href="#通用类" class="headerlink" title="通用类"></a>通用类</h4><p>通用类是由 JAAS 身份验证和授权组件共享的类。</p>
<p>关键的 JAAS 类是 javax.security.auth.Subject，它表示单个实体(如个人)的相关信息的分组。它包含实体的主体、公共凭证和私有凭证。</p>
<ul>
<li><p>Subject</p>
<p>要授权对资源的访问，应用程序首先需要对请求的源进行身份验证。JAAS 框架定义了 Subject 这个术语来表示请求的来源。Subject 可以是任何实体，如个人或服务。一旦主体被认证，一个 javax.security.auth.Subject 由相关的标识或身份(Principal)填充。</p>
<p>Subject 还可以拥有与安全性相关的属性，这些属性称为凭据。需要特殊保护的敏感凭据(如私有密钥)存储在私有凭据集中。要共享的凭据(如公钥证书)存储在公共凭据集中。访问和修改不同的凭据集需要不同的权限。</p>
<p><strong>doAs versus doAsPrivileged</strong></p>
<p>doAsPrivileged 方法的行为与 doAs 方法完全相同，只是它们没有将提供的 Subject 与当前 Thread 的 AccessControlContext 关联起来，而是使用提供的 AccessControlContext。通过这种方式，可以通过与当前的 AccessControlContexts 不同的方式来限制操作。</p>
</li>
<li><p>Principals</p>
<p>一个主体(Subject)可能会有多个身份(Principal)。</p>
</li>
<li><p>Credentials</p>
<p>除了关联的主体之外，Subject 还可以拥有与安全相关的属性，这些属性称为凭据。凭据可以包含用于对新服务的主题进行身份验证的信息。这些凭据包括密码、 Kerberos 票证和公钥证书。凭据还可能包含仅允许主体执行某些活动的数据。例如，加密密钥表示允许主体签名或加密数据的凭据。公共和私有凭据类不是核心 JAAS 类库的一部分。因此，任何类都可以表示凭据。</p>
<p>公共和私有凭据类不是核心 JAAS 类库的一部分。然而，开发者可能会选择让他们的凭证类实现与凭证相关的两个接口:  Refreshable 和 Destroyable。</p>
<ul>
<li><code>javax.security.auth.Refreshable</code> 接口提供了凭据刷新自身的功能。</li>
<li><code>javax.security.auth.Destroyable</code> 接口提供了销毁凭证内容的功能。</li>
</ul>
</li>
</ul>
<h4 id="身份验证类和接口"><a href="#身份验证类和接口" class="headerlink" title="身份验证类和接口"></a>身份验证类和接口</h4><p>身份验证代表验证主体身份的过程，并且必须以安全的方式执行; 否则犯罪者可能冒充他人以获得对系统的访问权。认证通常涉及主体提供某种形式的凭证来证明其身份。这种证据可能是只有当事人可能知道或拥有的信息(如密码或指纹) ，也可能是只有当事人可以提供的信息(如使用私人钥匙签名的数据)。</p>
<ul>
<li><p>LoginContext</p>
<p>LoginContext 类提供了用于对 Subject 进行身份验证的基本方法，并提供了一种独立于底层身份验证技术的应用程序开发方法。LoginContext 查询 Configuration 以确定为特定应用程序配置的身份验证服务或 LoginModule。因此，可以在应用程序下插入不同的 LoginModule，而不需要对应用程序本身进行任何修改。</p>
</li>
<li><p>LoginModule</p>
<p>LoginModule 接口使开发人员能够实现应用程序下可以插入的各种身份验证技术。例如，一种类型的 LoginModule 可能执行基于用户名/密码的身份验证形式。其他的 LoginModule 可以与硬件设备接口，如智能卡或生物识别设备。</p>
</li>
<li><p>CallbackHandler</p>
<p>在某些情况下，LoginModule 必须与用户通信以获取身份验证信息。</p>
<p>应用程序实现 CallbackHandler 接口并将其传递给 LoginContext，后者直接将其转发给底层 LoginModules。LoginModule 使用 CallbackHandler 收集用户的输入(例如密码或智能卡密码) ，或者向用户提供信息(例如状态信息)。通过允许应用程序指定 CallbackHandler，底层 LoginModules 可以保持独立于应用程序与用户交互的不同方式。</p>
<p>LoginModule 向 CallbackHandler handle 方法传递一个适当的 Callbacks 数组，例如用于用户名的 NameCallback 和用于密码的 PasswordCallback，CallbackHandler 执行请求的用户交互并在 Callbacks 中设置适当的值。例如，要处理 NameCallback，CallbackHandler 可能会提示输入名称，从用户检索值，并调用 NameCallback 的 setName 方法来存储名称。</p>
</li>
<li><p>Callback</p>
<p>LoginModules 可以直接将 Callback 数组传递给 CallbackHandler 的 handle 方法。</p>
</li>
</ul>
<h4 id="授权类"><a href="#授权类" class="headerlink" title="授权类"></a>授权类</h4><p>要使 JAAS 授权发生，授予访问控制权限不仅要基于运行的代码，还要基于运行代码的人，需要以下几点：</p>
<ol>
<li><p>必须经过身份验证</p>
</li>
<li><p>身份验证结果的主体(Subject)必须与访问控制上下文关联</p>
</li>
<li><p>必须在安全策略中配置基于身份(Principal)的项</p>
</li>
</ol>
<ul>
<li><p>Policy</p>
<p>策略类是用于表示系统范围的访问控制策略的抽象类。策略 API 支持基于身份(Principal)的查询。</p>
<p>缺省情况下，JDK 提供了一个基于文件的子类实现，它被升级为支持策略文件中基于身份的授权条目。</p>
</li>
<li><p>AuthPermission<br>当前，AuthPermission 对象用于保护对 Policy、 Subject、 LoginContext 和 Configuration 对象的访问。</p>
</li>
</ul>
<h3 id="java-Security-Properties-文件中的-JAAS-设置"><a href="#java-Security-Properties-文件中的-JAAS-设置" class="headerlink" title="java.Security Properties 文件中的 JAAS 设置"></a>java.Security Properties 文件中的 JAAS 设置</h3><p>许多与 JAAS 相关的设置可以在 java.Security 主安全属性文件中配置，该文件位于 JDK 的 conf/Security 目录中。</p>
<ul>
<li><p>Login Configuration Provider</p>
<p>默认的 JAAS 登录配置实现可以通过在 login.configuration.provider 属性中指定替代的 provider 类实现来替换。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">login.configuration.provider</span>=<span class="string">com.foo.Config</span></span><br></pre></td></tr></table></figure>
<p>如果没有找到 Security 属性 login.configuration.provider，或者没有指定，那么它将被设置为缺省值:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">login.configuration.provider</span>=<span class="string">com.sun.security.auth.login.ConfigFile</span></span><br></pre></td></tr></table></figure>
<p><strong>注意，没有办法从命令行动态设置登录配置提供程序。</strong></p>
</li>
<li><p>Login Configuration URLs</p>
<p>如果使用的登录配置实现期望在文件中指定配置信息，则可以通过在 login.configurl.n 属性中指定各自的 url 静态设置登录配置文件的位置。N’是一个连续编号的整数，从1开始。如果指定了多个配置文件(如果 n &gt; = 2) ，它们将被读取并合并为单个配置。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">login.config.url.1</span>=<span class="string">file:C:/config/.java.login.config</span></span><br><span class="line"><span class="meta">login.config.url.2</span>=<span class="string">file:C:/users/foo/.foo.login.config</span></span><br></pre></td></tr></table></figure>
<p>如果配置文件的位置没有在 java.security 属性文件中设置，也没有在命令行中动态指定(通过-Djava.security.auth.login.config 选项) ，JAAS 将尝试从 <code>file:$&#123;user.home&#125;/.java.login.config</code> 加载默认配置。</p>
</li>
<li><p>Policy Provider</p>
<p>可以通过在 policy.provider 属性中指定替代提供程序类实现来替换默认策略实现。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">policy.provider</span>=<span class="string">com.foo.Policy</span></span><br></pre></td></tr></table></figure>
<p>如果找不到 Security 属性 Policy.provider，或者未指定，则策略将设置为默认值:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">policy.provider</span>=<span class="string">sun.security.provider.PolicyFile</span></span><br></pre></td></tr></table></figure>
<p><strong>请注意，不存在从命令行动态设置策略提供程序的方法。</strong></p>
</li>
<li><p>Policy File URLs</p>
<p>通过在 auth.policy.url.n 属性中指定各自的 url，可以静态设置访问控制策略文件的位置。N 是一个连续编号的整数，从1开始。如果指定了多个策略(如果 n &gt; = 2) ，它们将被读取并合并为一个策略。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">policy.url.1</span>=<span class="string">file:C:/policy/.java.policy</span></span><br><span class="line"><span class="meta">policy.url.2</span>=<span class="string">file:C:/users/foo/.foo.policy</span></span><br></pre></td></tr></table></figure>
<p>如果策略文件的位置没有在 java.security 属性文件中设置，也没有从命令行(通过 -Djava.security.policy 选项)动态指定，那么访问控制策略默认为与 JDK 安装的系统策略文件相同的策略。</p>
<ul>
<li>将所有权限授予标准扩展</li>
<li>允许任何人监听非特权端口</li>
<li>允许任何代码读取某些不敏感于安全性的“标准”属性，如 os.name 和 file.separator 属性。</li>
</ul>
</li>
</ul>
<h2 id="JAAS-教程和示例程序"><a href="#JAAS-教程和示例程序" class="headerlink" title="JAAS 教程和示例程序"></a>JAAS 教程和示例程序</h2><p><a target="_blank" rel="noopener" href="https://github.com/shankai/sample-jaas">https://github.com/shankai/sample-jaas</a></p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/security/java-authentication-and-authorization-service-jaas1.html">https://docs.oracle.com/en/java/javase/11/security/java-authentication-and-authorization-service-jaas1.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/23/kafka-connect-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="shankai">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="零壹">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/23/kafka-connect-notes/" class="post-title-link" itemprop="url">Kafka Connect 笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-23 22:20:00" itemprop="dateCreated datePublished" datetime="2021-02-23T22:20:00+08:00">2021-02-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-24 10:37:19" itemprop="dateModified" datetime="2021-02-24T10:37:19+08:00">2021-02-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/EventBus/" itemprop="url" rel="index"><span itemprop="name">EventBus</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h2><p>Kafka Connect 是一个可伸缩、可靠地在 Apache Kafka 和其他系统之间传输数据的工具框架。</p>
<p>Kafka Connect 功能特性：</p>
<ul>
<li><strong>通用框架</strong> Kafka Connect 为其他系统与 Kafka 集成提供了标准化，简化了 Connector 开发、部署和管理。</li>
<li><strong>分布式和独立模式</strong> Kafka Connect 扩展到支持整个组织的大型集中管理服务，或者缩减到开发、测试和小型生产部署。</li>
<li><strong>REST 接口</strong> 通过一个易于使用的 REST API 向 Kafka Connect 集群提交和管理连接器。</li>
<li><strong>自动偏移量管理</strong> 只需要从连接器获得一点点信息，Kafka Connect 就可以自动管理偏移提交过程，因此连接器开发人员不必担心连接器开发中容易出错的部分。</li>
<li><strong>默认分布式可伸缩</strong> Kafka Connect 基于现有的组管理协议，可以添加更多的 Worker 来扩展 Kafka Connect 集群。</li>
<li><strong>流/批处理集成</strong> Kafka Connect 是连接流式和批处理数据系统的理想解决方案。</li>
</ul>
<h2 id="Concept"><a href="#Concept" class="headerlink" title="Concept"></a>Concept</h2><ul>
<li>Connectors  通过管理任务来协调数据流的高级抽象</li>
<li>Tasks 实现从 Kafka 读取数据或将数据写入 Kafka</li>
<li>Workers 用于执行 Connectors 与 Tasks 的服务进程</li>
<li>Converters 用于实现在 Kafka 与目标/源系统之间的数据转换程序</li>
<li>Transforms 用于转换通过 Connect 的每条数据的简单逻辑实现</li>
<li>Dead Letter Queue 死信队列，用于处理连接器错误</li>
</ul>
<h3 id="Connectors"><a href="#Connectors" class="headerlink" title="Connectors"></a>Connectors</h3><p>Kafka Connect 中的 Connector 定义数据应该从哪里复制或复制到哪里去。Connector 实例是一个逻辑工作，负责管理 Kafka 和另一个系统之间的数据复制。</p>
<p>连接器模型</p>
<p><img src="/images/kafka/connector-model-simple.png" alt="connector-model-simple"></p>
<h4 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h4><p>Connector Configuration 配置是简单的键值映射。</p>
<p>对于独立（Standalone）模式，它们在属性文件中定义，并在命令行上传递给 Connect 进程。</p>
<p>在分布式（Distributed）模式，它们将包含在创建(或修改) Connector 的 REST 请求的 JSON 有效负载中。</p>
<p>通用的配置：</p>
<ul>
<li><code>name</code> Connector 的唯一名称。再次尝试注册相同名称将会失败。</li>
<li><code>connector.class</code> Connector 的 Java 类，<br>（多种格式，如org.apache.kafka.connect.file.FileStreamSinkConnector、FileStreamSink、FileStreamSinkConnector）</li>
<li><code>tasks.max</code> 为此 Connector 应创建的最大任务数。如果 Connector 无法实现此级别的并行性，则可以创建较少的任务。</li>
<li><code>key.converter</code> - (可选) 覆盖由 Worker 设置的默认键转换器。</li>
<li><code>value.converter</code> - (可选) 覆盖由 Worker 设置的默认值转换器。</li>
</ul>
<p>Sink Connector 还需要设置下列其中一个配置项：</p>
<ul>
<li><code>topics</code> 用逗号分隔的主题列表，用作此 Connector 的输入。</li>
<li><code>topics.regex</code> 用 Java 正则表达式匹配到的主题，用作此 Connector 的输入。</li>
</ul>
<p>更多的配置项，将由具体的 Connector 提供文档说明。</p>
<h3 id="Tasks"><a href="#Tasks" class="headerlink" title="Tasks"></a>Tasks</h3><p>Task 是用于连接的数据模型中的主要参与者。每个 Connector 实例协调一组实际复制数据的 Task。通过允许 Connector 将单个工作分解成多个 Task，Kafka Connect 对并行和可伸缩的数据复制提供了很好的支持，且只需要很少的配置。这些 Task 中没有存储状态。Task 状态存储在 Kafka 的特殊主题 config.storage 和 status.storage，并由关联连接器管理。因此，可以在任何时候启动、停止或重新启动 Task，以提供一个弹性的、可伸缩的数据管道。</p>
<p><img src="/images/kafka/data-model-simple.png" alt="data-model-simple" title="Data Model"></p>
<h4 id="Task-Rebalancing"><a href="#Task-Rebalancing" class="headerlink" title="Task Rebalancing"></a>Task Rebalancing</h4><p>当 Connector 首次提交给集群时，Worker 将重新平衡集群中的全部 Connectors 集及其 Tasks，以便每个 Worker 的工作量大致相同。</p>
<p>当 Connector 增加或减少它们所需的 Task 数量时，或者当 Connector 的配置更改时，也使用同样的重新平衡过程。</p>
<p>当一个 Worker 失败时，Task 会在活跃的 Worker 之间重新平衡。</p>
<p>当 Task 失败时，不会触发 Task 失败的再平衡，因为 Task 失败被认为是一个特例。因此，失败的 Task 不会由框架自动重新启动，应该通过 REST API 重新启动。</p>
<p>下图为 Worker 失败时 Task 故障转移示例</p>
<p><img src="/images/kafka/task-failover.png" alt="task-failover" title="Task 故障转移"></p>
<h3 id="Workers"><a href="#Workers" class="headerlink" title="Workers"></a>Workers</h3><p>Connectors 和 Tasks 是必须在进程中执行的逻辑工作单元，Kafka Connect 称这些进程为 Worker。</p>
<p>有两种类型的 Worker: <code>Standalone</code> 和 <code>Distributed</code>。</p>
<h4 id="Standalone"><a href="#Standalone" class="headerlink" title="Standalone"></a>Standalone</h4><p>Standalone 模式是最简单的模式，其中单个进程负责执行所有连接器和任务。因为它是一个单一的进程，所以只需要最少的配置。在开发过程中，以及在某些只有一个进程有意义的情况下，如从主机收集日志时，Standalone 模式非常方便。但是，由于只有一个进程，它的功能也更有限：可伸缩性仅限于单个进程，除了添加到单个进程的任何监视之外，没有容错能力。</p>
<h4 id="Distributed"><a href="#Distributed" class="headerlink" title="Distributed"></a>Distributed</h4><p>Distributed 模式为 Kafka Connect 提供了可伸缩性和自动容错能力。在 Distributed 模式下，使用相同的 <code>group.id</code> 启动许多辅助进程，它们自动协调来调度所有可用辅助 Workers 之间的Connectors 和 Tasks 的执行。如果添加了一个 Worker，关闭了一个 Worker，或者一个 Worker 意外地失败了，其余的 Worker 会检测到这一点，并自动协调在更新的可用 Workers 集中重新分配 Connectors 和 Tasks。请注意它们与 Consumer Group 再平衡的相似之处，在掩护之下，Worker 正在利用 Consumer Group 来协调和平衡。</p>
<p><img src="/images/kafka/worker-model-basics.png" alt="worker-model-basics" title="Worker 模型"></p>
<h3 id="Converters"><a href="#Converters" class="headerlink" title="Converters"></a>Converters</h3><p>当写入或从 Kafka 读取数据时，必须有一个 Kafka Connect 部署支持特定的数据格式。任务使用转换器将数据格式从字节转换为 Connect 内部数据格式，反之亦然。</p>
<ul>
<li><strong>AvroConverter</strong> <code>io.confluent.connect.avro.AvroConverter</code> 使用 <a target="_blank" rel="noopener" href="https://docs.confluent.io/platform/current/schema-registry/connect.html#schemaregistry-kafka-connect">Schema Registry</a></li>
<li><strong>ProtobufConverter</strong> <code>io.confluent.connect.protobuf.ProtobufConverter</code> 使用 <a target="_blank" rel="noopener" href="https://docs.confluent.io/platform/current/schema-registry/connect.html#schemaregistry-kafka-connect">Schema Registry</a></li>
<li><strong>JsonSchemaConverter</strong> <code>io.confluent.connect.json.JsonSchemaConverter</code>  使用 <a target="_blank" rel="noopener" href="https://docs.confluent.io/platform/current/schema-registry/connect.html#schemaregistry-kafka-connect">Schema Registry</a></li>
<li><strong>JsonConverter</strong> <code>org.apache.kafka.connect.json.JsonConverter</code> (没有模式注册表):与结构化数据一起使用</li>
<li><strong>StringConverter</strong> <code>org.apache.kafka.connect.storage.StringConverter</code>简单的字符串格式</li>
<li><strong>ByteArrayConverter</strong> <code>org.apache.kafka.connect.converters.ByteArrayConverter</code>提供不进行转换的“直通”选项</li>
</ul>
<h4 id="Converter-Graphic"><a href="#Converter-Graphic" class="headerlink" title="Converter Graphic"></a>Converter Graphic</h4><p><img src="/images/kafka/converter-basics.png" alt="converter-basics" title="SourceConnector &amp; SinkConnector"></p>
<h3 id="Transforms"><a href="#Transforms" class="headerlink" title="Transforms"></a>Transforms</h3><p>单个消息转换（Single Message Transformations，下列简称SMT）应用于通过 Connect 的消息。</p>
<p>SMT 在源连接器（Source Connector）生成入站消息之后进行转换，但在它们被写入Kafka之前进行转换。<br>SMT 在出站消息发送到接收器连接器（Sink Connecors）之前对其进行转换。</p>
<p>可以在连接器配置中指定转换链。</p>
<ul>
<li><code>transforms</code> 转换别名列表，指定应用转换的顺序。</li>
<li><code>transforms.$alias.type</code> 转换的完全限定类名。</li>
<li><code>transforms.$alias.$transformationSpecificConfig</code> 转换的配置属性。</li>
</ul>
<p>示例：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># connector common config</span></span><br><span class="line"><span class="attr">name</span>=<span class="string">local-file-source</span></span><br><span class="line"><span class="meta">connector.class</span>=<span class="string">FileStreamSource</span></span><br><span class="line"><span class="meta">tasks.max</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">file</span>=<span class="string">test.txt</span></span><br><span class="line"><span class="attr">topic</span>=<span class="string">connect-test</span></span><br><span class="line"><span class="comment"># transforms chain: MakeMap--InsertSource</span></span><br><span class="line"><span class="attr">transforms</span>=<span class="string">MakeMap, InsertSource</span></span><br><span class="line"><span class="comment"># config for MakeMap transform</span></span><br><span class="line"><span class="meta">transforms.MakeMap.type</span>=<span class="string">org.apache.kafka.connect.transforms.HoistField$Value</span></span><br><span class="line"><span class="meta">transforms.MakeMap.field</span>=<span class="string">line</span></span><br><span class="line"><span class="comment"># config for InsertSource transform</span></span><br><span class="line"><span class="meta">transforms.InsertSource.type</span>=<span class="string">org.apache.kafka.connect.transforms.InsertField$Value</span></span><br><span class="line"><span class="meta">transforms.InsertSource.static.field</span>=<span class="string">data_source</span></span><br><span class="line"><span class="meta">transforms.InsertSource.static.value</span>=<span class="string">test-file-source</span></span><br></pre></td></tr></table></figure>
<p>Kafka Connect 包含了一些广泛适用的数据和路由转换：</p>
<ul>
<li><code>InsertField</code> 使用静态数据或记录元数据添加字段</li>
<li><code>ReplaceField</code> 过滤或重命名字段</li>
<li><code>MaskField</code>将字段替换为类型的有效null值(如 0，false 及空字符串等等)</li>
<li><code>ValueToKey</code> 将记录键替换为由记录值中的字段子集形成的新键</li>
<li><code>HoistField</code> 将整个事件作为单个字段包装在结构或映射中</li>
<li><code>ExtractField</code>从 Struct 和 Map 中提取一个特定的字段，并在结果中只包含这个字段</li>
<li><code>SetSchemaMetadata</code> 修改模式名称或版本</li>
<li><code>TimestampRouter</code>基于原始主题和时间戳修改记录的主题。当使用接收器时，需要根据时间戳写入不同的表或索引</li>
<li><code>RegexRouter</code> 基于原始主题、替换字符串和正则表达式修改记录的主题</li>
</ul>
<h3 id="Dead-Letter-Queue"><a href="#Dead-Letter-Queue" class="headerlink" title="Dead Letter Queue"></a>Dead Letter Queue</h3><p>出现无效记录的原因有很多。一个例子是，当一条记录以 JSON 格式序列化到达 Sink Connector 时，但 Sink Connector 配置要求为 Avro 格式。当 Sink Connector 无法处理无效记录时，将根据 Connector 配置属性 <code>errors.tolerance</code> （错误容忍）处理错误。<strong>Dead Letter Queue 仅适用于 Sink Connector。</strong></p>
<p>此配置属性有两个有效值: <code>none</code> (默认值)或 <code>all</code>。</p>
<p>当 <code>errors.tolerance</code> 设置为 <code>none</code> 时，错误或无效记录将导致 Connector Task 立即失败，并且 Connector 进入失败状态。要解决此问题，需要查看 Kafka Connect Worker 日志以找出导致故障的原因，进行纠正，然后重新启动 Connector。</p>
<p>当 <code>errors.tolerance</code> 设置为 <code>all</code> 时，将忽略所有错误或无效记录，并继续处理。Connect Worker 日志中没有写入错误。为了确定记录是否失败，必须使用内部度量或计算源处的记录数量，并将其与所处理的记录数量进行比较。</p>
<p>有一个错误处理特性，它将把所有无效的记录路由到一个特殊的主题并报告错误。该主题包含 Sink Connector 无法处理的记录的 <strong>Dead Letter Queue</strong>。</p>
<p>SinkConnector 配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">errors.tolerance</span> = <span class="string">all</span></span><br><span class="line"><span class="meta">errors.deadletterqueue.topic.name</span> = <span class="string">&lt;dead-letter-topic-name&gt;</span></span><br></pre></td></tr></table></figure>
<p>即使 <strong>Dead Letter Queue</strong> 包含失败的记录，它也没有显示原因。可以添加以下附加配置属性以包含失败的记录头信息。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">errors.deadletterqueue.context.headers.enable</span> = <span class="string">true</span></span><br></pre></td></tr></table></figure>


<p>当该参数设置为 <code>true</code> (默认为<code>false</code>)时，记录头被添加到死信队列中。然后可以查看记录头，并确定记录失败的原因。错误也被发送到 <a target="_blank" rel="noopener" href="https://docs.confluent.io/home/connect/userguide.html#userguide-connect-reporter">Connect Reporter</a>。为了避免与原始记录头冲突，<strong>Dead Letter Queue</strong> 上下文头键以 <code>_connect.errors</code> 开头。</p>
<h2 id="Deployment-Configuration"><a href="#Deployment-Configuration" class="headerlink" title="Deployment Configuration"></a>Deployment Configuration</h2><p>Common（Standalone &amp; Distributed）</p>
<ul>
<li><code>bootstrap.servers</code> Kafka 服务器列表。</li>
<li><code>key.converter</code> 用于在 Kafka 连接格式和写入 Kafka 的序列化格式之间转换的转换器类。它控制了写入或从 Kafka 读取的消息中的<strong>键</strong>的格式，并且由于它独立于连接器，它允许任何连接器使用任何序列化格式。常见的格式包括JSON和Avro。</li>
<li><code>value.converter</code> 用于在 Kafka 连接格式和写入 Kafka 的序列化格式之间转换的转换器类。它控制了写入或从 Kafka 读取的消息中的<strong>值</strong>的格式，并且由于它独立于连接器，它允许任何连接器使用任何序列化格式。常见的格式包括JSON和Avro。</li>
</ul>
<p>Standalone</p>
<ul>
<li><code>offset.storage.file.filename</code> 文件中存储偏移量数据</li>
</ul>
<p>Distributed</p>
<ul>
<li><code>group.id</code> (默认为 connect-cluster`) 集群的唯一名称，用于形成Connect集群组；<strong>注意，这一定不能与消费组id冲突</strong></li>
<li><code>config.storage.topic</code> (默认为<code>connect-configs</code>) 用于存储 Connector 和 Task 配置的主题；注意，这应该是一个单独的分区，高度复制，压缩主题（您可能需要手动创建主题，以确保正确的配置，因为自动创建的主题可能有多个分区，或者自动配置为删除而不是压缩）</li>
<li><code>offset.storage.topic</code> (默认为 <code>connect-offsets</code>) 用于存储偏移量的主题；这个主题应该有许多分区，可以复制，并配置为压缩</li>
<li><code>status.storage.topic</code> (默认为 <code>connect-status</code>) 用于存储状态的主题；这个主题可以有多个分区，应该进行复制和配置以进行压缩</li>
</ul>
<h2 id="Connect-Plugins"><a href="#Connect-Plugins" class="headerlink" title="Connect Plugins"></a>Connect Plugins</h2><p>Kafka Connect 被设计为可扩展的，因此开发人员可以创建自定义连接器(Connectors)，变形器(Transforms)或转换器(Converters)，用户可以安装和运行它们。</p>
<p>Kafka Connect 插件是一组 JAR 文件，其中包含一个或多个 Connectors、Transforms 或 Converters 的实现。Connect 将每个插件彼此隔离，这样一个插件中的库就不会受到任何其他插件中的库的影响。这在混合和匹配来自多个供应商的连接器时非常重要。</p>
<p>一个 Kafka Connect 插件可以是：</p>
<ul>
<li><p>文件系统上的一个目录，包含所有需要的 JAR 文件和插件的第三方依赖项。<strong>这是最常见和首选的。</strong></p>
</li>
<li><p>一个包含插件及其第三方依赖项的所有类文件的 uber JAR。</p>
<p>(<code>Über</code> is the German word for <code>above</code> or <code>over</code> (it’s actually cognate with the English <code>over</code>).  <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/11947037/what-is-an-uber-jar">https://stackoverflow.com/questions/11947037/what-is-an-uber-jar</a>)</p>
</li>
</ul>
<blockquote>
<p><strong>一个插件不应该包含 Kafka Connect 运行时提供的任何库。</strong></p>
</blockquote>
<p>Kafka Connect 在 Worker Configuration 的  <code>plugin.path</code> 属性中使用一个以逗号分隔的目录路径列表定义的插件路径查找插件。</p>
<p>当启动 Connect Worker 时，每个 Worker 都会在插件路径的目录中发现所有 Connectors、Transforms 和 Converters 插件。当使用 Connectors、Transforms 和 Converters 时，Connect Worker 首先从各自的插件加载类，然后是 Kafka Connect 运行时和 Java 库。</p>
<h2 id="Connect-API"><a href="#Connect-API" class="headerlink" title="Connect API"></a>Connect API</h2><h3 id="Java-API"><a href="#Java-API" class="headerlink" title="Java API"></a>Java API</h3><blockquote>
<p>本节列举了一般需要重写的方法，更详尽的 Java API 请参见</p>
<p><a target="_blank" rel="noopener" href="http://kafka.apache.org/24/javadoc/index.html?org/apache/kafka/connect">http://kafka.apache.org/24/javadoc/index.html?org/apache/kafka/connect</a></p>
</blockquote>
<h4 id="SinkConnector"><a href="#SinkConnector" class="headerlink" title="SinkConnector"></a>SinkConnector</h4><ul>
<li><code>public abstract void start(Map&lt;String,String&gt; props)</code><br>启动这个连接器。这个方法只会在一个干净的连接器上被调用，也就是说，它要么刚刚被实例化和初始化，要么已经调用了stop()。</li>
<li><code>public abstract void stop()</code><br>停止这个连接器。</li>
<li><code>public abstract Class&lt;? extends Task&gt; taskClass()</code><br>返回此连接器的任务实现。</li>
<li><code>public abstract ConfigDef config()</code><br>定义连接器的配置。</li>
<li><code>public abstract List&lt;Map&lt;String,String&gt;&gt; taskConfigs(int maxTasks)</code><br>根据当前配置返回任务的一组配置。</li>
<li><code>String version()</code><br>获取该连接器的版本。</li>
</ul>
<h4 id="SinkTask"><a href="#SinkTask" class="headerlink" title="SinkTask"></a>SinkTask</h4><ul>
<li><code>public abstract void start(Map&lt;String,String&gt; props)</code><br>启动任务。这应该可以处理任何配置解析和任务的一次性设置。</li>
<li><code>public abstract void put(Collection&lt;SinkRecord&gt; records)</code><br>将事件记录数据传递到此任务。</li>
<li><code>public abstract void stop()</code><br>执行清理操作以停止此任务。</li>
<li><code>String version()</code><br>获取此任务的版本。通常这应该与对应的连接器类的版本相同。</li>
</ul>
<h3 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a>REST API</h3><blockquote>
<p>Default Port: <code>8083</code></p>
</blockquote>
<ul>
<li><code>GET /connectors</code> 返回连接器的列表。</li>
<li><code>POST /connectors</code> 创建一个新的连接器。请求主体应该是一个JSON对象，其中包含一个字符串 <code>name</code> 字段和一个带有连接器 <code>config</code> 参数的对象配置字段。</li>
<li><code>GET /connectors/&#123;name&#125;</code>获取指定连接器的信息。</li>
<li><code>GET /connectors/&#123;name&#125;/config</code> 获取指定连接器的配置参数。</li>
<li><code>PUT /connectors/&#123;name&#125;/config</code> 更新指定连接器的配置参数。</li>
<li><code>GET /connectors/&#123;name&#125;/status</code> 获取连接器的当前状态，包括它是否正在运行、失败、暂停等、它被分配给哪个工作器、失败时的错误信息以及它所有任务的状态。<ul>
<li><code>UNASSIGNED</code>: Connector/Task 暂未分配到 Worker。</li>
<li><code>RUNNING</code>: Connector/Task 正在运行。</li>
<li><code>PAUSED</code>: Connector/Task 在管理上已暂停。</li>
<li><code>FAILED</code>: Connector/Task 运行失败，通常是发生了异常。</li>
<li><code>DESTROYED</code>: Connector/Task 在管理上已被删除，将被移除集群。</li>
</ul>
</li>
<li><code>GET /connectors/&#123;name&#125;/tasks</code> 获取连接器当前正在运行的任务列表。</li>
<li><code>GET /connectors/&#123;name&#125;/tasks/&#123;taskid&#125;/status</code> 获取任务的当前状态，包括它是否正在运行、失败、暂停等，它被分配给哪个 Worker，以及失败时的错误信息。</li>
<li><code>PUT /connectors/&#123;name&#125;/pause</code> 暂停连接器及其任务，这将停止消息处理，直到连接器恢复。</li>
<li><code>PUT /connectors/&#123;name&#125;/resume</code> 恢复暂停的连接器(如果连接器没有暂停，则不做任何操作)。</li>
<li><code>POST /connectors/&#123;name&#125;/restart</code> 重新启动连接器(通常是因为它失败了)。</li>
<li><code>POST /connectors/&#123;name&#125;/tasks/&#123;taskId&#125;/restart</code> 重新启动单个任务(通常是因为它失败了)。</li>
<li><code>DELETE /connectors/&#123;name&#125;</code> 删除连接器，停止所有任务并删除其配置。</li>
<li><code>GET /connector-plugins</code> 返回一个Kafka Connect集群中安装的连接器插件列表。</li>
<li><code>PUT /connector-plugins/&#123;connector-type&#125;/config/validate</code> 根据配置定义验证提供的配置值。这个API执行每个配置验证，并在验证过程中返回建议值和错误消息。</li>
</ul>
<h3 id="Ops"><a href="#Ops" class="headerlink" title="Ops"></a>Ops</h3><h4 id="Kafka-Connect-Logging"><a href="#Kafka-Connect-Logging" class="headerlink" title="Kafka Connect Logging"></a>Kafka Connect Logging</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.confluent.io/platform/current/connect/logging.html#">https://docs.confluent.io/platform/current/connect/logging.html#</a></p>
</blockquote>
<ul>
<li><p>Check log levels</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -Ss http:&#x2F;&#x2F;localhost:8083&#x2F;admin&#x2F;loggers | jq</span><br></pre></td></tr></table></figure></li>
<li><p>Change the log level for a specific logger</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -s -X PUT -H &quot;Content-Type:application&#x2F;json&quot; \</span><br><span class="line">http:&#x2F;&#x2F;localhost:8083&#x2F;admin&#x2F;loggers&#x2F;city.icos.icmsevent.connect \</span><br><span class="line">-d &#39;&#123;&quot;level&quot;: &quot;DEBUG&quot;&#125;&#39; | jq &#39;.&#39;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h2 id="Lenses-io"><a href="#Lenses-io" class="headerlink" title="Lenses.io"></a>Lenses.io</h2><h3 id="Kakfa-Connect-UI"><a href="#Kakfa-Connect-UI" class="headerlink" title="Kakfa Connect UI"></a>Kakfa Connect UI</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/lensesio/kafka-connect-ui">https://github.com/lensesio/kafka-connect-ui</a></p>
</blockquote>
<h3 id="Kafka-Connect-CLI"><a href="#Kafka-Connect-CLI" class="headerlink" title="Kafka Connect CLI"></a>Kafka Connect CLI</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/lensesio/kafka-connect-tools">https://github.com/lensesio/kafka-connect-tools</a></p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">connect-cli 1.0.8</span><br><span class="line">Usage: connect-cli [ps|get|rm|create|run|diff|status|plugins|describe|validate|restart|pause|resume] [options] [<span class="xml"><span class="tag">&lt;<span class="name">connector-name</span>&gt;</span></span>]</span><br><span class="line"></span><br><span class="line">  --help</span><br><span class="line"><span class="code">        prints this usage text</span></span><br><span class="line"><span class="code">  -e &lt;value&gt; | --endpoint &lt;value&gt;</span></span><br><span class="line"><span class="code">        Kafka Connect REST URL, default is http://localhost:8083/</span></span><br><span class="line"><span class="code">  -f &lt;value&gt; | --format &lt;value&gt;</span></span><br><span class="line"><span class="code">        Format of the config, default is PROPERTIES. Valid options are &#x27;properties&#x27; and &#x27;json&#x27;.</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">  Command: ps</span></span><br><span class="line"><span class="code">  list active connectors names.</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">  Command: get</span></span><br><span class="line"><span class="code">  get the configuration of the specified connector.</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">  Command: rm</span></span><br><span class="line"><span class="code">  remove the specified connector.</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">  Command: create</span></span><br><span class="line"><span class="code">  create the specified connector with the config from stdin; the connector cannot already exist.</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">  Command: run</span></span><br><span class="line"><span class="code">  create or update the specified connector with the config from stdin.</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">  Command: diff</span></span><br><span class="line"><span class="code">  diff the specified connector with the config from stdin.</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">  Command: status</span></span><br><span class="line"><span class="code">  get connector and it&#x27;s task(s) state(s).</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">  Command: plugins</span></span><br><span class="line"><span class="code">  list the available connector class plugins on the classpath.</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">  Command: describe</span></span><br><span class="line"><span class="code">  list the configurations for a connector class plugin on the classpath.</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">  Command: pause</span></span><br><span class="line"><span class="code">  pause the specified connector.</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">  Command: restart</span></span><br><span class="line"><span class="code">  restart the specified connector.</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">  Command: resume</span></span><br><span class="line"><span class="code">  resume the specified connector.</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">  Command: validate</span></span><br><span class="line"><span class="code">  validate the connector config from stdin against a connector class plugin on the classpath.</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">  Command: task_ps</span></span><br><span class="line"><span class="code">  list the tasks belonging to a connector.</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">  Command: task_status</span></span><br><span class="line"><span class="code">  get the status of a connector task.</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">  Command: task_restart</span></span><br><span class="line"><span class="code">  restart the specified connector task.</span></span><br></pre></td></tr></table></figure>


<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="http://kafka.apache.org/24/documentation.html#connect">http://kafka.apache.org/24/documentation.html#connect</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.confluent.io/5.5.0/connect/index.html">https://docs.confluent.io/5.5.0/connect/index.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/16/hexo-github-actions-deploy-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="shankai">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="零壹">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/16/hexo-github-actions-deploy-notes/" class="post-title-link" itemprop="url">Hexo Deploy By Github Actions</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-16 13:10:00" itemprop="dateCreated datePublished" datetime="2021-02-16T13:10:00+08:00">2021-02-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-17 17:15:07" itemprop="dateModified" datetime="2021-02-17T17:15:07+08:00">2021-02-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Blog/" itemprop="url" rel="index"><span itemprop="name">Blog</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h2><p>作为个人的技术笔记，将 Hexo Blog 以 Github Pages 的方式对外发布。Hexo Cli 提供了较好的发布方式（<code>hexo deploy</code>），足以满足低频发布操作。</p>
<p>今天的实践是：<strong>通过 Github Actions 来“持续集成”发布 Hexo Blog Site 到 Github Pages</strong>。</p>
<blockquote>
<p>实践的过程中遇到各种问题，对环境做更新：<br>Nodejs:<code>v12.19.0</code>-&gt;<code>v14.15.4</code><br>Hexo: <code>3.9.0</code>-&gt; <code>5.3.0</code></p>
</blockquote>
<h2 id="Github-Actions"><a href="#Github-Actions" class="headerlink" title="Github Actions"></a>Github Actions</h2><blockquote>
<p>GitHub Actions让你很容易自动化所有的软件工作流程，现在拥有世界级的CI/CD。从GitHub上构建、测试和部署你的代码。让代码评审、分支管理和问题分类按照您想要的方式工作。</p>
</blockquote>
<p>Github Actions 特性：<a target="_blank" rel="noopener" href="https://github.com/features/actions">https://github.com/features/actions</a></p>
<p>Github Actions 文档：<a target="_blank" rel="noopener" href="https://docs.github.com/cn/actions">https://docs.github.com/cn/actions</a></p>
<p>Github Actions 市场：<a target="_blank" rel="noopener" href="https://github.com/marketplace?type=actions">https://github.com/marketplace?type=actions</a></p>
<h2 id="Hexo-Action"><a href="#Hexo-Action" class="headerlink" title="Hexo Action"></a>Hexo Action</h2><p>Github Actions 市场已经有了相关的 Action：Hexo Action。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/marketplace/actions/hexo-action">https://github.com/marketplace/actions/hexo-action</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/sma11black/hexo-action">https://github.com/sma11black/hexo-action</a></p>
<h2 id="Operation"><a href="#Operation" class="headerlink" title="Operation"></a>Operation</h2><p>参考 Hexo Action 使用手册，</p>
<ol>
<li>创建密钥对（Github Pages Deploy Keys 使用公钥，Github Source Repos Secrets <code>DEPLOY_KEY</code>使用私钥）；</li>
<li>在 Github Source Repos 添加流程文件，如在 <code>.github/workflows</code> 下创建 <code>deploy.yml</code></li>
</ol>
<p><code>deploy.yml</code> 示例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is a basic workflow to help you get started with Actions</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">CI</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Controls when the action will run. </span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="comment"># Triggers the workflow on push or pull request events but only for the master branch</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [ <span class="string">master</span> ]</span><br><span class="line">  <span class="attr">pull_request:</span></span><br><span class="line">    <span class="attr">branches:</span> [ <span class="string">master</span> ]</span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">A</span> <span class="string">job</span> <span class="string">to</span> <span class="string">deploy</span> <span class="string">blog.</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">submodules:</span> <span class="literal">true</span> <span class="comment"># Checkout private submodules(themes or something else).</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Caching dependencies to speed up workflows. (GitHub will remove any cache entries that have not been accessed in over 7 days.)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Cache</span> <span class="string">node</span> <span class="string">modules</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/cache@v1</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">cache</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">node_modules</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">$&#123;&#123;</span> <span class="string">runner.os</span> <span class="string">&#125;&#125;-node-$&#123;&#123;</span> <span class="string">hashFiles(&#x27;**/package-lock.json&#x27;)</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">restore-keys:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">$&#123;&#123;</span> <span class="string">runner.os</span> <span class="string">&#125;&#125;-node-</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Dependencies</span></span><br><span class="line">      <span class="attr">if:</span> <span class="string">steps.cache.outputs.cache-hit</span> <span class="type">!=</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">npm</span> <span class="string">ci</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Deploy hexo blog website.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Hexo</span> <span class="string">Action</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">deploy</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">sma11black/hexo-action@v1.0.4</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">deploy_key:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.DEPLOY_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">user_name:</span> <span class="string">shankai</span></span><br><span class="line">        <span class="attr">user_email:</span> <span class="string">shankai.kvn@gmail.com</span></span><br><span class="line">        <span class="attr">commit_msg:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.head_commit.message</span> <span class="string">&#125;&#125;</span>  <span class="comment"># (or delete this input setting to use hexo default settings)</span></span><br><span class="line">    <span class="comment"># Use the output from the `deploy` step(use for test action)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Get</span> <span class="string">the</span> <span class="string">output</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">        <span class="string">echo</span> <span class="string">&quot;$<span class="template-variable">&#123;&#123; steps.deploy.outputs.notify &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>


<ul>
<li><code>name</code> Actions 的名称</li>
<li><code>on</code> 触发 Actions 的事件</li>
<li><code>jobs</code> 执行的一系列任务，每个任务是单独的运行环境，<code>runs-on</code>指定运行环境</li>
<li><code>steps</code>任务包含一系列操作步骤，每个步骤是一个 Action，如 Hexo Deploy 本例中使用 <code>uses: sma11black/hexo-action@v1.0.4</code></li>
</ul>
<p>编辑完成 <code>deploy.yml</code> 后提交变更，push 到 Hexo Source Repo。</p>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><ol>
<li><p>将主题 next 作为 git module（Github Actions: hexo-action 用法） </p>
<p>因为 hexo 站点与 next 主题是完全独立的，此处在构建时 next 做为资源依赖参与构建。</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rm -rf themes&#x2F;next</span><br><span class="line">git rm -r themes&#x2F;next</span><br><span class="line">rm -rf .git&#x2F;modules&#x2F;themes&#x2F;next</span><br><span class="line">git submodule add https:&#x2F;&#x2F;github.com&#x2F;theme-next&#x2F;hexo-theme-next themes&#x2F;next</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>远程仓库使用 SSH 方式访问而非 Https</p>
<p>出现的错误：</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fatal: could not read Username <span class="keyword">for</span> <span class="string">&#x27;https://github.com&#x27;</span>: No such device or address</span><br><span class="line">FATAL Something<span class="string">&#x27;s wrong. Maybe you can find the solution here: https://hexo.io/docs/troubleshooting.html</span></span><br><span class="line"><span class="string">Error: Spawn failed</span></span><br><span class="line"><span class="string">    at ChildProcess.&lt;anonymous&gt; (/github/workspace/node_modules/hexo-deployer-git/node_modules/hexo-util/lib/spawn.js:51:21)</span></span><br><span class="line"><span class="string">    at ChildProcess.emit (events.js:314:20)</span></span><br><span class="line"><span class="string">    at Process.ChildProcess._handle.onexit (internal/child_process.js:276:12)</span></span><br></pre></td></tr></table></figure>
<p>修改 hexo/_config.yml 部署相关配置，使用 SSH 方式访问 Github Pages Repo（<a target="_blank" rel="noopener" href="https://github.com/sma11black/hexo-action/issues/5%EF%BC%89">https://github.com/sma11black/hexo-action/issues/5）</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">git@github.com:&lt;username&gt;/&lt;username&gt;.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>


<p>（完）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/01/26/kafka-connect-redis-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="shankai">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="零壹">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/26/kafka-connect-redis-notes/" class="post-title-link" itemprop="url">Kafka Connect Redis</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-26 18:20:00" itemprop="dateCreated datePublished" datetime="2021-01-26T18:20:00+08:00">2021-01-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-16 18:35:12" itemprop="dateModified" datetime="2021-02-16T18:35:12+08:00">2021-02-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/EventBus/" itemprop="url" rel="index"><span itemprop="name">EventBus</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>9.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Kafka-Connect"><a href="#Kafka-Connect" class="headerlink" title="Kafka Connect"></a>Kafka Connect</h2><p>Worker.java (ENABLE_AUTO_COMMIT_CONFIG:false, AUTO_OFFSET_RESET_CONFIG:earliest)</p>
<p>WorkerSinkTask.java</p>
<p><code>offset.flush.interval.ms</code><br>Interval at which to try committing offsets for tasks.<br>Default:    60000 (1 minute)</p>
<p>Confluent Kafka Connect Tutorial</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.confluent.io&#x2F;5.0.0&#x2F;installation&#x2F;docker&#x2F;docs&#x2F;installation&#x2F;connect-avro-jdbc.html</span><br><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;docs.confluent.io&#x2F;5.0.0&#x2F;connect&#x2F;concepts.html#connect-converters</span><br></pre></td></tr></table></figure>



<p>Kafka Connect REST API</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;dev:8083&#x2F;connector-plugins</span><br><span class="line">http:&#x2F;&#x2F;dev:8083&#x2F;connectors</span><br></pre></td></tr></table></figure>


<p>Lenses</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.lenses.io&#x2F;4.1&#x2F;integrations&#x2F;connectors&#x2F;stream-reactor&#x2F;sinks&#x2F;redissinkconnector&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;docs.lenses.io&#x2F;2.1&#x2F;lenses-sql&#x2F;kcql.html</span><br><span class="line"></span><br></pre></td></tr></table></figure>






<p>测试环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># all(zk,kafka,schema-registry,kafka-connect,ui,connectors)</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;lensesio&#x2F;fast-data-dev</span><br><span class="line"></span><br><span class="line"># ui &amp; kafka-connect</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;lensesio&#x2F;kafka-connect-ui</span><br><span class="line">https:&#x2F;&#x2F;hub.docker.com&#x2F;r&#x2F;confluentinc&#x2F;cp-kafka-connect</span><br></pre></td></tr></table></figure>




<h2 id="Build"><a href="#Build" class="headerlink" title="Build"></a>Build</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># clone from fork repository </span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;shankai&#x2F;stream-reactor.git</span><br><span class="line">cd stream-reactor&#x2F;kafka-connect-redis</span><br><span class="line">gradle clean build collectFatJar -x test</span><br></pre></td></tr></table></figure>


<h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><h3 id="All"><a href="#All" class="headerlink" title="All"></a>All</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># redis pubsub mode has bug</span><br><span class="line">docker run --rm -d --name lensesio_dev \</span><br><span class="line">       -p 2181:2181 -p 3030:3030 -p 9092:9092 \</span><br><span class="line">       -p 8081-8083:8081-8083 -p 9581-9585:9581-9585 \</span><br><span class="line">       -e ADV_HOST&#x3D;dev -e CONNECTORS&#x3D;redis \</span><br><span class="line">       lensesio&#x2F;fast-data-dev:latest</span><br><span class="line"></span><br><span class="line"># redis pubsub fix </span><br><span class="line">docker run --rm -d --name lensesio_dev \</span><br><span class="line">       -p 2181:2181 -p 3030:3030 -p 9092:9092 \</span><br><span class="line">       -p 8081-8083:8081-8083 -p 9581-9585:9581-9585 \</span><br><span class="line">       -e ADV_HOST&#x3D;dev -e CONNECTORS&#x3D;redis \</span><br><span class="line">       -v &#x2F;Users&#x2F;shankai&#x2F;codebase&#x2F;oss&#x2F;stream-reactor&#x2F;kafka-connect-redis&#x2F;build&#x2F;libs&#x2F;kafka-connect-redis-2.1.3.jar:&#x2F;opt&#x2F;landoop&#x2F;connectors&#x2F;stream-reactor&#x2F;kafka-connect-redis&#x2F;kafka-connect-redis-2.1.3.jar \</span><br><span class="line">       lensesio&#x2F;fast-data-dev:latest</span><br></pre></td></tr></table></figure>


<h3 id="Kafka-Connect-amp-UI"><a href="#Kafka-Connect-amp-UI" class="headerlink" title="Kafka Connect &amp; UI"></a>Kafka Connect &amp; UI</h3><p>docker pull confluentinc/cp-zookeeper<br>docker pull confluentinc/cp-kafka</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run --name eventbus_kafka -d \</span><br><span class="line">   -p 9092:9092 \</span><br><span class="line">   -e KAFKA_LISTENERS&#x3D;PLAINTEXT:&#x2F;&#x2F;0.0.0.0:9092 \</span><br><span class="line">   -e KAFKA_ADVERTISED_LISTENERS&#x3D;PLAINTEXT:&#x2F;&#x2F;dev:9092 \</span><br><span class="line">   -e KAFKA_ZOOKEEPER_CONNECT&#x3D;dev:2181 \</span><br><span class="line">   -e KAFKA_AUTO_CREATE_TOPICS_ENABLE&#x3D;true \</span><br><span class="line">   -e KAFKA_DELETE_TOPIC_ENABLE&#x3D;true \</span><br><span class="line">   -e KAFKA_BROKER_ID&#x3D;0 \</span><br><span class="line">   -v &#x2F;var&#x2F;run&#x2F;docker.sock:&#x2F;var&#x2F;run&#x2F;docker.sock \</span><br><span class="line">   wurstmeister&#x2F;kafka:2.11-1.1.1</span><br></pre></td></tr></table></figure>




<p>docker pull confluentinc/cp-schema-registry</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run --name schema-registry -h schema-registry -p 8081:8081 \</span><br><span class="line">   -e SCHEMA_REGISTRY_HOST_NAME&#x3D;schema-registry \</span><br><span class="line">   -e SCHEMA_REGISTRY_KAFKASTORE_CONNECTION_URL&#x3D;dev:2181 \</span><br><span class="line">   confluentinc&#x2F;cp-schema-registry:5.5.0 </span><br></pre></td></tr></table></figure>




<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker run --name schema-registry -h schema-registry -p 8081:8081 \</span><br><span class="line">   -e SCHEMA_REGISTRY_HOST_NAME&#x3D;schema-registry \</span><br><span class="line">   -e SCHEMA_REGISTRY_KAFKASTORE_CONNECTION_URL&#x3D;dev:2181 \</span><br><span class="line">   confluentinc&#x2F;cp-schema-registry:5.5.0 </span><br><span class="line"></span><br><span class="line">docker run --name eventbus_kafka -d \</span><br><span class="line">   -p 9092:9092 \</span><br><span class="line">   -e KAFKA_LISTENERS&#x3D;PLAINTEXT:&#x2F;&#x2F;0.0.0.0:9092 \</span><br><span class="line">   -e KAFKA_ADVERTISED_LISTENERS&#x3D;PLAINTEXT:&#x2F;&#x2F;dev:9092 \</span><br><span class="line">   -e KAFKA_ZOOKEEPER_CONNECT&#x3D;dev:2181 \</span><br><span class="line">   -e KAFKA_AUTO_CREATE_TOPICS_ENABLE&#x3D;true \</span><br><span class="line">   -e KAFKA_DELETE_TOPIC_ENABLE&#x3D;true \</span><br><span class="line">   -e KAFKA_BROKER_ID&#x3D;0 \</span><br><span class="line">   -v &#x2F;var&#x2F;run&#x2F;docker.sock:&#x2F;var&#x2F;run&#x2F;docker.sock \</span><br><span class="line">   wurstmeister&#x2F;kafka:2.11-1.1.1</span><br></pre></td></tr></table></figure>




<p>docker pull confluentinc/cp-kafka-connect</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name&#x3D;kafka-connect-avro \</span><br><span class="line">  -e CONNECT_BOOTSTRAP_SERVERS&#x3D;dev:9092 \</span><br><span class="line">  -e CONNECT_REST_PORT&#x3D;8083 \</span><br><span class="line">  -e CONNECT_GROUP_ID&#x3D;&quot;quickstart-avro&quot; \</span><br><span class="line">  -e CONNECT_CONFIG_STORAGE_TOPIC&#x3D;&quot;quickstart-avro-config&quot; \</span><br><span class="line">  -e CONNECT_OFFSET_STORAGE_TOPIC&#x3D;&quot;quickstart-avro-offsets&quot; \</span><br><span class="line">  -e CONNECT_STATUS_STORAGE_TOPIC&#x3D;&quot;quickstart-avro-status&quot; \</span><br><span class="line">  -e CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR&#x3D;1 \</span><br><span class="line">  -e CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR&#x3D;1 \</span><br><span class="line">  -e CONNECT_STATUS_STORAGE_REPLICATION_FACTOR&#x3D;1 \</span><br><span class="line">  -e CONNECT_KEY_CONVERTER&#x3D;&quot;io.confluent.connect.avro.AvroConverter&quot; \</span><br><span class="line">  -e CONNECT_VALUE_CONVERTER&#x3D;&quot;io.confluent.connect.avro.AvroConverter&quot; \</span><br><span class="line">  -e CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_URL&#x3D;&quot;http:&#x2F;&#x2F;dev:8081&quot; \</span><br><span class="line">  -e CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL&#x3D;&quot;http:&#x2F;&#x2F;dev:8081&quot; \</span><br><span class="line">  -e CONNECT_INTERNAL_KEY_CONVERTER&#x3D;&quot;org.apache.kafka.connect.json.JsonConverter&quot; \</span><br><span class="line">  -e CONNECT_INTERNAL_VALUE_CONVERTER&#x3D;&quot;org.apache.kafka.connect.json.JsonConverter&quot; \</span><br><span class="line">  -e CONNECT_REST_ADVERTISED_HOST_NAME&#x3D;&quot;dev&quot; \</span><br><span class="line">  -e CONNECT_LOG4J_ROOT_LOGLEVEL&#x3D;INFO \</span><br><span class="line">  -e CONNECT_PLUGIN_PATH&#x3D;&#x2F;usr&#x2F;share&#x2F;java,&#x2F;etc&#x2F;kafka-connect&#x2F;jars \</span><br><span class="line">  -v &#x2F;Users&#x2F;shankai&#x2F;codebase&#x2F;oss&#x2F;fork&#x2F;jars&#x2F;:&#x2F;etc&#x2F;kafka-connect&#x2F;jars&#x2F; \</span><br><span class="line">  -p 8083:8083 \</span><br><span class="line">  confluentinc&#x2F;cp-kafka-connect:latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -d \</span><br><span class="line">  --name&#x3D;kc-redis-avro \</span><br><span class="line">  -e CONNECT_BOOTSTRAP_SERVERS&#x3D;dev:9092 \</span><br><span class="line">  -e CONNECT_REST_PORT&#x3D;8083 \</span><br><span class="line">  -e CONNECT_GROUP_ID&#x3D;&quot;quickstart-avro&quot; \</span><br><span class="line">  -e CONNECT_CONFIG_STORAGE_TOPIC&#x3D;&quot;quickstart-avro-config&quot; \</span><br><span class="line">  -e CONNECT_OFFSET_STORAGE_TOPIC&#x3D;&quot;quickstart-avro-offsets&quot; \</span><br><span class="line">  -e CONNECT_STATUS_STORAGE_TOPIC&#x3D;&quot;quickstart-avro-status&quot; \</span><br><span class="line">  -e CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR&#x3D;1 \</span><br><span class="line">  -e CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR&#x3D;1 \</span><br><span class="line">  -e CONNECT_STATUS_STORAGE_REPLICATION_FACTOR&#x3D;1 \</span><br><span class="line">  -e CONNECT_KEY_CONVERTER&#x3D;&quot;io.confluent.connect.avro.AvroConverter&quot; \</span><br><span class="line">  -e CONNECT_VALUE_CONVERTER&#x3D;&quot;io.confluent.connect.avro.AvroConverter&quot; \</span><br><span class="line">  -e CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_URL&#x3D;&quot;http:&#x2F;&#x2F;dev:8081&quot; \</span><br><span class="line">  -e CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL&#x3D;&quot;http:&#x2F;&#x2F;dev:8081&quot; \</span><br><span class="line">  -e CONNECT_INTERNAL_KEY_CONVERTER&#x3D;&quot;org.apache.kafka.connect.json.JsonConverter&quot; \</span><br><span class="line">  -e CONNECT_INTERNAL_VALUE_CONVERTER&#x3D;&quot;org.apache.kafka.connect.json.JsonConverter&quot; \</span><br><span class="line">  -e CONNECT_REST_ADVERTISED_HOST_NAME&#x3D;&quot;dev&quot; \</span><br><span class="line">  -e CONNECT_LOG4J_ROOT_LOGLEVEL&#x3D;INFO \</span><br><span class="line">  -e CONNECT_PLUGIN_PATH&#x3D;&#x2F;usr&#x2F;share&#x2F;java,&#x2F;etc&#x2F;kafka-connect&#x2F;jars \</span><br><span class="line">  -p 8083:8083 \</span><br><span class="line">kc-redis:latest</span><br></pre></td></tr></table></figure>
<p>docker pull landoop/kafka-connect-ui</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;lensesio&#x2F;kafka-connect-ui</span><br><span class="line"></span><br><span class="line">docker run -d --name kafka-connect-ui -it -p 8000:8000 -e &quot;CONNECT_URL&#x3D;http:&#x2F;&#x2F;dev:8083&quot; landoop&#x2F;kafka-connect-ui</span><br></pre></td></tr></table></figure>


<h2 id="Connector"><a href="#Connector" class="headerlink" title="Connector"></a>Connector</h2><h3 id="connector-configuration-override"><a href="#connector-configuration-override" class="headerlink" title="connector configuration override"></a>connector configuration override</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">value.converter.schema.registry.url&#x3D;http:&#x2F;&#x2F;dev:8081</span><br><span class="line">value.converter&#x3D;io.confluent.connect.protobuf.ProtobufConverter</span><br></pre></td></tr></table></figure>


<p>worker.properties: <code>connector.client.config.override.policy=All</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;consumer.override.max.poll.records&quot;: &quot;1&quot;,</span><br><span class="line">&quot;consumer.override.fetch.max.wait.ms&quot;: &quot;0&quot;</span><br></pre></td></tr></table></figure>


<p>LOG_DIR=/app</p>
<h3 id="Properties"><a href="#Properties" class="headerlink" title="Properties"></a>Properties</h3><h4 id="RedisSinkConnector-PubSub"><a href="#RedisSinkConnector-PubSub" class="headerlink" title="RedisSinkConnector PubSub"></a>RedisSinkConnector PubSub</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">connector.class&#x3D;com.datamountaineer.streamreactor.connect.redis.sink.RedisSinkConnector</span><br><span class="line">connect.redis.port&#x3D;6379</span><br><span class="line">connect.redis.kcql&#x3D;select * from sea_vessel_position_reports STOREAS PubSub(channel&#x3D;Timestamp)</span><br><span class="line">topics&#x3D;sea_vessel_position_reports</span><br><span class="line">tasks.max&#x3D;1</span><br><span class="line">connect.redis.host&#x3D;dev</span><br><span class="line">name&#x3D;quickstart-redis-pub</span><br></pre></td></tr></table></figure>
<h4 id="RedisSinkConnector-Cache"><a href="#RedisSinkConnector-Cache" class="headerlink" title="RedisSinkConnector Cache"></a>RedisSinkConnector Cache</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">connector.class&#x3D;com.datamountaineer.streamreactor.connect.redis.sink.RedisSinkConnector</span><br><span class="line">connect.redis.port&#x3D;6379</span><br><span class="line">connect.redis.kcql&#x3D;INSERT INTO PK- select * from sea_vessel_position_reports PK Timestamp</span><br><span class="line">topics&#x3D;sea_vessel_position_reports</span><br><span class="line">tasks.max&#x3D;1</span><br><span class="line">connect.redis.host&#x3D;dev</span><br><span class="line">name&#x3D;quickstart-redis-cache</span><br></pre></td></tr></table></figure>


<h3 id="Rest"><a href="#Rest" class="headerlink" title="Rest"></a>Rest</h3><h4 id="Redis-Cache"><a href="#Redis-Cache" class="headerlink" title="Redis Cache"></a>Redis Cache</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST &#x27;http://dev:8083/connectors&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">    &quot;name&quot;: &quot;RedisSinkConnectorCache&quot;,</span><br><span class="line">    &quot;config&quot;: &#123;</span><br><span class="line">        &quot;connector.class&quot;: &quot;com.datamountaineer.streamreactor.connect.redis.sink.RedisSinkConnector&quot;,</span><br><span class="line">        &quot;connect.redis.port&quot;: &quot;6379&quot;,</span><br><span class="line">        &quot;connect.redis.kcql&quot;: &quot;INSERT INTO FX- select location from sea_vessel_position_reports PK Timestamp&quot;,</span><br><span class="line">        &quot;topics&quot;: &quot;sea_vessel_position_reports&quot;,</span><br><span class="line">        &quot;tasks.max&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;connect.redis.host&quot;: &quot;dev&quot;,</span><br><span class="line">        &quot;name&quot;: &quot;RedisSinkConnectorCache&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h4 id="Redis-PubSub"><a href="#Redis-PubSub" class="headerlink" title="Redis PubSub"></a>Redis PubSub</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST &#x27;http://dev:8083/connectors&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">    &quot;name&quot;: &quot;RedisSinkConnectorPubSub&quot;,</span><br><span class="line">    &quot;config&quot;: &#123;</span><br><span class="line">        &quot;connector.class&quot;: &quot;com.datamountaineer.streamreactor.connect.redis.sink.RedisSinkConnector&quot;,</span><br><span class="line">        &quot;connect.redis.port&quot;: &quot;6379&quot;,</span><br><span class="line">        &quot;connect.redis.kcql&quot;: &quot;select * from sea_vessel_position_reports STOREAS PubSub(channel=Timestamp)&quot;,</span><br><span class="line">        &quot;topics&quot;: &quot;sea_vessel_position_reports&quot;,</span><br><span class="line">        &quot;tasks.max&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;connect.redis.host&quot;: &quot;dev&quot;,</span><br><span class="line">        &quot;name&quot;: &quot;RedisSinkConnectorPubSub&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="Redis-Benchmark"><a href="#Redis-Benchmark" class="headerlink" title="Redis Benchmark"></a>Redis Benchmark</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-benchmark -h redis-ps-redis-perf-paas.paas -c 1 -d 1024  script load &quot;redis.call(&#39;publish&#39;, &#39;abc&#39;)&quot; </span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="shankai"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">shankai</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">117</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/shankai" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;shankai" rel="noopener" target="_blank"><i class="fa fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:shankai.kvn@gmail.com" title="E-Mail → mailto:shankai.kvn@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">shankai</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">156k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">2:22</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'neutral',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

</body>
</html>
